<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统一错误处理系统演示</title>
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .demo-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .demo-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn.danger {
            background: #dc3545;
        }
        
        .btn.danger:hover {
            background: #c82333;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.success:hover {
            background: #1e7e34;
        }
        
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn.warning:hover {
            background: #e0a800;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .demo-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>统一错误处理系统演示</h1>
    <p>这个页面演示了新的统一错误处理系统的各种功能，包括错误提示、网络重试、数据验证等。</p>
    
    <!-- 基本错误提示演示 -->
    <div class="demo-section">
        <h3>1. 基本错误提示</h3>
        <p>演示不同类型的错误提示消息：</p>
        <button class="btn danger" onclick="showErrorDemo()">显示错误提示</button>
        <button class="btn success" onclick="showSuccessDemo()">显示成功提示</button>
        <button class="btn warning" onclick="showWarningDemo()">显示警告提示</button>
        <button class="btn" onclick="showInfoDemo()">显示信息提示</button>
    </div>
    
    <!-- 网络请求错误演示 -->
    <div class="demo-section">
        <h3>2. 网络请求错误处理</h3>
        <p>演示网络请求失败时的自动重试机制：</p>
        <button class="btn" onclick="testNetworkError()">测试网络错误</button>
        <button class="btn" onclick="testServerError()">测试服务器错误</button>
        <button class="btn" onclick="testValidationError()">测试验证错误</button>
        <button class="btn" onclick="testAuthError()">测试认证错误</button>
    </div>
    
    <!-- 表单验证演示 -->
    <div class="demo-section">
        <h3>3. 表单验证演示</h3>
        <p>演示表单数据验证和错误提示：</p>
        
        <div class="demo-form">
            <div class="form-group">
                <label for="demo-name">姓名：</label>
                <input type="text" id="demo-name" placeholder="请输入姓名">
            </div>
            
            <div class="form-group">
                <label for="demo-grade">年级：</label>
                <select id="demo-grade">
                    <option value="">请选择年级</option>
                    <option value="一年级">一年级</option>
                    <option value="二年级">二年级</option>
                    <option value="三年级">三年级</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="demo-date">填表日期：</label>
                <input type="date" id="demo-date">
            </div>
            
            <button class="btn" onclick="validateForm()">验证表单</button>
            <button class="btn success" onclick="submitDemoForm()">提交表单</button>
        </div>
    </div>
    
    <!-- 问卷提交演示 -->
    <div class="demo-section">
        <h3>4. 问卷提交演示</h3>
        <p>演示完整的问卷数据提交流程：</p>
        <button class="btn success" onclick="submitDemoQuestionnaire()">提交演示问卷</button>
        <button class="btn" onclick="submitInvalidQuestionnaire()">提交无效问卷</button>
    </div>
    
    <!-- 加载错误处理脚本 -->
    <script>
    // 动态加载JS文件
    const errorHandlerScript = document.createElement('script');
    errorHandlerScript.src = CONFIG.BASE_URL + '/backend/static/js/error-handler.js';
    document.head.appendChild(errorHandlerScript);
    
    const helperScript = document.createElement('script');
    helperScript.src = CONFIG.BASE_URL + '/backend/static/js/questionnaire-helper.js';
    document.head.appendChild(helperScript);
    </script>
    
    <script>
        // 基本错误提示演示
        function showErrorDemo() {
            errorHandler.showError('操作失败', '这是一个错误提示的演示', 'error', {
                details: ['详细错误信息1', '详细错误信息2', '详细错误信息3'],
                retry: () => {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            errorHandler.showSuccess('重试成功！');
                            resolve();
                        }, 2000);
                    });
                }
            });
        }
        
        function showSuccessDemo() {
            errorHandler.showSuccess('操作成功！', {
                details: '这是成功提示的详细信息'
            });
        }
        
        function showWarningDemo() {
            errorHandler.showWarning('注意事项', {
                details: '这是一个警告提示，请注意相关事项'
            });
        }
        
        function showInfoDemo() {
            errorHandler.showInfo('提示信息', {
                details: '这是一个普通的信息提示'
            });
        }
        
        // 网络请求错误演示
        async function testNetworkError() {
            try {
                const response = await errorHandler.get('http://nonexistent-server.com/api/test');
            } catch (error) {
                console.log('网络错误已被处理');
            }
        }
        
        async function testServerError() {
            try {
                // 模拟服务器错误
                const response = await fetch('http://localhost:5000/api/nonexistent-endpoint');
                if (!response.ok) {
                    await errorHandler.handleApiError(response);
                }
            } catch (error) {
                errorHandler.showError('网络连接失败', '无法连接到服务器', 'error');
            }
        }
        
        async function testValidationError() {
            try {
                const response = await errorHandler.post('http://localhost:5000/api/questionnaires', {
                    // 故意提交无效数据
                    invalid: 'data'
                });
            } catch (error) {
                console.log('验证错误已被处理');
            }
        }
        
        async function testAuthError() {
            try {
                const response = await errorHandler.get('http://localhost:5000/api/admin/statistics');
            } catch (error) {
                console.log('认证错误已被处理');
            }
        }
        
        // 表单验证演示
        function validateForm() {
            const name = document.getElementById('demo-name').value;
            const grade = document.getElementById('demo-grade').value;
            const date = document.getElementById('demo-date').value;
            
            const basicInfo = { name, grade, submission_date: date };
            const errors = questionnaireHelper.validateBasicInfo(basicInfo);
            
            if (errors.length > 0) {
                errorHandler.showError('表单验证失败', '请检查以下信息：', 'error', {
                    details: errors
                });
            } else {
                errorHandler.showSuccess('表单验证通过！');
            }
        }
        
        async function submitDemoForm() {
            const name = document.getElementById('demo-name').value;
            const grade = document.getElementById('demo-grade').value;
            const date = document.getElementById('demo-date').value;
            
            const formData = {
                type: 'demo_form',
                basic_info: {
                    name: name,
                    grade: grade,
                    submission_date: date
                },
                questions: [
                    {
                        id: 1,
                        type: 'text_input',
                        question: '这是一个演示问题',
                        answer: '这是演示答案'
                    }
                ]
            };
            
            const result = await questionnaireHelper.submitQuestionnaire(formData, {
                showLoading: true,
                onSuccess: (result) => {
                    questionnaireHelper.showSuccessPage(result.id);
                }
            });
        }
        
        // 问卷提交演示
        async function submitDemoQuestionnaire() {
            const demoData = {
                type: 'demo_questionnaire',
                basic_info: {
                    name: '张三',
                    grade: '三年级',
                    submission_date: new Date().toISOString().split('T')[0]
                },
                questions: [
                    {
                        id: 1,
                        type: 'multiple_choice',
                        question: '你喜欢什么颜色？',
                        options: [
                            { value: 0, text: '红色' },
                            { value: 1, text: '蓝色' },
                            { value: 2, text: '绿色' }
                        ],
                        selected: [1]
                    },
                    {
                        id: 2,
                        type: 'text_input',
                        question: '请描述你的兴趣爱好',
                        answer: '我喜欢阅读和运动'
                    }
                ],
                statistics: {
                    total_score: 100,
                    completion_rate: 100,
                    submission_time: new Date().toISOString()
                }
            };
            
            const result = await questionnaireHelper.submitQuestionnaire(demoData, {
                showLoading: true,
                onSuccess: (result) => {
                    questionnaireHelper.showSuccessPage(result.id);
                }
            });
        }
        
        async function submitInvalidQuestionnaire() {
            const invalidData = {
                type: 'invalid_questionnaire',
                basic_info: {
                    name: '', // 空姓名
                    grade: '', // 空年级
                    submission_date: ''
                },
                questions: [] // 空问题列表
            };
            
            const result = await questionnaireHelper.submitQuestionnaire(invalidData, {
                showLoading: true
            });
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期
            document.getElementById('demo-date').value = new Date().toISOString().split('T')[0];
            
            // 显示欢迎信息
            setTimeout(() => {
                errorHandler.showInfo('欢迎使用统一错误处理系统', {
                    details: '请点击各个按钮测试不同的功能'
                });
            }, 1000);
        });
    </script>
</body>
</html>