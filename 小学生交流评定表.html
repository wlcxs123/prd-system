<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小学生交流评定量表</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>

    <style>
        /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            /* 标准语法 */
        }

        body {
            font-family: 'Nunito', sans-serif;
            line-height: 1.6;
            color: #374151;
            /* 深灰色文本 */
            background-color: #F9FAFB;
            padding: 20px;
        }

        /* 容器样式 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
            overflow: hidden;
            padding: 30px;
            animation: fadeIn 0.8s ease-in-out;
        }

        /* 标题样式 */
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #6D28D9;
            /* 深紫色 */
            font-size: 2.5rem;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 2px solid #EDE9FE;
            /* 浅紫色 */
        }

        /* 描述文本样式 */
        .scale-description {
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 15px;
            background-color: #EDE9FE;
            border-radius: 10px;
            color: #6D28D9;
        }

        /* 信息填写区域 */
        .info-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
        }

        .info-item {
            flex: 1;
            min-width: 250px;
            position: relative;
            /* 为图标定位 */
        }

        .info-item .icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(+50%);
            color: #9CA3AF;
            transition: color 0.3s ease;
        }

        .info-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4B5563;
        }

        .info-item input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            /* 为图标留出空间 */
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .info-item input:focus {
            outline: none;
            border-color: #8B5CF6;
            /* 中紫色 */
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .info-item input:focus+.icon {
            color: #8B5CF6;
        }

        /* 说明文字 */
        .instructions {
            margin: 25px 0;
            padding: 15px;
            background-color: #F3F4F6;
            border-radius: 10px;
            font-size: 1rem;
        }

        .instructions p {
            margin-bottom: 10px;
        }

        .instructions p:last-child {
            margin-bottom: 0;
        }

        /* 表格样式 */
        .assessment-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 30px;

        }

        .assessment-table th,
        .assessment-table td {
            padding: 15px 10px;
            text-align: center;
            border-bottom: 1px solid #E5E7EB;
            position: relative;
            vertical-align: middle;
        }

        .assessment-table th {
            background: linear-gradient(135deg, #8B5CF6, #6D28D9);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .assessment-table tr:last-child td {
            border-bottom: none;
        }

        .assessment-table tbody tr:hover {
            background-color: #F9FAFB;
        }

        /* 修复 sticky header 的圆角问题 */
        .table-wrapper {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .question-number {
            font-weight: 700;
            color: #6D28D9;
            width: 60px;
        }

        .question-description {
            text-align: left;
            padding-left: 20px;
            width: 40%;
        }

        /* 完成页面样式 */
        .completion-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .completion-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            margin: 20px;
        }

        .completion-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .completion-header h1 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .completion-subtitle {
            color: #6c757d;
            font-size: 1.2em;
            margin: 0;
        }

        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-grid div {
            font-size: 1.1em;
            color: #495057;
        }

        .summary-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-item {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
        }

        .answers-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .answer-item {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .question-header {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .q-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .q-text {
            font-weight: 600;
            color: #495057;
            line-height: 1.4;
            font-size: 1.1em;
        }

        .answer-details {
            margin-left: 45px;
        }

        .score-info,
        .speech-info {
            margin-bottom: 10px;
            font-size: 1em;
        }

        .selected-score {
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .speech-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .can-speak {
            background: #d4edda;
            color: #155724;
        }

        .cannot-speak {
            background: #f8d7da;
            color: #721c24;
        }

        .all-options ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .all-options li {
            margin: 5px 0;
            font-size: 0.9em;
            color: #6c757d;
        }

        .all-options li.selected {
            color: #28a745;
            font-weight: 600;
            list-style-type: "✓ ";
        }

        .completion-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .btn-primary,
        .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        /* 表单元素样式 */
        .checkbox-cell,
        .radio-cell {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .checkbox-cell:hover,
        .radio-cell:hover {
            background-color: rgba(139, 92, 246, 0.05);
        }

        input[type="checkbox"],
        input[type="radio"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #8B5CF6;
            transition: all 0.3s ease;
        }

        input[type="checkbox"]:checked,
        input[type="radio"]:checked {
            transform: scale(1.1);
        }

        input:focus {
            outline: none;
        }

        /* 提交按钮 */
        .submit-section {
            text-align: center;
            margin: 30px 0 15px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #8B5CF6, #6D28D9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.2);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(139, 92, 246, 0.3);
        }

        .submit-btn:active {
            transform: translateY(1px);
        }

        /* 结果区域 */
        .result-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 15px;
            background-color: #EDE9FE;
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .result-section h2 {
            color: #6D28D9;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .result-item {
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .result-score {
            font-weight: 700;
            color: #6D28D9;
        }

        /* --- 新增：防止点击按钮和非交互区域时出现文本光标 --- */
        .submit-btn,
        .question-number,
        .question-description,
        .assessment-table th {
            user-select: none;
            /* 标准语法 */
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE/Edge */
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .assessment-table th,
            .assessment-table td {
                padding: 12px 8px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8rem;
                margin-bottom: 20px;
            }

            .scale-description {
                font-size: 1rem;
                padding: 12px;
            }

            .assessment-table {
                font-size: 0.85rem;
            }

            .question-description {
                width: auto;
                max-width: none;
            }

            .table-wrapper {
                overflow-x: auto;
            }
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>小学生交流评定量表</h1>

        <div class="scale-description">
            0=非常容易(没有焦虑); 1=相当容易(有点焦虑); 2=有点困难(有不少焦虑); 3=困难(更加焦虑); 4=非常困难(高度焦虑)
        </div>

        <div class="info-section">
            <div class="info-item">
                <label for="name">姓名:</label>
                <input type="text" id="name" name="name" placeholder="请输入姓名">
                <i class="fas fa-user icon"></i>
            </div>

            <div class="info-item">
                <label for="grade">年级:</label>
                <input type="text" id="grade" name="grade" placeholder="请输入年级">
                <i class="fas fa-graduation-cap icon"></i>
            </div>

            <div class="info-item">
                <label for="date">填表日期:</label>
                <input type="date" id="date" name="date">
                <i class="fas fa-calendar-alt icon"></i>
            </div>
        </div>

        <div class="instructions">
            <p>以下情况对你来说有多容易或有多困难?请根据评定圈出0~4之间的数字。</p>
            <p>如果在这些情况下你可以说话, 请在方框中打钩(√)</p>
        </div>

        <div class="table-wrapper">
            <table class="assessment-table">
                <thead>
                    <tr>
                        <th>序号</th>
                        <th>情况描述</th>
                        <th>可以说话</th>
                        <th>0=非常容易</th>
                        <th>1=相当容易</th>
                        <th>2=有点困难</th>
                        <th>3=困难</th>
                        <th>4=非常困难</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="question-row">
                        <td class="question-number">1</td>
                        <td class="question-description">在家里和亲密的家人交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q1-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q1" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q1" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q1" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q1" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q1" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">2</td>
                        <td class="question-description">在商店或餐厅与你的亲密家人交谈,其他人可能会听到</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q2-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q2" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q2" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q2" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q2" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q2" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">3</td>
                        <td class="question-description">在家里和其他亲戚说话</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q3-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q3" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q3" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q3" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q3" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q3" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">4</td>
                        <td class="question-description">和陌生人说话</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q4-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q4" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q4" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q4" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q4" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q4" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">5</td>
                        <td class="question-description">独自和班主任交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q5-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q5" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q5" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q5" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q5" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q5" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">6</td>
                        <td class="question-description">在班上其他孩子面前和班主任交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q6-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q6" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q6" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q6" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q6" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q6" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">7</td>
                        <td class="question-description">在学校与其他老师或成年人交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q7-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q7" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q7" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q7" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q7" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q7" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">8</td>
                        <td class="question-description">在课堂上举手提问</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q8-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q8" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q8" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q8" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q8" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q8" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">9</td>
                        <td class="question-description">参加课堂讨论(提出自己的意见或想法)</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q9-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q9" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q9" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q9" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q9" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q9" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">10</td>
                        <td class="question-description">回答出勤点名</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q10-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q10" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q10" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q10" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q10" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q10" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">11</td>
                        <td class="question-description">加入课堂围坐时间的活动</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q11-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q11" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q11" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q11" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q11" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q11" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">12</td>
                        <td class="question-description">询问是否可以上厕所</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q12-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q12" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q12" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q12" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q12" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q12" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">13</td>
                        <td class="question-description">在不确定该怎么做时寻求帮助</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q13-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q13" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q13" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q13" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q13" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q13" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">14</td>
                        <td class="question-description">独自给班主任朗读</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q14-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q14" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q14" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q14" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q14" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q14" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">15</td>
                        <td class="question-description">在课堂前大声朗读</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q15-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q15" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q15" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q15" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q15" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q15" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">16</td>
                        <td class="question-description">接近其他孩子,与他们说话和交朋友</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q16-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q16" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q16" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q16" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q16" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q16" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">17</td>
                        <td class="question-description">如果其他孩子和你说话,你会回答他们</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q17-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q17" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q17" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q17" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q17" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q17" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">18</td>
                        <td class="question-description">告诉其他孩子,他们让你感到很烦</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q18-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q18" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q18" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q18" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q18" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q18" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">19</td>
                        <td class="question-description">告诉成年人你认为他们犯了一个错误</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q19-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q19" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q19" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q19" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q19" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q19" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">20</td>
                        <td class="question-description">当你可能遇到麻烦时,与成年人交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q20-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q20" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q20" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q20" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q20" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q20" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">21</td>
                        <td class="question-description">在学校告诉成年人你感到不舒服</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q21-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q21" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q21" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q21" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q21" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q21" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">22</td>
                        <td class="question-description">在学校告诉成年人,有人让你不高兴</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q22-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q22" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q22" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q22" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q22" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q22" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">23</td>
                        <td class="question-description">第一次独自与新老师交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q23-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q23" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q23" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q23" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q23" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q23" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">24</td>
                        <td class="question-description">在班上其他孩子面前第一次和老师交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q24-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q24" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q24" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q24" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q24" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q24" value="4"></td>
                    </tr>
                    <tr class="question-row">
                        <td class="question-number">25</td>
                        <td class="question-description">第一次在学校和一个新男生或新女生交谈</td>
                        <td class="checkbox-cell"><input type="checkbox" name="q25-speech"></td>
                        <td class="radio-cell"><input type="radio" name="q25" value="0"></td>
                        <td class="radio-cell"><input type="radio" name="q25" value="1"></td>
                        <td class="radio-cell"><input type="radio" name="q25" value="2"></td>
                        <td class="radio-cell"><input type="radio" name="q25" value="3"></td>
                        <td class="radio-cell"><input type="radio" name="q25" value="4"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="submit-section">
            <button class="submit-btn" id="calculateBtn">
                <i class="fas fa-calculator"></i> 计算结果
            </button>
            <button class="submit-btn" id="saveResultBtn" style="margin-left: 15px;">
                <i class="fas fa-save"></i> 保存结果
            </button>
            <button class="submit-btn" id="testConnectionBtn"
                style="margin-left: 15px; background: linear-gradient(135deg, #10B981, #059669);">
                <i class="fas fa-wifi"></i> 测试连接
            </button>
            <button class="submit-btn" id="debugBtn"
                style="margin-left: 15px; background: linear-gradient(135deg, #F59E0B, #D97706);">
                <i class="fas fa-bug"></i> 调试数据
            </button>
            <button class="submit-btn" id="testDataBtn"
                style="margin-left: 15px; background: linear-gradient(135deg, #8B5A2B, #6B4423);">
                <i class="fas fa-vial"></i> 测试收集
            </button>
        </div>

        <div class="result-section" id="resultSection">
            <h2>评定结果</h2>
            <div class="result-item">
                <strong>总得分:</strong> <span class="result-score" id="totalScore">0</span>
            </div>
            <div class="result-item">
                <strong>平均得分:</strong> <span class="result-score" id="averageScore">0</span>
            </div>
            <div class="result-item">
                <strong>可说话情况:</strong> <span class="result-score" id="speechCount">0/25</span>
            </div>
            <div class="result-item" id="assessmentText">
                <strong>评定:</strong> <span>请完成所有问题后计算结果</span>
            </div>
        </div>

        <p style="text-align: center; margin-top: 20px; color: #6B7280;">谢谢!</p>
    </div>

    <script>
        // 防止重复提交的标志和时间戳
        let isSubmitting = false;
        let lastSubmitTime = 0;
        const SUBMIT_COOLDOWN = 3000; // 3秒冷却时间

        document.addEventListener('DOMContentLoaded', function () {

            // --- 功能增强：自动设置当天日期 ---
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;

            // 读取localStorage中保存的基本信息
            const savedInfo = localStorage.getItem('basicInfo');
            if (savedInfo) {
                try {
                    const info = JSON.parse(savedInfo);
                    // 填充姓名字段
                    if (info.name) {
                        const nameField = document.getElementById('name');
                        if (nameField) nameField.value = info.name;
                    }
                } catch (e) {
                    console.warn('解析保存的基本信息失败:', e);
                }
            }

            // --- 优化：为单元格添加更智能的点击事件 ---
            const tableBody = document.querySelector('.assessment-table tbody');
            tableBody.addEventListener('click', function (e) {
                const cell = e.target.closest('.checkbox-cell, .radio-cell');
                if (!cell) return;

                const input = cell.querySelector('input');
                if (input) {
                    // 确保事件不是从input本身触发的，避免双重触发
                    if (e.target !== input) {
                        if (input.type === 'checkbox') {
                            input.checked = !input.checked;
                        }
                        if (input.type === 'radio') {
                            input.checked = true;
                        }
                    }
                }
            });

            // --- 优化：为表格行动画添加更流畅的延迟效果 ---
            const rows = document.querySelectorAll('.assessment-table tbody tr');
            rows.forEach((row, index) => {
                row.style.opacity = '0';
                row.style.animation = `fadeIn 0.5s ease-in-out forwards ${index * 0.05}s`;
            });

            // 绑定计算结果按钮事件
            document.getElementById('calculateBtn').addEventListener('click', calculateResult);

            // 绑定保存结果按钮事件 - 添加防重复提交
            document.getElementById('saveResultBtn').addEventListener('click', function() {
                if (isSubmitting) {
                    console.log('正在提交中，请勿重复点击');
                    return;
                }
                saveResult();
            });

            // 绑定测试连接按钮事件
            document.getElementById('testConnectionBtn').addEventListener('click', testConnection);

            // 绑定调试按钮事件
            document.getElementById('debugBtn').addEventListener('click', function () {
                const data = debugDataStructure();
                if (data) {
                    alert(`调试信息已输出到控制台\n\n数据项数: ${data.length}\n请按F12查看详细信息`);
                } else {
                    alert('数据调试失败，请检查控制台错误信息');
                }
            });

            // 绑定测试收集按钮事件
            document.getElementById('testDataBtn').addEventListener('click', function () {
                const count = testDataCollection();
                alert(`数据收集测试完成\n\n找到 ${count} 个问题\n详细信息请查看控制台`);
            });
        });

        /**
         * 计算并显示评估结果
         */
        function calculateResult() {
            const questionRows = document.querySelectorAll('.assessment-table .question-row');
            const totalQuestions = questionRows.length;

            let totalScore = 0;
            let answeredQuestions = 0;
            let speechCount = 0;

            // --- 优化：动态遍历所有问题行 ---
            questionRows.forEach(row => {
                const radios = row.querySelectorAll('input[type="radio"]');
                const speechCheckbox = row.querySelector('input[type="checkbox"]');

                let selectedValue = null;
                for (const radio of radios) {
                    if (radio.checked) {
                        selectedValue = parseInt(radio.value, 10);
                        break;
                    }
                }

                if (speechCheckbox && speechCheckbox.checked) {
                    speechCount++;
                }

                if (selectedValue !== null) {
                    totalScore += selectedValue;
                    answeredQuestions++;
                }
            });

            // --- 功能增强：检查是否所有问题都已回答 ---
            if (answeredQuestions < totalQuestions) {
                alert(`请完成所有 ${totalQuestions} 道题目后再计算结果。\n您当前完成了 ${answeredQuestions} 道。`);
                return;
            }

            // 显示结果区域
            const resultSection = document.getElementById('resultSection');
            const averageScore = (totalScore / totalQuestions).toFixed(1);

            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('averageScore').textContent = averageScore;
            document.getElementById('speechCount').textContent = `${speechCount}/${totalQuestions}`;

            // 根据平均分给出评定
            let assessmentText = '';
            if (averageScore <= 1) {
                assessmentText = '交流能力良好，焦虑程度低';
            } else if (averageScore <= 2) {
                assessmentText = '交流能力中等，有轻微焦虑';
            } else if (averageScore <= 3) {
                assessmentText = '交流存在一定困难，焦虑程度较高';
            } else {
                assessmentText = '交流困难较大，焦虑程度高，建议进一步关注';
            }
            document.querySelector('#assessmentText span').textContent = assessmentText;

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * 测试网络连接（用户手动触发）
         */
        async function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
            btn.disabled = true;

            try {
                console.log('用户手动测试网络连接...');
                const diagnostics = await diagnoseConnection();

                let message = '🔍 网络连接诊断结果：\n\n';
                message += `服务器可达性: ${diagnostics.serverReachable ? '✅ 正常' : '❌ 失败'}\n`;
                message += `CORS配置: ${diagnostics.corsEnabled ? '✅ 正常' : '❌ 失败'}\n`;
                message += `API端点: ${diagnostics.apiEndpoint ? '✅ 正常' : '❌ 失败'}\n\n`;

                if (diagnostics.serverReachable && diagnostics.corsEnabled && diagnostics.apiEndpoint) {
                    message += '🎉 网络连接正常，可以保存数据！';
                } else {
                    message += '⚠️ 发现问题，请检查：\n';
                    if (!diagnostics.serverReachable) {
                        message += '• 确保后端服务正在运行 (python app.py)\n';
                    }
                    if (!diagnostics.corsEnabled) {
                        message += '• 检查后端CORS配置\n';
                    }
                    if (!diagnostics.apiEndpoint) {
                        message += '• 检查API端点配置\n';
                    }
                }

                alert(message);
            } catch (error) {
                console.error('连接测试失败:', error);
                alert(`连接测试失败: ${error.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        /**
         * 测试数据收集
         */
        function testDataCollection() {
            console.log('=== 数据收集测试 ===');

            // 检查所有问题行
            const questionRows = document.querySelectorAll('.assessment-table .question-row');
            console.log(`找到 ${questionRows.length} 个问题行`);

            questionRows.forEach((row, index) => {
                const questionNumber = index + 1;
                const radios = row.querySelectorAll('input[type="radio"]');
                const speechCheckbox = row.querySelector('input[type="checkbox"]');

                console.log(`问题 ${questionNumber}:`);
                console.log(`  - 单选按钮数量: ${radios.length}`);
                console.log(`  - 说话复选框: ${speechCheckbox ? '存在' : '不存在'}`);

                let hasSelected = false;
                radios.forEach((radio, radioIndex) => {
                    if (radio.checked) {
                        console.log(`  - 选中选项: ${radio.value} (索引 ${radioIndex})`);
                        hasSelected = true;
                    }
                });

                if (!hasSelected) {
                    console.log(`  - 未选择任何选项`);
                }

                if (speechCheckbox) {
                    console.log(`  - 说话能力: ${speechCheckbox.checked ? '可以' : '不可以'}`);
                }
            });

            return questionRows.length;
        }

        /**
         * 调试数据结构
         */
        function debugDataStructure() {
            console.log('=== 数据结构调试 ===');

            try {
                const detailedData = collectDetailedData();
                console.log('detailedData:', detailedData);
                console.log('detailedData.length:', detailedData.length);
                console.log('detailedData[0]:', detailedData[0]);

                if (detailedData.length > 0) {
                    const firstItem = detailedData[0];
                    console.log('第一项的属性:');
                    Object.keys(firstItem).forEach(key => {
                        console.log(`  ${key}:`, firstItem[key]);
                    });
                }

                return detailedData;
            } catch (error) {
                console.error('数据结构调试失败:', error);
                return null;
            }
        }

        /**
         * 网络连接诊断
         */
        async function diagnoseConnection() {
            console.log('开始网络连接诊断...');

            const diagnostics = {
                serverReachable: false,
                corsEnabled: false,
                apiEndpoint: false
            };

            try {
                // 测试基本连接
                const response = await fetch(CONFIG.getPageUrl('/'), {
                    method: 'GET',
                    mode: 'no-cors'
                });
                diagnostics.serverReachable = true;
                console.log('✅ 服务器可达');
            } catch (error) {
                console.log('❌ 服务器不可达:', error.message);
            }

            try {
                // 测试CORS
                const response = await fetch(CONFIG.getApiUrl(CONFIG.API.SUBMIT), {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                diagnostics.corsEnabled = true;
                console.log('✅ CORS配置正常');
            } catch (error) {
                console.log('❌ CORS配置问题:', error.message);
            }

            try {
                // 测试API端点 - 使用HEAD请求避免400错误
                const response = await fetch(CONFIG.getApiUrl(CONFIG.API.SUBMIT), {
                    method: 'HEAD',
                    mode: 'cors'
                });
                diagnostics.apiEndpoint = response.status !== 404;
                console.log('✅ API端点可用');
            } catch (error) {
                // 如果HEAD不支持，尝试OPTIONS
                try {
                    const optionsResponse = await fetch(CONFIG.getApiUrl(CONFIG.API.SUBMIT), {
                        method: 'OPTIONS',
                        mode: 'cors'
                    });
                    diagnostics.apiEndpoint = optionsResponse.status !== 404;
                    console.log('✅ API端点可用');
                } catch (optionsError) {
                    console.log('❌ API端点问题:', error.message);
                }
            }

            return diagnostics;
        }

        /**
         * 保存评估结果到后端（增强版，包含详细数据）
         */
        async function saveResult() {
            // 防止重复提交 - 双重检查
            const currentTime = Date.now();
            if (isSubmitting) {
                console.log('正在提交中，请勿重复点击');
                return;
            }
            
            if (currentTime - lastSubmitTime < SUBMIT_COOLDOWN) {
                console.log(`请等待 ${Math.ceil((SUBMIT_COOLDOWN - (currentTime - lastSubmitTime)) / 1000)} 秒后再次提交`);
                return;
            }

            isSubmitting = true;
            lastSubmitTime = currentTime;
            const saveBtn = document.getElementById('saveResultBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';

            try {
                // 首先验证所有问题是否已回答
                const detailedData = collectDetailedData();

                if (!detailedData || !Array.isArray(detailedData) || detailedData.length === 0) {
                    alert('数据收集失败，请刷新页面后重试。');
                    // 恢复按钮状态和提交标志
                    isSubmitting = false;
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存结果';
                    return;
                }

                const unansweredQuestions = detailedData.filter(q => q.selectedOption === null || q.selectedOption === undefined);

                if (unansweredQuestions.length > 0) {
                    alert(`请完成所有 ${detailedData.length} 道题目后再保存结果。\n您还有 ${unansweredQuestions.length} 道题目未完成。`);
                    // 恢复按钮状态和提交标志
                    isSubmitting = false;
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存结果';
                    return;
                }

                // 收集基本信息
                const basicInfo = {
                    name: document.getElementById('name').value || '',
                    grade: document.getElementById('grade').value || '',
                    date: document.getElementById('date').value || ''
                };

                // 收集详细问卷答案
                const detailedAnswers = {};
                detailedData.forEach(data => {
                    // 确保所有值都不是undefined
                    const questionKey = `q${data.questionNumber}`;
                    
                    // 更严格的数据验证和默认值处理
                    const score = (data.selectedOption !== null && data.selectedOption !== undefined && !isNaN(data.selectedOption)) 
                        ? data.selectedOption 
                        : null;
                    
                    const scoreText = data.selectedText && data.selectedText !== 'undefined' && data.selectedText !== '未选择'
                        ? data.selectedText 
                        : (score !== null ? `${score}分` : '未选择');
                    
                    detailedAnswers[questionKey] = {
                        questionText: data.questionText || `问题 ${data.questionNumber}`,
                        score: score,
                        scoreText: scoreText,
                        canSpeak: Boolean(data.canSpeak),
                        canSpeakText: data.canSpeakText || (data.canSpeak ? '可以说话' : '不可以说话'),
                        allOptions: data.options && Array.isArray(data.options) ? data.options.map(opt => ({
                            value: opt.value !== undefined ? opt.value : -1,
                            text: opt.text || '',
                            selected: Boolean(opt.selected)
                        })) : []
                    };

                    // 调试输出
                    console.log(`问题 ${data.questionNumber}:`, {
                        原始数据: data,
                        处理后数据: detailedAnswers[questionKey]
                    });
                });

                // 计算统计数据
                const totalScore = detailedData.reduce((sum, q) => sum + (q.selectedOption || 0), 0);
                const averageScore = (totalScore / detailedData.length).toFixed(1);
                const speechCount = detailedData.filter(q => q.canSpeak).length;

                // 验证基本信息
                const validationErrors = [];
                if (!basicInfo.name.trim()) {
                    validationErrors.push('请填写姓名');
                }
                if (!basicInfo.grade.trim()) {
                    validationErrors.push('请填写年级');
                }
                if (!basicInfo.date) {
                    validationErrors.push('请选择填表日期');
                }

                if (validationErrors.length > 0) {
                    alert('❌ 请完善以下信息：\n' + validationErrors.join('\n'));
                    isSubmitting = false;
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存结果';
                    return;
                }

                // 构建符合API标准的问题数据
                const questions = detailedData.map((q, index) => ({
                    id: index + 1,
                    type: 'multiple_choice',
                    question: q.questionText,
                    options: [
                        { value: 0, text: '非常容易(没有焦虑)' },
                        { value: 1, text: '相当容易(有点焦虑)' },
                        { value: 2, text: '有点困难(有不少焦虑)' },
                        { value: 3, text: '困难(更加焦虑)' },
                        { value: 4, text: '非常困难(高度焦虑)' }
                    ],
                    selected: [q.selectedOption],
                    can_speak: q.canSpeak
                }));

                // 构建要提交的完整数据 - 符合API标准格式
                const dataToSubmit = {
                    type: 'elementary_school_communication_assessment',
                    basic_info: {
                        name: basicInfo.name.trim(),
                        grade: basicInfo.grade.trim(),
                        submission_date: basicInfo.date
                    },
                    questions: questions,
                    statistics: {
                        total_score: totalScore,
                        completion_rate: 100,
                        submission_time: new Date().toISOString()
                    }
                };

                try {
                    console.log('=== 提交数据调试 ===');
                    console.log('详细数据:', detailedData);
                    console.log('详细答案:', detailedAnswers);
                    console.log('完整提交数据:', dataToSubmit);

                    // 检查是否有undefined值
                    Object.keys(detailedAnswers).forEach(key => {
                        const answer = detailedAnswers[key];
                        if (answer.score === undefined || answer.score === null) {
                            console.warn(`警告: ${key} 的score是 ${answer.score}`);
                        }
                    });

                    // 运行网络诊断
                    console.log('正在进行网络连接诊断...');
                    const diagnostics = await diagnoseConnection();

                    if (!diagnostics.serverReachable) {
                        throw new Error('无法连接到服务器，请确保后端服务正在运行 (python app.py)');
                    }

                    if (!diagnostics.corsEnabled) {
                        throw new Error('CORS配置问题，请检查后端服务器配置');
                    }

                    // 发送POST请求到后端API
                    const response = await fetch(CONFIG.getApiUrl(CONFIG.API.SUBMIT), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(dataToSubmit),
                        mode: 'cors'
                    });

                    console.log('响应状态:', response.status);
                    console.log('响应头:', response.headers);

                    // 处理响应
                    if (response.ok) {
                        const result = await response.json();
                        console.log('保存成功:', result);
                        
                        // 显示成功消息
                        if (result.success) {
                            alert('✅ 数据保存成功！\n问卷ID: ' + (result.id || result.record_id));
                            showCompletion(result.id || result.record_id);
                        } else {
                            throw new Error(result.error?.message || '保存失败');
                        }
                    } else {
                        let errorMessage = `服务器错误 (${response.status})`;
                        try {
                            const errorData = await response.json();
                            if (errorData.error) {
                                if (errorData.error.details && Array.isArray(errorData.error.details)) {
                                    errorMessage = '数据验证失败：\n' + errorData.error.details.join('\n');
                                } else {
                                    errorMessage = errorData.error.message || errorData.message || errorMessage;
                                }
                            }
                        } catch (e) {
                            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                        }
                        console.error('保存失败:', errorMessage);
                        alert(`❌ 数据保存失败:\n${errorMessage}`);

                        // 恢复按钮状态
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存结果';
                    }
                } catch (error) {
                    console.error('提交数据时出错:', error);

                    // 详细的错误诊断
                    let errorMessage = '网络错误，请检查以下情况：\n\n';

                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorMessage += '❌ 网络连接问题：\n';
                        errorMessage += '  • 确保后端服务正在运行（运行 python app.py）\n';
                        errorMessage += '  • 检查服务器地址是否正确 (127.0.0.1:5000)\n';
                        errorMessage += '  • 检查防火墙设置\n\n';
                    } else if (error.message.includes('CORS')) {
                        errorMessage += '❌ 跨域问题：\n';
                        errorMessage += '  • 后端CORS配置可能有问题\n';
                        errorMessage += '  • 请联系技术支持\n\n';
                    } else {
                        errorMessage += '❌ 其他错误：\n';
                        errorMessage += `  • ${error.message}\n\n`;
                    }

                    errorMessage += '💡 建议解决方案：\n';
                    errorMessage += '1. 刷新页面后重试\n';
                    errorMessage += '2. 检查网络连接\n';
                    errorMessage += '3. 确认后端服务状态\n';
                    errorMessage += '4. 如果问题持续，请联系技术支持';

                    alert(errorMessage);

                    // 重置提交状态和按钮状态
                    isSubmitting = false;
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存结果';

                    // 提供诊断选项（移除自动重试以防止重复提交）
                    const userChoice = confirm('是否进行网络诊断？\n\n点击"确定"进行诊断\n点击"取消"手动重试');

                    if (userChoice) {
                        // 运行网络诊断
                        setTimeout(() => testConnection(), 500);
                    }
                }
            } catch (error) {
                console.error('提交数据时出错:', error);
                alert('网络错误，请检查您的网络连接后重试。');

                // 恢复按钮状态
                isSubmitting = false;
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存结果';
            }
        }

        /**
         * 显示完成页面
         */
        function showCompletion(recordId) {
            try {
                // 隐藏问卷区域
                const container = document.querySelector('.container');
                if (container) {
                    container.style.display = 'none';
                }

                // 获取详细数据
                const detailedData = collectDetailedData();

                if (!detailedData || !Array.isArray(detailedData) || detailedData.length === 0) {
                    alert('数据获取失败，无法显示完成页面');
                    return;
                }

                // 创建完成页面
                const completionPage = document.createElement('div');
                completionPage.className = 'completion-page';

                let totalScore = 0;
                let speechCount = 0;

                detailedData.forEach(item => {
                    if (item && typeof item.selectedOption === 'number') {
                        totalScore += item.selectedOption;
                    }
                    if (item && item.canSpeak) {
                        speechCount++;
                    }
                });

                const averageScore = (totalScore / detailedData.length).toFixed(1);

                completionPage.innerHTML = `
                <div class="completion-container">
                    <div class="completion-header">
                        <h1><i class="fa fa-check-circle"></i> 问卷完成</h1>
                        <p class="completion-subtitle">小学生交流评定表已成功保存</p>
                    </div>
                    
                    <div class="completion-info">
                        <div class="info-card">
                            <h3><i class="fa fa-info-circle"></i> 基本信息</h3>
                            <div class="info-grid">
                                <div><strong>姓名:</strong> ${document.getElementById('name').value}</div>
                                <div><strong>年级:</strong> ${document.getElementById('grade').value}</div>
                                <div><strong>日期:</strong> ${document.getElementById('date').value}</div>
                                <div><strong>记录ID:</strong> ${recordId}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="completion-answers">
                        <h3><i class="fa fa-list-alt"></i> 回答总览</h3>
                        
                        <div class="summary-stats">
                            <div class="stat-item">
                                <strong>总分数:</strong> ${totalScore}分
                            </div>
                            <div class="stat-item">
                                <strong>平均分:</strong> ${averageScore}分
                            </div>
                            <div class="stat-item">
                                <strong>可以说话的问题:</strong> ${speechCount}个
                            </div>
                            <div class="stat-item">
                                <strong>总问题数:</strong> ${detailedData.length}个
                            </div>
                        </div>
                        
                        <div class="answers-grid">
                            ${detailedData && Array.isArray(detailedData) ? detailedData.map(item => `
                                <div class="answer-item">
                                    <div class="question-header">
                                        <div class="q-number">${item.questionNumber || '?'}</div>
                                        <div class="q-text">${item.questionText || '未知问题'}</div>
                                    </div>
                                    <div class="answer-details">
                                        <div class="score-info">
                                            <strong>评分:</strong> ${item.selectedOption === null ? '未选择 - 0 = 非常容易' : `${item.selectedOption} = ${item.selectedText}`}
                                        </div>
                                        <div class="speech-info">
                                            <strong>说话能力:</strong> 
                                            <span class="speech-status ${item.canSpeak ? 'can-speak' : 'cannot-speak'}">
                                                ${item.canSpeak ? '可以说话' : '不能说话'}
                                            </span>
                                        </div>
                                        <div class="all-options">
                                            <strong>所有选项:</strong>
                                            <ul>
                                                ${item.options ? item.options.map(opt =>
                    `<li class="${opt.selected ? 'selected' : ''}">${opt.value}=${opt.text}</li>`
                ).join('') : ''}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p>暂无数据</p>'}
                        </div>
                    </div>
                    
                    <div class="completion-actions">
                        <button class="btn-primary" onclick="window.location.reload()">
                            <i class="fa fa-refresh"></i> 填写新问卷
                        </button>
                        <button class="btn-secondary" onclick="window.print()">
                            <i class="fa fa-print"></i> 打印
                        </button>
                    </div>
                </div>
            `;

                document.body.appendChild(completionPage);
            } catch (error) {
                console.error('显示完成页面时出错:', error);
                alert('显示完成页面失败，请刷新页面后重试');

                // 恢复问卷显示
                const container = document.querySelector('.container');
                if (container) {
                    container.style.display = 'block';
                }
            }
        }

        /**
         * 显示详细的问卷数据
         */
        function generateAnswersHTML() {
            const questionRows = document.querySelectorAll('.assessment-table .question-row');
            let html = '<div class="answers-table">';

            questionRows.forEach((row, index) => {
                const questionNumber = index + 1;
                const questionText = row.querySelector('.question-description').textContent.trim();
                const radios = row.querySelectorAll('input[type="radio"]');
                const speechCheckbox = row.querySelector('input[type="checkbox"]');

                let selectedValue = null;
                let selectedText = '未选择';
                for (const radio of radios) {
                    if (radio.checked) {
                        selectedValue = parseInt(radio.value, 10);
                        selectedText = radio.nextElementSibling.textContent;
                        break;
                    }
                }

                const canSpeak = speechCheckbox ? (speechCheckbox.checked ? '是' : '否') : '不适用';

                html += `
                    <div class="answer-row">
                        <div class="answer-question">
                            <strong>问题 ${questionNumber}:</strong> ${questionText}
                        </div>
                        <div class="answer-details">
                            <span class="answer-score">评分: ${selectedText}</span>
                            <span class="answer-speech">能说话: ${canSpeak}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }



        /**
         * 收集详细的问卷数据（问题、所有选项、选中选项、说话能力状态）
         */
        function collectDetailedData() {
            const questionRows = document.querySelectorAll('.assessment-table .question-row');
            const detailedData = [];

            if (!questionRows || questionRows.length === 0) {
                console.warn('未找到问题行');
                return [];
            }

            questionRows.forEach((row, index) => {
                try {
                    const questionNumber = index + 1;
                    const questionDescElement = row.querySelector('.question-description');
                    const questionText = questionDescElement ? questionDescElement.textContent.trim() : `问题 ${questionNumber}`;
                    const radios = row.querySelectorAll('input[type="radio"]');
                    const speechCheckbox = row.querySelector('input[type="checkbox"]');

                    // 收集所有选项
                    const options = [];
                    let selectedOption = null;
                    let selectedText = '未选择';

                    const optionTexts = ['0=非常容易', '1=相当容易', '2=有点困难', '3=困难', '4=非常困难'];
                    radios.forEach((radio, radioIndex) => {
                        const option = {
                            value: parseInt(radio.value),
                            text: optionTexts[radioIndex] || `选项${radioIndex}`,
                            selected: radio.checked
                        };
                        options.push(option);

                        if (radio.checked) {
                            selectedOption = option.value;
                            selectedText = option.text;
                        }
                    });

                    // 如果没有选择任何选项，设置默认值
                    if (selectedOption === null) {
                        selectedText = '未选择';
                    }

                    // 收集说话能力状态
                    const canSpeak = speechCheckbox ? speechCheckbox.checked : false;

                    // 构建详细数据对象
                    const questionData = {
                        questionNumber: questionNumber,
                        questionText: questionText,
                        options: options,
                        selectedOption: selectedOption,
                        selectedText: selectedText,
                        canSpeak: canSpeak,
                        canSpeakText: canSpeak ? '可以说话' : '不可以说话'
                    };

                    detailedData.push(questionData);
                } catch (error) {
                    console.error(`处理问题 ${index + 1} 时出错:`, error);
                    // 添加一个默认的问题数据
                    detailedData.push({
                        questionNumber: index + 1,
                        questionText: `问题 ${index + 1}`,
                        options: [],
                        selectedOption: null,
                        selectedText: '未选择',
                        canSpeak: false,
                        canSpeakText: '不可以说话'
                    });
                }
            });

            return detailedData;
        }

        /**
         * 显示详细的问卷数据摘要
         */
        function showDetailedSummary() {
            const detailedData = collectDetailedData();
            let summaryHTML = '<div class="detailed-summary">';

            detailedData.forEach((data, index) => {
                summaryHTML += `
                    <div class="question-summary">
                        <h4>问题 ${data.questionNumber}: ${data.questionText}</h4>
                        <div class="selected-info">
                            <strong>选中选项:</strong> ${data.selectedText || '未选择'} 
                            <span class="speak-status">(${data.canSpeakText})</span>
                        </div>
                        <div class="all-options">
                            <strong>所有选项:</strong>
                            <ul>
                                ${data.options.map(opt =>
                    `<li class="${opt.selected ? 'selected' : ''}">
                                        ${opt.text} ${opt.selected ? '✓' : ''}
                                    </li>`
                ).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });

            summaryHTML += '</div>';
            return summaryHTML;
        }
    </script>
</body>

</html>