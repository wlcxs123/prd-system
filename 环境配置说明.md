# 环境配置说明文档

## 概述

本项目支持多环境部署，包括开发环境、测试环境和生产环境。每个环境都有不同的配置和路径设置。

## 环境类型

### 1. 开发环境 (Development)

**特征:**
- 本地开发机器
- 主机名: `localhost` 或 `127.0.0.1`
- 端口: 通常使用 5003 或 8080
- 调试模式: 开启

**路径配置:**
```javascript
// 前端配置 (config.js)
BASE_URL: 'http://localhost:5003'  // 或 http://127.0.0.1:8080

// 资源路径
configPath = 'config.js'  // 相对路径
```

**后端配置:**
```python
# Flask配置
FLASK_ENV=development
DEBUG=True
DATABASE_PATH=./questionnaires.db  # 相对路径
```

### 2. 生产环境 (Production)

**特征:**
- 远程服务器
- 主机名: `115.190.103.114` 或自定义域名
- 端口: 8080
- 调试模式: 关闭
- 安全性增强

**路径配置:**
```javascript
// 前端配置 (config.js)
BASE_URL: 'http://115.190.103.114:8080'

// 资源路径
configPath = '/config.js'  // 绝对路径
```

**后端配置:**
```python
# Flask配置
FLASK_ENV=production
DEBUG=False
DATABASE_PATH=/app/data/questionnaires.db  # 绝对路径
SESSION_FILE_DIR=/app/sessions
LOG_FILE=/app/logs/app.log
BACKUP_PATH=/app/backups
```

## 环境检测机制

### 前端环境检测

```javascript
// Frankfurt Scale页面中的环境检测
(function() {
    var isLocal = location.hostname === 'localhost' || 
                  location.hostname === '127.0.0.1' || 
                  location.hostname === '';
    
    var configPath = isLocal ? 'config.js' : '/config.js';
    // 动态加载配置文件
})();
```

### 后端环境检测

```python
# app.py中的配置加载
config_name = os.environ.get('FLASK_ENV', 'development')
app.config.from_object(config[config_name])
```

## 配置文件结构

```
nginx-after/
├── config.js                    # 前端全局配置
├── .env.example                 # 环境变量示例
├── backend/
│   ├── config.py               # 基础配置类
│   ├── config_production.py    # 生产环境专用配置
│   └── app.py                  # 主应用文件
└── deploy.ps1                  # 部署脚本
```

## 环境变量配置

### 开发环境变量
```bash
FLASK_ENV=development
FLASK_APP=app.py
SECRET_KEY=dev-secret-key
PORT=8080
```

### 生产环境变量
```bash
FLASK_ENV=production
FLASK_APP=app.py
SECRET_KEY=your-super-secret-key-change-this-in-production
SERVER_NAME=115.190.103.114
PORT=8081
DATABASE_PATH=/app/data/questionnaires.db
SESSION_FILE_DIR=/app/sessions
LOG_FILE=/app/logs/app.log
CORS_ORIGINS=http://115.190.103.114:8080
ADMIN_PASSWORD=your-admin-password
```

## 路径差异对比

| 配置项 | 开发环境 | 生产环境 |
|--------|----------|----------|
| 前端BASE_URL | `http://localhost:5003` | `http://115.190.103.114:8080` |
| 配置文件路径 | `config.js` (相对) | `/config.js` (绝对) |
| 数据库路径 | `./questionnaires.db` | `/app/data/questionnaires.db` |
| 会话目录 | 默认临时目录 | `/app/sessions` |
| 日志文件 | 控制台输出 | `/app/logs/app.log` |
| 备份目录 | 不启用 | `/app/backups` |
| 静态文件 | 相对路径 | 绝对路径 |

## 部署流程

### 开发环境启动
```bash
# 1. 激活虚拟环境
cd backend
python -m venv venv
venv\Scripts\activate  # Windows
# source venv/bin/activate  # Linux/Mac

# 2. 安装依赖
pip install -r requirements.txt

# 3. 设置环境变量
set FLASK_ENV=development  # Windows
# export FLASK_ENV=development  # Linux/Mac

# 4. 启动应用
python app.py
```

### 生产环境部署
```bash
# 1. 使用部署脚本
.\deploy.ps1  # Windows
# ./deploy.sh  # Linux

# 2. 或手动部署
scp -r . root@115.190.103.114:/usr/share/nginx-after/
ssh root@115.190.103.114
cd /usr/share/nginx-after/backend
pip install -r requirements_production.txt
export FLASK_ENV=production
gunicorn -c gunicorn.conf.py wsgi:app
```

## 常见问题

### 1. 路径错误
**问题:** 404错误，找不到资源文件
**解决:** 检查环境检测逻辑，确保路径配置正确

### 2. CORS错误
**问题:** 跨域请求被阻止
**解决:** 检查CORS_ORIGINS配置，确保包含正确的域名

### 3. 数据库路径错误
**问题:** 无法连接数据库
**解决:** 检查DATABASE_PATH配置，确保路径存在且有权限

### 4. 静态文件加载失败
**问题:** CSS/JS文件加载失败
**解决:** 检查静态文件路径配置，确保使用正确的相对/绝对路径

## 最佳实践

1. **环境隔离:** 使用不同的配置文件和环境变量
2. **安全性:** 生产环境必须使用强密钥和HTTPS
3. **日志记录:** 生产环境启用详细日志记录
4. **备份策略:** 生产环境定期备份数据库
5. **监控:** 生产环境启用健康检查和性能监控

## 配置检查清单

### 开发环境
- [ ] Python虚拟环境已激活
- [ ] 依赖包已安装
- [ ] FLASK_ENV=development
- [ ] 数据库文件存在
- [ ] 端口未被占用

### 生产环境
- [ ] 服务器环境变量已设置
- [ ] SECRET_KEY已更改
- [ ] 数据库路径正确
- [ ] 日志目录有写权限
- [ ] 防火墙端口已开放
- [ ] HTTPS证书已配置（推荐）
- [ ] 备份策略已启用

## 总结

通过合理的环境配置和路径管理，可以确保应用在不同环境中稳定运行。关键是要理解每个环境的特点，并相应地调整配置参数。