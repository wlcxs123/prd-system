<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å°å¸ƒå¼€å£ Â· é€‰æ‹©æ€§ç¼„é»˜ç­›æŸ¥ï¼ˆé›†æˆç‰ˆ v4.0ï¼‰</title>
<script src="config.js"></script>
<style>
:root{--brand:#FF7A59;--brand2:#FFC857;--ink:#111827;--muted:#667085;--bg:#fff9f5;--card:#fff;--line:#f0e6de;--ok:#12B886;--mid:#F59E0B;--hi:#EF4444}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.app{max-width:1100px;margin:20px auto;background:#fff;border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(28,35,90,.06)}
header{padding:16px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;position:sticky;top:0;z-index:5}
.row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:38px;height:38px;border-radius:10px;background:#fff;color:var(--brand);display:grid;place-items:center;font-weight:900}
.seg{display:flex;border:1px solid #ffffff3a;border-radius:999px;overflow:hidden}
.seg button{background:transparent;border:none;color:#fff;padding:8px 12px;cursor:pointer}
.seg button.act{background:#fff;color:var(--brand);font-weight:700}
.pill{display:inline-block;border:1px solid #ffffff3a;border-radius:999px;padding:4px 8px;background:#ffffff18;font-size:12px}
.prog{height:6px;background:#ffffff3a;border-radius:999px;overflow:hidden;margin-top:8px}
.prog i{display:block;height:100%;background:#fff;width:0;transition:width .3s}
main{padding:14px}
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
.btn{appearance:none;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font:inherit}
.btn-pri{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
.btn-ghost{background:#fff;border:1px solid var(--line);color:#111}
.btn-success{background:#28a745;color:#fff}
.btn:disabled{background:#ccc;cursor:not-allowed}
.grid{display:grid;gap:10px}
.col-3{grid-template-columns:repeat(3,1fr)}
.q{border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0}
.q h4{margin:0 0 4px 0;font-size:15px}
.en{color:#6b7280;font-size:12px}
select,input[type=date],input[type=text]{padding:8px;border-radius:8px;border:1px solid var(--line);width:100%}
.bar{height:8px;background:#ffe9cf;border-radius:999px;overflow:hidden}
.bar i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));width:0}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;color:#fff;font-weight:700;font-size:12px}
.low{background:var(--ok)}.mid{background:var(--mid)}.high{background:var(--hi)}
.muted{color:var(--muted);font-size:12px}
.toast{position:fixed;top:16px;right:16px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(-8px);transition:.25s;z-index:99}
.toast.show{opacity:1;transform:translateY(0)}
.chartWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
canvas{background:#fff;border:1px solid var(--line);border-radius:8px}
@media (max-width:960px){.col-3{grid-template-columns:1fr}.chartWrap{grid-template-columns:1fr}}
@media print{.no-print{display:none!important}}

/* é›†æˆç‰ˆæ–°å¢æ ·å¼ */
.integration-notice {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 14px;
}
.submit-section {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
    text-align: center;
}
.submit-section h4 {
    margin: 0 0 8px 0;
    color: #495057;
}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="row">
      <div class="brand"><div class="logo">å¸ƒ</div>
        <div><div style="font-weight:900;line-height:1">å°å¸ƒå¼€å£</div>
        <div style="opacity:.9;font-size:12px">æ¯ä¸€æ­¥éƒ½ç®—æ•° Â· å®¶é•¿é—®å·ï¼ˆFrankfurt Scale - é›†æˆç‰ˆï¼‰</div></div>
      </div>
      <div class="row" style="gap:10px">
        <div class="seg">
          <button class="act" onclick="setAge('3_7')">3â€“7</button>
          <button onclick="setAge('6_11')">6â€“11</button>
          <button onclick="setAge('12_18')">12â€“18</button>
        </div>
        <span class="pill" id="counter">è¿›åº¦ 0%</span>
      </div>
    </div>
    <div class="prog"><i id="bar"></i></div>
  </header>

  <main>
    <!-- é›†æˆè¯´æ˜ -->
    <div class="integration-notice">
      <strong>ğŸ”— ç³»ç»Ÿé›†æˆç‰ˆæœ¬</strong> - æ­¤ç‰ˆæœ¬å·²é›†æˆåˆ°é—®å·æ•°æ®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒæ•°æ®ç»Ÿä¸€ç®¡ç†ã€è‡ªåŠ¨å¤‡ä»½å’Œæ‰¹é‡åˆ†æã€‚
    </div>

    <section id="intro">
      <div class="card">
        <div class="row"><div>
          <h3 style="margin:0 0 6px 0">å¦‚ä½•ä½¿ç”¨</h3>
          <div class="muted">Aï¼šå¿«é€Ÿç­›æŸ¥ï¼ˆå®¶é•¿ç‰ˆï¼‰ï¼ˆDSï¼‰ Â· Bï¼šè¯´è¯æƒ…å†µè¯„åˆ†ï¼ˆSSï¼‰ã€‚ç”¨äºç­›æŸ¥/è¿½è¸ªï¼Œä¸æ›¿ä»£ä¸´åºŠè¯Šæ–­ã€‚</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-pri" onclick="start()">å¼€å§‹å¡«å†™</button>
          <button class="btn btn-ghost" onclick="clearAll()">æ¸…é™¤ç¼“å­˜</button>
        </div></div>
      </div>
    </section>

    <section id="form" hidden>
      <div class="card"><div class="grid col-3">
        <label>å„¿ç«¥å§“å *<input id="child" type="text" placeholder="å¿…å¡«" oninput="saveLocal()" required></label>
        <label>å®¶é•¿/ç›‘æŠ¤äºº<input id="guardian" type="text" placeholder="å¯é€‰" oninput="saveLocal()"></label>
        <label>æ—¥æœŸ *<input id="date" type="date" oninput="saveLocal()" required></label>
      </div></div>

      <div class="card">
        <div class="row">
          <h3 style="margin:0">A. å¿«é€Ÿç­›æŸ¥ï¼ˆå®¶é•¿ç‰ˆï¼‰<span class="en">ï¼ˆDiagnostic Scale, DSï¼‰</span></h3>
          <div style="display:flex;gap:6px" class="no-print">
            <button class="btn btn-ghost" onclick="saveClick()">æœ¬åœ°ä¿å­˜</button>
            <button class="btn btn-ghost" onclick="exportJSON()">å¯¼å‡ºJSON</button>
            <button class="btn btn-ghost" onclick="exportCSV()">å¯¼å‡ºCSV</button>
          </div>
        </div>
        <div id="ds"></div>
        <div class="row" style="margin-top:6px">
          <div>ç­›æŸ¥æ€»åˆ†ï¼š<b id="dsTotal">â€”</b>ï¼›<span id="dsInterp">â€”</span></div>
          <div><button class="btn btn-pri" onclick="showSS()">ä¸‹ä¸€æ­¥ï¼šB</button></div>
        </div>
      </div>

      <div class="card" id="ssCard" hidden>
        <h3 style="margin:0">B. è¯´è¯æƒ…å†µè¯„åˆ† <span class="en">ï¼ˆSeverity Scale, SSï¼‰</span></h3>
        <p class="muted" style="margin:.25rem 0 .5rem">0=æ— é—®é¢˜ï¼Œ1=è½»åº¦é™åˆ¶ï¼Œ2=å¶å°”ï¼Œ3=å‡ ä¹ä»ä¸ï¼Œ4=å®Œå…¨ä¸è¯´</p>
        <div class="grid col-3">
          <div><h4 style="margin:8px 0">å­¦æ ¡/å¹¼å„¿å›­</h4><div id="ss_school"></div></div>
          <div><h4 style="margin:8px 0">å…¬å…±åœºåˆ</h4><div id="ss_public"></div></div>
          <div><h4 style="margin:8px 0">å®¶åº­</h4><div id="ss_home"></div></div>
        </div>
        <hr style="border:none;border-top:1px solid var(--line)">
        <div class="grid col-3">
          <div class="card"><div>å­¦æ ¡å°è®¡</div><div class="bar"><i id="bar_school"></i></div><div>å¾—åˆ† <b id="sum_school">0</b></div></div>
          <div class="card"><div>å…¬å…±å°è®¡</div><div class="bar"><i id="bar_public"></i></div><div>å¾—åˆ† <b id="sum_public">0</b></div></div>
          <div class="card"><div>å®¶åº­å°è®¡</div><div class="bar"><i id="bar_home"></i></div><div>å¾—åˆ† <b id="sum_home">0</b></div></div>
        </div>
        <div style="margin-top:6px">æ€»åˆ†ï¼š<b id="ssTotal">0</b></div>
        
        <!-- æ–°å¢ï¼šæ•°æ®æäº¤åŒºåŸŸ -->
        <div class="submit-section">
          <h4>ğŸ“Š æ•°æ®æäº¤åˆ°ç®¡ç†ç³»ç»Ÿ</h4>
          <p class="muted">æäº¤åˆ°æœåŠ¡å™¨è¿›è¡Œç»Ÿä¸€ç®¡ç†å’Œåˆ†æï¼ˆæ¨èï¼‰</p>
          <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-success" onclick="submitToServer()" id="submitBtn">æäº¤åˆ°æœåŠ¡å™¨</button>
            <button class="btn btn-ghost" onclick="validateData()">éªŒè¯æ•°æ®</button>
          </div>
        </div>
        
        <div style="display:flex;gap:8px;margin-top:8px" class="no-print">
          <button class="btn btn-ghost" onclick="hideSS()">è¿”å› A</button>
          <button class="btn btn-pri" onclick="genReport()">ç”ŸæˆæŠ¥å‘Š</button>
        </div>
      </div>
    </section>

    <section id="report" hidden></section>

    <div class="card" id="chartsCard" hidden>
      <h3 style="margin:4px 0 8px 0">å¯è§†åŒ–</h3>
      <div class="chartWrap">
        <div>
          <div class="en">æŸ±çŠ¶å›¾ï¼šå­¦æ ¡/å…¬å…±/å®¶åº­å¾—åˆ†</div>
          <canvas id="barChart" width="520" height="320"></canvas>
        </div>
        <div>
          <div class="en">é›·è¾¾å›¾ï¼šå­¦æ ¡/å…¬å…±/å®¶åº­å¾—åˆ†</div>
          <canvas id="radarChart" width="520" height="320"></canvas>
        </div>
      </div>
    </div>

    <div class="card no-print" id="downloadCard" hidden>
      <button class="btn btn-pri" onclick="downloadPDF()">ä¸‹è½½PDFæŠ¥å‘Š</button>
      <button class="btn btn-ghost" onclick="downloadPNG()">ä¸‹è½½PNGå›¾ç‰‡</button>
    </div>
  </main>

  <div class="footer" style="padding:12px;text-align:center;color:#fff;background:linear-gradient(90deg,var(--brand),var(--brand2))">Â© å°å¸ƒå¼€å£ Â· æ¯ä¸€æ­¥éƒ½ç®—æ•° - é›†æˆç‰ˆ</div>
</div>

<!-- å¼•å…¥ç»Ÿä¸€é”™è¯¯å¤„ç†ç»„ä»¶ -->
<script>
// åŠ¨æ€åŠ è½½JSæ–‡ä»¶
const errorHandlerScript = document.createElement('script');
errorHandlerScript.src = CONFIG.BASE_URL + '/backend/static/js/error-handler.js';
document.head.appendChild(errorHandlerScript);

const helperScript = document.createElement('script');
helperScript.src = CONFIG.BASE_URL + '/backend/static/js/questionnaire-helper.js';
document.head.appendChild(helperScript);
</script>

<script>
// ======= åŸºç¡€æ•°æ®ï¼ˆES5 å†™æ³•ï¼‰ =======
var CUTOFF = {'3_7':7,'6_11':7,'12_18':6};
var DS = [
 ["åœ¨å®¶å¾ˆèƒ½è¯´è¯ï¼Œä½†åœ¨å…¬å…±/å­¦æ ¡ç¯å¢ƒæ˜æ˜¾æ²‰é»˜æˆ–é¿å…ç”¨è¯­è¨€ã€‚","Is there a clear distinction between speaking behavior at home (rather talkative) and in public (avoiding the use of words or even mute)?"],
 ["åœ¨æŸäº›æƒ…å¢ƒæˆ–é¢å¯¹æŸäº›äººæ—¶ä¸è¯´è¯ï¼Œå³ä½¿åˆ«äººæœŸå¾…ä»–/å¥¹å¼€å£ã€‚","Does your child not speak in certain situations and/or with certain persons, even though he/she is expected to?"],
 ["åœ¨è¿™äº›æƒ…å¢ƒé‡Œï¼Œè¿ç‚¹å¤´/æ‘‡å¤´/ç”¨æ‰‹æŒ‡æŒ‡ç‰©éƒ½éš¾ä»¥åšåˆ°ï¼ˆå³ä½¿è¢«è¦æ±‚ï¼‰ã€‚","Is your child unable to shake or nod his/her head or point to something in certain situations, if asked to?"],
 ["è¿™äº›åœºåˆä¸‹åŠ¨ä½œå˜æ…¢æˆ–åƒ'åƒµä½'ã€‚","Do his/her movements seem slow or frozen-like to you in certain situations?"],
 ["æŒç»­è‡³å°‘1ä¸ªæœˆï¼ˆä¸åŒ…å«é€‚åº”æ–°å­¦æ ¡çš„ç¬¬ä¸€ä¸ªæœˆï¼‰ã€‚","Has this behavior persisted for at least 1 month (not limited to the first month at a new school)?"],
 ["åœ¨å®¶ä»¥å¤–å¤šæ•°æ—¶é—´éƒ½å¾ˆå®‰é™æˆ–ä¸è¯´è¯ã€‚","In places other than home, is your child mostly quiet or mute?"],
 ["æ²‰é»˜ä¸æ˜¯å› ä¸ºä¸ä¼š/ä¸ç†Ÿæ‚‰æ‰€ç”¨è¯­è¨€ã€‚","Is the mutism not due to lack of knowledge or comfort with the spoken language?"],
 ["æ²‰é»˜æ˜æ˜¾å½±å“å­¦ä¹ ã€ç¤¾äº¤æˆ–å…¶ä»–é‡è¦åŠŸèƒ½ã€‚","Does the mutism significantly interfere with educational achievement, social communication, or other important areas of functioning?"],
 ["åœ¨å®¶ä»¥å¤–ï¼Œå³ä½¿ä¸ç†Ÿæ‚‰çš„äººä¹Ÿå¸¸å¸¸æ²‰é»˜ã€‚","Does your child often remain mute even with familiar persons outside the home?"],
 ["è¯¥è¡¨ç°ä¸èƒ½è¢«å…¶ä»–å¿ƒç†/å‘è‚²éšœç¢ï¼ˆå¦‚è‡ªé—­ç—‡è°±ç³»ï¼‰æ›´å¥½è§£é‡Šã€‚","Is the mutism not better explained by another mental or developmental disorder (e.g., autism spectrum disorder)?"]
];

var SS = {
 '3_7':{school:[
  ["åœ¨å¹¼å„¿å›­ä¸è€å¸ˆè¯´è¯","Does your child speak with teachers in kindergarten?"],
  ["åœ¨å¹¼å„¿å›­ä¸åŒä¼´è¯´è¯","Does your child speak with peers in kindergarten?"],
  ["åœ¨å¹¼å„¿å›­ä¸çˆ¶æ¯è¯´è¯ï¼ˆå³ä¾¿ä»–äººèƒ½å¬è§ï¼‰","Does he/she speak with their father/mother in the kindergarten, even if others can hear them?"],
  ["å‚ä¸ä½“è‚²/æ¸¸æˆæ´»åŠ¨","Does your child join in sports activities?"],
  ["åœ¨é›†ä½“æ´»åŠ¨ä¸­å¼€å£","Does your child speak in group activities at kindergarten?"],
  ["ä¸å›ºå®šçš„æœ‹å‹ç©è€å¹¶äº¤æµ","Does your child play with a few select peers?"]
 ],pub:[
  ["ä¸å…¬å…±åœºåˆçš„é™Œç”Ÿå„¿ç«¥äº¤è°ˆï¼ˆæ¸¸ä¹åœº/å‡æœŸ/æ³³æ± ï¼‰","Does he/she speak with unfamiliar children when addressed on the playground, on holidays, or in a public swimming pool?"],
  ["ä¸é‚»å±…è¯´è¯","Does your child speak with neighbors?"],
  ["åœ¨å•†åº—ä¸åº—å‘˜äº¤æµ","Does your child speak to shop assistants in a store?"],
  ["åœ¨é¤é¦†ç‚¹é¤","Does your child order food in a restaurant?"]
 ],home:[
  ["ä¸ç›´ç³»äº²å±ï¼ˆçˆ¶æ¯/å…„å¼Ÿå§å¦¹ï¼‰è¯´è¯","Does your child speak with all close family members (mother, father, siblings)?"],
  ["ä¸çˆ¶æ¯çš„æœ‹å‹è¯´è¯","Does your child speak at home with their parents' friends?"],
  ["åœ¨å®¶è°ˆè®ºä¸ªäººäº‹æƒ…ï¼ˆæ„Ÿå—/æ„¿æœ›/å†²çª/éœ€æ±‚/å†³å®š/ç»å†ï¼‰","Does he/she speak about personal issues (feelings, wishes, conflicts, needs, decisions, and experiences) at home?"],
  ["ä¸æ¥å®¶é‡Œçš„è‡ªå·±çš„æœ‹å‹è¯´è¯","Does he/she speak at home with his/her friends?"]
 ]},
 '6_11':{school:[
  ["åœ¨è¯¾å ‚ä¸è€å¸ˆè¯´è¯","Does your child speak with teachers at school?"],
  ["ä¸åŒç­åŒå­¦è¯´è¯","Does your child speak with classmates?"],
  ["åœ¨å­¦æ ¡æ“åœºè¯´è¯","Does he/she speak on the school playground?"],
  ["ä¸å›ºå®šæœ‹å‹ä¸€èµ·ç©è€å¹¶äº¤æµ","Does your child play with a few select peers?"],
  ["å‚åŠ ä½“è‚²è¯¾","Does your child take part in gym class?"],
  ["åœ¨è¯¾å ‚ä¸Šä¸¾æ‰‹å›ç­”é—®é¢˜","Does your child answer questions in class?"],
  ["åœ¨è¯¾å ‚ä¸Šæœ—è¯»","Does your child read aloud in class?"],
  ["ä¸éä»»è¯¾èŒå‘˜äº¤æµï¼ˆå¦‚æ ¡åŒ»/å›¾ä¹¦é¦†ç®¡ç†å‘˜ï¼‰","Does your child speak with non-teaching staff at school?"],
  ["ä¸ä¸åŒå¹´çº§çš„å­¦ç”Ÿäº¤æµ","Does your child speak with younger or older students?"],
  ["è¯¾å¤–ä¸è€å¸ˆäº¤è°ˆ","Does your child speak with teachers outside of lessons?"]
 ],pub:[
  ["ä¸å…¬å…±åœºåˆçš„é™Œç”Ÿå„¿ç«¥äº¤è°ˆï¼ˆæ¸¸ä¹åœº/å‡æœŸ/æ³³æ± ï¼‰","Does he/she speak with unfamiliar children when addressed on the playground, on holidays, or in a public swimming pool?"],
  ["ä¸é‚»å±…è¯´è¯","Does your child speak with neighbors?"],
  ["åœ¨å•†åº—ä¸åº—å‘˜äº¤æµ","Does your child speak to shop assistants in a store?"],
  ["åœ¨é¤é¦†ç‚¹é¤","Does your child order food in a restaurant?"]
 ],home:[
  ["ä¸ç›´ç³»äº²å±ï¼ˆçˆ¶æ¯/å…„å¼Ÿå§å¦¹ï¼‰è¯´è¯","Does your child speak with all close family members (mother, father, siblings)?"],
  ["ä¸çˆ¶æ¯çš„æœ‹å‹è¯´è¯","Does your child speak at home with their parents' friends?"],
  ["åœ¨å®¶è°ˆè®ºä¸ªäººäº‹æƒ…ï¼ˆæ„Ÿå—/æ„¿æœ›/å†²çª/éœ€æ±‚/å†³å®š/ç»å†ï¼‰","Does he/she speak about personal issues (feelings, wishes, conflicts, needs, decisions, and experiences) at home?"],
  ["ä¸æ¥å®¶é‡Œçš„è‡ªå·±çš„æœ‹å‹è¯´è¯","Does he/she speak at home with his/her friends?"]
 ]},
 '12_18':{school:[
  ["åœ¨è¯¾å ‚ä¸è€å¸ˆè¯´è¯","Does your child speak with teachers at school?"],
  ["ä¸åŒç­åŒå­¦è¯´è¯","Does your child speak with classmates?"],
  ["åœ¨æ ¡å›­å…¬å…±åŒºåŸŸï¼ˆæ“åœº/èµ°å»Šï¼‰è¯´è¯","Does he/she speak on the school playground or common areas?"],
  ["å‚åŠ ä½“è‚²è¯¾æˆ–ç¤¾å›¢/è¿åŠ¨é˜Ÿæ´»åŠ¨","Does your child take part in gym class or sports teams?"],
  ["åœ¨è¯¾å ‚ä¸Šä¸¾æ‰‹å›ç­”é—®é¢˜","Does your child answer questions in class?"],
  ["åœ¨è¯¾å ‚ä¸Šæœ—è¯»æˆ–åšæ¼”è®²/æ±‡æŠ¥","Does your child read aloud or give presentations in class?"],
  ["ä¸å…¶ä»–å¹´çº§å­¦ç”Ÿäº¤æµ","Does your child speak with students from other grades?"],
  ["ä¸æ ¡å†…å·¥ä½œäººå‘˜ï¼ˆå¦‚è¾…å¯¼å‘˜/å›¾ä¹¦é¦†ç®¡ç†å‘˜ï¼‰äº¤æµ","Does your child speak with school staff (e.g., counselor, librarian)?"]
 ],pub:[
  ["åœ¨èšä¼š/æ´»åŠ¨ä¸­ä¸ä¸ç†Ÿæ‚‰çš„åŒé¾„äººäº¤æµ","Does he/she speak with unfamiliar peers at gatherings or events?"],
  ["ä¸é‚»å±…æˆ–ç¤¾åŒºç†Ÿäººè¯´è¯","Does your child speak with neighbors or acquaintances in the community?"],
  ["åœ¨å•†åº—ä¸åº—å‘˜äº¤æµ","Does your child speak to shop assistants in a store?"],
  ["åœ¨é¤é¦†/å’–å•¡å…ç‚¹å•","Does your child order food or drinks in a restaurant or cafÃ©?"]
 ],home:[
  ["ä¸ç›´ç³»äº²å±ï¼ˆçˆ¶æ¯/å…„å¼Ÿå§å¦¹ï¼‰è¯´è¯","Does your child speak with all close family members (mother, father, siblings)?"],
  ["ä¸çˆ¶æ¯çš„æœ‹å‹æˆ–æ¥è®¿å®¢äººè¯´è¯","Does your child speak at home with their parents' friends or guests?"],
  ["åœ¨å®¶è°ˆè®ºä¸ªäººäº‹æƒ…ï¼ˆæ„Ÿå—/æ„¿æœ›/å†²çª/è®¡åˆ’ï¼‰","Does he/she speak about personal issues (feelings, wishes, conflicts, plans) at home?"],
  ["ä¸æœ‹å‹åœ¨å®¶é‡Œäº¤æµ","Does he/she speak at home with his/her friends?"]
 ]}
};

// ======= çŠ¶æ€ä¸å¼•ç”¨ =======
var age='3_7';
var state={ ds:{}, ss:{school:{},pub:{},home:{}} };
var KEY='xb_fssm_integrated_v40';
var barEl, counterEl, introEl, formEl, reportEl, dsBox, dsTotalEl, dsInterpEl,
    ssCardEl, ssSchoolEl, ssPublicEl, ssHomeEl, sumSchoolEl, sumPublicEl, sumHomeEl,
    barSchoolEl, barPublicEl, barHomeEl, ssTotalEl, childEl, guardianEl, dateEl,
    chartsCardEl, barCanvas, radarCanvas, downloadCardEl, submitBtnEl;

window.onload=function(){
  // æ£€æŸ¥æ˜¯å¦åŠ è½½äº†é”™è¯¯å¤„ç†ç»„ä»¶
  if (typeof errorHandler === 'undefined') {
    console.warn('é”™è¯¯å¤„ç†ç»„ä»¶æœªåŠ è½½ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');
  } else {
    // æ˜¾ç¤ºé›†æˆç‰ˆæ¬¢è¿ä¿¡æ¯
    setTimeout(function() {
      if (typeof errorHandler !== 'undefined') {
        errorHandler.showInfo('æ¬¢è¿ä½¿ç”¨é›†æˆç‰ˆ', {
          details: 'æ­¤ç‰ˆæœ¬æ”¯æŒæ•°æ®ç»Ÿä¸€ç®¡ç†å’Œè‡ªåŠ¨å¤‡ä»½'
        });
      }
    }, 1000);
  }

  barEl=document.getElementById('bar');
  counterEl=document.getElementById('counter');
  introEl=document.getElementById('intro');
  formEl=document.getElementById('form');
  reportEl=document.getElementById('report');
  dsBox=document.getElementById('ds');
  dsTotalEl=document.getElementById('dsTotal');
  dsInterpEl=document.getElementById('dsInterp');
  ssCardEl=document.getElementById('ssCard');
  ssSchoolEl=document.getElementById('ss_school');
  ssPublicEl=document.getElementById('ss_public');
  ssHomeEl=document.getElementById('ss_home');
  sumSchoolEl=document.getElementById('sum_school');
  sumPublicEl=document.getElementById('sum_public');
  sumHomeEl=document.getElementById('sum_home');
  barSchoolEl=document.getElementById('bar_school');
  barPublicEl=document.getElementById('bar_public');
  barHomeEl=document.getElementById('bar_home');
  ssTotalEl=document.getElementById('ssTotal');
  childEl=document.getElementById('child');
  guardianEl=document.getElementById('guardian');
  dateEl=document.getElementById('date');
  chartsCardEl=document.getElementById('chartsCard');
  barCanvas=document.getElementById('barChart');
  radarCanvas=document.getElementById('radarChart');
  downloadCardEl=document.getElementById('downloadCard');
  submitBtnEl=document.getElementById('submitBtn');

  // æ¢å¤ç¼“å­˜
  try{
    var raw=localStorage.getItem(KEY);
    if(raw){
      var d=JSON.parse(raw);
      age=d.age||age; state.ds=d.ds||{}; state.ss=d.ss||{school:{},pub:{},home:{}};
      childEl.value=d.child||''; guardianEl.value=d.guardian||''; dateEl.value=d.date||'';
      // æŒ‰é’®æ€
      var segBtns=document.querySelectorAll('.seg button');
      for(var i=0;i<segBtns.length;i++){ segBtns[i].className=''; if(segBtns[i].textContent.indexOf(age.split('_')[0])===0) segBtns[i].className='act'; }
    }
  }catch(e){}

  renderAll();
};

function toast(msg){ 
  // ä½¿ç”¨ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿçš„æç¤ºï¼Œå¦‚æœä¸å¯ç”¨åˆ™å›é€€åˆ°åŸå§‹toast
  if (typeof errorHandler !== 'undefined') {
    errorHandler.showInfo('æç¤º', msg);
  } else {
    // åŸå§‹toasté€»è¾‘
    var toastEl = document.getElementById('toast') || createToastElement();
    toastEl.textContent = msg;
    toastEl.className = 'toast show';
    setTimeout(function() { toastEl.className = 'toast'; }, 1800);
  }
}

function createToastElement() {
  var toastEl = document.createElement('div');
  toastEl.id = 'toast';
  toastEl.className = 'toast';
  document.body.appendChild(toastEl);
  return toastEl;
}

// ======= äº¤äº’ =======
function setAge(a){
  age=a;
  var segBtns=document.querySelectorAll('.seg button');
  for(var i=0;i<segBtns.length;i++){ segBtns[i].className=''; }
  if(a==='3_7') segBtns[0].className='act'; else if(a==='6_11') segBtns[1].className='act'; else segBtns[2].className='act';
  renderAll(); saveLocal();
}
function start(){
  introEl.hidden=true; formEl.hidden=false;
  if(!dateEl.value){ dateEl.value=(new Date().toISOString().slice(0,10)); }
  renderAll();
}
function clearAll(){ localStorage.removeItem(KEY); location.reload(); }
function showSS(){ ssCardEl.hidden=false; ssSchoolEl.scrollIntoView(); }
function hideSS(){ ssCardEl.hidden=true; }
function saveClick(){ saveLocal(); toast('å·²ä¿å­˜åˆ°æœ¬åœ°'); }

// ======= æ¸²æŸ“ =======
function renderAll(){ renderDS(); renderSS(); progress(); calcDS(); calcSS(); }
function renderDS(){
  dsBox.innerHTML='';
  for(var i=0;i<DS.length;i++){
    var it=DS[i], id='DS_'+(i+1);
    var box=document.createElement('div'); box.className='q';
    box.innerHTML='<h4>'+(i+1)+'. '+it[0]+'</h4><div class="en">'+it[1]+'</div>'+
      '<div><select id="'+id+'" onchange="onDSChange(\''+id+'\')">'+
      '<option value="">â€” è¯·é€‰æ‹© â€”</option><option value="1">æ˜¯ = 1åˆ†</option><option value="0">å¦ = 0åˆ†</option></select></div>';
    dsBox.appendChild(box);
    document.getElementById(id).value = (state.ds[id]!==undefined? state.ds[id]: '');
  }
}
function onDSChange(id){ state.ds[id]=document.getElementById(id).value; calcDS(); progress(); saveLocal(); }

function renderSS(){
  function fill(k, box){
    box.innerHTML='';
    var arr=SS[age][k];
    for(var i=0;i<arr.length;i++){
      var it=arr[i], id='SS_'+k.toUpperCase()+'_'+(i+1);
      var el=document.createElement('div'); el.className='q';
      el.innerHTML='<h4>'+it[0]+'</h4><div class="en">'+it[1]+'</div>'+
        '<div><select id="'+id+'" onchange="onSSChange(\''+k+'\',\''+id+'\')">'+
        '<option value="">â€” è¯·é€‰æ‹© â€”</option>'+
        '<option value="0">0 æ— é—®é¢˜</option><option value="1">1 è½»åº¦é™åˆ¶</option><option value="2">2 å¶å°”</option><option value="3">3 å‡ ä¹ä»ä¸</option><option value="4">4 å®Œå…¨ä¸è¯´</option>'+
        '</select></div>';
      box.appendChild(el);
      document.getElementById(id).value = (state.ss[k][id]!==undefined? state.ss[k][id]: '');
    }
  }
  fill('school', ssSchoolEl); fill('pub', ssPublicEl); fill('home', ssHomeEl);
}
function onSSChange(k,id){ state.ss[k][id]=Number(document.getElementById(id).value||0); calcSS(); progress(); saveLocal(); }

function progress(){
  var total = DS.length + SS[age].school.length + SS[age].pub.length + SS[age].home.length;
  var doneDS=0, k;
  for(k in state.ds){ if(state.ds.hasOwnProperty(k) && state.ds[k]!=='' && state.ds[k]!==undefined){ doneDS++; } }
  var doneSS=0, kk=['school','pub','home'], t,i;
  for(i=0;i<kk.length;i++){ k=kk[i]; for(t in state.ss[k]){ if(state.ss[k].hasOwnProperty(t) && state.ss[k][t]!=='' && state.ss[k][t]!==undefined){ doneSS++; } } }
  var pct=Math.round(100*(doneDS+doneSS)/total); barEl.style.width=pct+'%'; counterEl.textContent='è¿›åº¦ '+pct+'%';
}
function calcDS(){
  var t=0, i;
  for(i=1;i<=DS.length;i++){ t+= Number(state.ds['DS_'+i]||0); }
  dsTotalEl.textContent=String(t);
  var cut=CUTOFF[age], interp='â€”', tag='<span class="badge low">ä½é£é™©</span>';
  if(t>=cut){ interp='â‰¥'+cut+'ï¼šé«˜åº¦æ€€ç–‘SMï¼›å»ºè®®è½¬ä»‹è¯„ä¼°ã€‚'; tag='<span class="badge high">é«˜é£é™©</span>'; }
  else if(t>=cut-2){ interp=(cut-2)+'~'+(cut-1)+'ï¼šå¯èƒ½SMï¼›ç»“åˆBéƒ¨åˆ†ä¸è§‚å¯Ÿã€‚'; tag='<span class="badge mid">ä¸­ç­‰é£é™©</span>'; }
  else { interp='<'+(cut-2)+'ï¼šSMå¯èƒ½æ€§è¾ƒä½ï¼ˆå¦‚Béƒ¨åˆ†é«˜åˆ†ä»éœ€å…³æ³¨ï¼‰'; }
  dsInterpEl.innerHTML = tag+' '+interp;
}
function calcSS(){
  function sum(k){ var s=0, key; for(key in state.ss[k]){ if(state.ss[k].hasOwnProperty(key)){ s+= Number(state.ss[k][key]||0); } } return s; }
  var s1=sum('school'), s2=sum('pub'), s3=sum('home');
  sumSchoolEl.textContent=s1; sumPublicEl.textContent=s2; sumHomeEl.textContent=s3;
  var maxSchool=SS[age].school.length*4, maxPub=SS[age].pub.length*4, maxHome=SS[age].home.length*4;
  barSchoolEl.style.width=(maxSchool? Math.round(100*s1/maxSchool):0)+'%';
  barPublicEl.style.width=(maxPub? Math.round(100*s2/maxPub):0)+'%';
  barHomeEl.style.width=(maxHome? Math.round(100*s3/maxHome):0)+'%';
  ssTotalEl.textContent=s1+s2+s3;
}

// ======= æ–°å¢ï¼šæ•°æ®éªŒè¯å’Œæäº¤åŠŸèƒ½ =======

// éªŒè¯æ•°æ®å®Œæ•´æ€§
function validateData() {
  var errors = [];
  
  // éªŒè¯åŸºæœ¬ä¿¡æ¯
  if (!childEl.value.trim()) {
    errors.push('å„¿ç«¥å§“åä¸èƒ½ä¸ºç©º');
  }
  
  if (!dateEl.value) {
    errors.push('å¡«è¡¨æ—¥æœŸä¸èƒ½ä¸ºç©º');
  }
  
  // éªŒè¯DSéƒ¨åˆ†
  var dsComplete = 0;
  for (var i = 1; i <= DS.length; i++) {
    if (state.ds['DS_' + i] !== undefined && state.ds['DS_' + i] !== '') {
      dsComplete++;
    }
  }
  
  if (dsComplete < DS.length) {
    errors.push('Aéƒ¨åˆ†ï¼ˆå¿«é€Ÿç­›æŸ¥ï¼‰è¿˜æœ‰ ' + (DS.length - dsComplete) + ' ä¸ªé—®é¢˜æœªå®Œæˆ');
  }
  
  // éªŒè¯SSéƒ¨åˆ†
  var ssComplete = 0;
  var ssTotal = SS[age].school.length + SS[age].pub.length + SS[age].home.length;
  
  ['school', 'pub', 'home'].forEach(function(section) {
    for (var key in state.ss[section]) {
      if (state.ss[section].hasOwnProperty(key) && 
          state.ss[section][key] !== undefined && 
          state.ss[section][key] !== '') {
        ssComplete++;
      }
    }
  });
  
  if (ssComplete < ssTotal) {
    errors.push('Béƒ¨åˆ†ï¼ˆè¯´è¯æƒ…å†µè¯„åˆ†ï¼‰è¿˜æœ‰ ' + (ssTotal - ssComplete) + ' ä¸ªé—®é¢˜æœªå®Œæˆ');
  }
  
  if (errors.length > 0) {
    if (typeof errorHandler !== 'undefined') {
      errorHandler.showError('æ•°æ®éªŒè¯å¤±è´¥', 'è¯·å®Œå–„ä»¥ä¸‹ä¿¡æ¯ï¼š', 'error', {
        details: errors
      });
    } else {
      alert('æ•°æ®éªŒè¯å¤±è´¥ï¼š\n' + errors.join('\n'));
    }
    return false;
  } else {
    if (typeof errorHandler !== 'undefined') {
      errorHandler.showSuccess('æ•°æ®éªŒè¯é€šè¿‡ï¼', {
        details: 'æ‰€æœ‰å¿…å¡«é¡¹éƒ½å·²æ­£ç¡®å¡«å†™'
      });
    } else {
      toast('æ•°æ®éªŒè¯é€šè¿‡ï¼');
    }
    return true;
  }
}

// ç”Ÿæˆè¯„ä¼°ç»“æœè¯¦ç»†ä¿¡æ¯
function generateAssessmentResults() {
  var dsTotal = Number(dsTotalEl.textContent || 0);
  var cut = CUTOFF[age];
  var riskLevel = 'low';
  var riskText = 'ä½é£é™©';
  var interpretation = '';
  
  if (dsTotal >= cut) {
    riskLevel = 'high';
    riskText = 'é«˜é£é™©';
    interpretation = 'â‰¥' + cut + 'ï¼šé«˜åº¦æ€€ç–‘SMï¼›å»ºè®®è½¬ä»‹è¯„ä¼°ã€‚';
  } else if (dsTotal >= cut - 2) {
    riskLevel = 'mid';
    riskText = 'ä¸­ç­‰é£é™©';
    interpretation = (cut - 2) + '~' + (cut - 1) + 'ï¼šå¯èƒ½SMï¼›ç»“åˆBéƒ¨åˆ†ä¸è§‚å¯Ÿã€‚';
  } else {
    riskText = 'ä½é£é™©';
    interpretation = '<' + (cut - 2) + 'ï¼šSMå¯èƒ½æ€§è¾ƒä½ï¼ˆå¦‚Béƒ¨åˆ†é«˜åˆ†ä»éœ€å…³æ³¨ï¼‰';
  }
  
  return {
    risk_level: riskLevel,
    risk_text: riskText,
    interpretation: interpretation,
    cutoff_value: cut,
    ds_score: dsTotal
  };
}

// ç”Ÿæˆä¸»è¦å›°éš¾åœºæ™¯åˆ†æ
function generateDifficultyAnalysis() {
  var ssSchool = Number(sumSchoolEl.textContent || 0);
  var ssPublic = Number(sumPublicEl.textContent || 0);
  var ssHome = Number(sumHomeEl.textContent || 0);
  
  var primaryDifficulty = 'æš‚æ— æ˜¾è‘—å›°éš¾';
  var maxScore = Math.max(ssSchool, ssPublic, ssHome);
  
  if (maxScore > 0) {
    if (ssSchool === maxScore && ssSchool >= ssPublic && ssSchool >= ssHome) {
      primaryDifficulty = 'å­¦æ ¡/å¹¼å„¿å›­';
    } else if (ssPublic === maxScore && ssPublic >= ssSchool && ssPublic >= ssHome) {
      primaryDifficulty = 'å…¬å…±åœºåˆ';
    } else {
      primaryDifficulty = 'å®¶åº­';
    }
  }
  
  return {
    primary_difficulty: primaryDifficulty,
    school_score: ssSchool,
    public_score: ssPublic,
    home_score: ssHome,
    max_score: maxScore
  };
}

// ç”Ÿæˆå¹²é¢„å»ºè®®
function generateInterventionSuggestions() {
  var assessmentResults = generateAssessmentResults();
  var suggestions = [
    'é¿å…å½“ä¼—ç‚¹åæˆ–å‹åŠ›å¼å‚¬ä¿ƒï¼›é‡‡ç”¨"å…ˆè€³è¯­â†’è¿‘è·ç¦»ä½å£°â†’æ­£å¸¸éŸ³é‡"çš„é˜¶æ¢¯è¿‡æ¸¡ã€‚',
    'åœ¨å­©å­èƒ½è¯´è¯çš„ç¯å¢ƒä¸­å½•"å®‰å…¨å£°éŸ³"ï¼Œç”¨äºåœ¨å­¦æ ¡/ç¤¾åŒºåšæ¸è¿›å¼æ’­æ”¾ä¸æ¨¡ä»¿ã€‚'
  ];
  
  if (assessmentResults.risk_level !== 'low') {
    suggestions.push('å»ºè®®è”ç³»ä¸“ä¸šè¯„ä¼°ï¼Œåˆ¶å®šç³»ç»Ÿæ¸è¿›æš´éœ²è®¡åˆ’ã€‚');
  }
  
  return {
    general_suggestions: suggestions,
    professional_referral_needed: assessmentResults.risk_level !== 'low'
  };
}

// ç”Ÿæˆè‡ªä¸»æš´éœ²å±‚çº§
function generateExposureHierarchy() {
  var difficultyAnalysis = generateDifficultyAnalysis();
  var primaryDifficulty = difficultyAnalysis.primary_difficulty;
  
  var exposureMap = {
    'å­¦æ ¡/å¹¼å„¿å›­': [
      'åˆ°æ ¡å‘å›ºå®šè€å¸ˆç‚¹å¤´',
      'å°å£°é—®å¥½',
      'ä¸è€å¸ˆ1è¯',
      'ä¸è€å¸ˆ1å¥',
      'è¯¾å ‚å‰ç§ä¸‹å¯¹è¯',
      'è¯¾å ‚å†…å°å£°å›ç­”',
      'æœ—è¯»ä¸€å¥',
      'æœ—è¯»ä¸€æ®µ',
      'ä¸¾æ‰‹ä¸€æ¬¡',
      'è¯¾åä¸è€å¸ˆç®€çŸ­äº¤æµ'
    ],
    'å…¬å…±åœºåˆ': [
      'å•†åº—å‘åº—å‘˜ç‚¹å¤´',
      'è¯´"è°¢è°¢"',
      'è¯´"ä½ å¥½"',
      'å…³é”®è¯ç‚¹å•',
      'å®Œæ•´ç‚¹å•',
      'è¿½åŠ è¯´æ˜',
      'ç‹¬ç«‹ç»“è´¦è¯´è°¢è°¢',
      'é—®ä»·',
      'é—®è·¯çº¿',
      'ç”µè¯/å‰å°å’¨è¯¢ä¸€å¥'
    ],
    'å®¶åº­': [
      'å¯¹çˆ¶æ¯æœ‹å‹ç‚¹å¤´',
      'é—®å¥½',
      'è¯´è°¢è°¢/å†è§',
      'å›ç­”æ˜¯/å¦',
      'è¯´å‡ºéœ€æ±‚è¯',
      'å®Œæ•´å¥',
      'å‘æ¥è®¿è€…è¯´ä¸€å¥',
      'ä¸åŒé¾„æœ‹å‹è¯´ä¸€å¥',
      'è¡¨è¾¾å–œå¥½',
      'è®²è¿°ä¸€å¤©ä¸€ä»¶äº‹'
    ]
  };
  
  var hierarchy = exposureMap[primaryDifficulty] || ['ç»´æŒæ—¥å¸¸ç¤¾äº¤ç»ƒä¹ ï¼Œ2â€“4 å‘¨å¤æµ‹ä¸€æ¬¡ã€‚'];
  
  return {
    primary_focus: primaryDifficulty,
    hierarchy_steps: hierarchy,
    recommended_frequency: '2-4å‘¨å¤æµ‹ä¸€æ¬¡'
  };
}

// è½¬æ¢ä¸ºæ ‡å‡†é—®å·æ ¼å¼
function convertToStandardFormat() {
  var questions = [];
  var questionId = 1;
  
  // è½¬æ¢DSéƒ¨åˆ†
  for (var i = 0; i < DS.length; i++) {
    var dsId = 'DS_' + (i + 1);
    var selected = [];
    if (state.ds[dsId] !== undefined && state.ds[dsId] !== '') {
      selected = [parseInt(state.ds[dsId])];
    }
    
    questions.push({
      id: questionId++,
      type: 'multiple_choice',
      question: DS[i][0],
      question_en: DS[i][1],
      options: [
        { value: 1, text: 'æ˜¯ = 1åˆ†' },
        { value: 0, text: 'å¦ = 0åˆ†' }
      ],
      selected: selected,
      section: 'DS'
    });
  }
  
  // è½¬æ¢SSéƒ¨åˆ†
  var sections = ['school', 'pub', 'home'];
  var sectionNames = { school: 'SS_school', pub: 'SS_public', home: 'SS_home' };
  
  sections.forEach(function(section) {
    var questions_list = SS[age][section];
    for (var i = 0; i < questions_list.length; i++) {
      var ssId = 'SS_' + section.toUpperCase() + '_' + (i + 1);
      var selected = [];
      if (state.ss[section][ssId] !== undefined && state.ss[section][ssId] !== '') {
        selected = [state.ss[section][ssId]];
      }
      
      questions.push({
        id: questionId++,
        type: 'multiple_choice',
        question: questions_list[i][0],
        question_en: questions_list[i][1],
        options: [
          { value: 0, text: '0 æ— é—®é¢˜' },
          { value: 1, text: '1 è½»åº¦é™åˆ¶' },
          { value: 2, text: '2 å¶å°”' },
          { value: 3, text: '3 å‡ ä¹ä»ä¸' },
          { value: 4, text: '4 å®Œå…¨ä¸è¯´' }
        ],
        selected: selected,
        section: sectionNames[section]
      });
    }
  });
  
  // ç”Ÿæˆè¯¦ç»†è¯„ä¼°ä¿¡æ¯
  var assessmentResults = generateAssessmentResults();
  var difficultyAnalysis = generateDifficultyAnalysis();
  var interventionSuggestions = generateInterventionSuggestions();
  var exposureHierarchy = generateExposureHierarchy();
  
  return {
    type: 'frankfurt_scale_selective_mutism',
    basic_info: {
      name: childEl.value.trim(),
      grade: age, // å¹´é¾„æ®µä½œä¸ºå¹´çº§
      submission_date: dateEl.value,
      guardian: guardianEl.value.trim()
    },
    questions: questions,
    statistics: {
      ds_total: assessmentResults.ds_score,
      ss_school_total: difficultyAnalysis.school_score,
      ss_public_total: difficultyAnalysis.public_score,
      ss_home_total: difficultyAnalysis.home_score,
      ss_total: difficultyAnalysis.school_score + difficultyAnalysis.public_score + difficultyAnalysis.home_score,
      age_group: age,
      risk_level: assessmentResults.risk_level,
      completion_rate: 100,
      submission_time: new Date().toISOString()
    },
    // æ–°å¢ï¼šè¯¦ç»†è¯„ä¼°æŠ¥å‘Šä¿¡æ¯
    assessment_report: {
      // è¯„ä¼°ç»“æœ
      assessment_results: {
        risk_level: assessmentResults.risk_level,
        risk_text: assessmentResults.risk_text,
        interpretation: assessmentResults.interpretation,
        cutoff_value: assessmentResults.cutoff_value,
        meets_criteria: assessmentResults.ds_score >= assessmentResults.cutoff_value
      },
      // Aéƒ¨åˆ†ï¼ˆå¿«é€Ÿç­›æŸ¥ï¼‰è¯¦ç»†ä¿¡æ¯
      diagnostic_scale: {
        total_score: assessmentResults.ds_score,
        cutoff_threshold: assessmentResults.cutoff_value,
        risk_category: assessmentResults.risk_level,
        interpretation: assessmentResults.interpretation,
        individual_responses: (function() {
          var responses = [];
          for (var i = 1; i <= DS.length; i++) {
            var dsId = 'DS_' + i;
            responses.push({
              question_number: i,
              question_text: DS[i-1][0],
              question_en: DS[i-1][1],
              response: state.ds[dsId] !== undefined ? parseInt(state.ds[dsId]) : null,
              response_text: state.ds[dsId] === '1' ? 'æ˜¯ = 1åˆ†' : (state.ds[dsId] === '0' ? 'å¦ = 0åˆ†' : 'æœªå›ç­”')
            });
          }
          return responses;
        })()
      },
      // Béƒ¨åˆ†ï¼ˆè¯´è¯æƒ…å†µè¯„åˆ†ï¼‰è¯¦ç»†ä¿¡æ¯
      severity_scale: {
        school_subscore: difficultyAnalysis.school_score,
        public_subscore: difficultyAnalysis.public_score,
        home_subscore: difficultyAnalysis.home_score,
        total_score: difficultyAnalysis.school_score + difficultyAnalysis.public_score + difficultyAnalysis.home_score,
        subscale_details: {
          school: {
            score: difficultyAnalysis.school_score,
            max_possible: SS[age].school.length * 4,
            percentage: Math.round((difficultyAnalysis.school_score / (SS[age].school.length * 4)) * 100),
            responses: (function() {
              var responses = [];
              for (var i = 1; i <= SS[age].school.length; i++) {
                var ssId = 'SS_SCHOOL_' + i;
                responses.push({
                  question_number: i,
                  question_text: SS[age].school[i-1][0],
                  question_en: SS[age].school[i-1][1],
                  response: state.ss.school[ssId] !== undefined ? state.ss.school[ssId] : null
                });
              }
              return responses;
            })()
          },
          public: {
            score: difficultyAnalysis.public_score,
            max_possible: SS[age].pub.length * 4,
            percentage: Math.round((difficultyAnalysis.public_score / (SS[age].pub.length * 4)) * 100),
            responses: (function() {
              var responses = [];
              for (var i = 1; i <= SS[age].pub.length; i++) {
                var ssId = 'SS_PUB_' + i;
                responses.push({
                  question_number: i,
                  question_text: SS[age].pub[i-1][0],
                  question_en: SS[age].pub[i-1][1],
                  response: state.ss.pub[ssId] !== undefined ? state.ss.pub[ssId] : null
                });
              }
              return responses;
            })()
          },
          home: {
            score: difficultyAnalysis.home_score,
            max_possible: SS[age].home.length * 4,
            percentage: Math.round((difficultyAnalysis.home_score / (SS[age].home.length * 4)) * 100),
            responses: (function() {
              var responses = [];
              for (var i = 1; i <= SS[age].home.length; i++) {
                var ssId = 'SS_HOME_' + i;
                responses.push({
                  question_number: i,
                  question_text: SS[age].home[i-1][0],
                  question_en: SS[age].home[i-1][1],
                  response: state.ss.home[ssId] !== undefined ? state.ss.home[ssId] : null
                });
              }
              return responses;
            })()
          }
        }
      },
      // ä¸»è¦å›°éš¾åœºæ™¯
      primary_difficulty_analysis: {
        primary_difficulty_area: difficultyAnalysis.primary_difficulty,
        difficulty_scores: {
          school: difficultyAnalysis.school_score,
          public: difficultyAnalysis.public_score,
          home: difficultyAnalysis.home_score
        },
        severity_ranking: (function() {
          var scores = [
            { area: 'å­¦æ ¡/å¹¼å„¿å›­', score: difficultyAnalysis.school_score },
            { area: 'å…¬å…±åœºåˆ', score: difficultyAnalysis.public_score },
            { area: 'å®¶åº­', score: difficultyAnalysis.home_score }
          ];
          return scores.sort(function(a, b) { return b.score - a.score; });
        })()
      },
      // å¹²é¢„å»ºè®®
      intervention_recommendations: {
        general_strategies: interventionSuggestions.general_suggestions,
        professional_referral_needed: interventionSuggestions.professional_referral_needed,
        specific_recommendations: {
          environmental_modifications: 'é¿å…å½“ä¼—ç‚¹åæˆ–å‹åŠ›å¼å‚¬ä¿ƒï¼›é‡‡ç”¨"å…ˆè€³è¯­â†’è¿‘è·ç¦»ä½å£°â†’æ­£å¸¸éŸ³é‡"çš„é˜¶æ¢¯è¿‡æ¸¡ã€‚',
          therapeutic_techniques: 'åœ¨å­©å­èƒ½è¯´è¯çš„ç¯å¢ƒä¸­å½•"å®‰å…¨å£°éŸ³"ï¼Œç”¨äºåœ¨å­¦æ ¡/ç¤¾åŒºåšæ¸è¿›å¼æ’­æ”¾ä¸æ¨¡ä»¿ã€‚',
          professional_support: interventionSuggestions.professional_referral_needed ? 'å»ºè®®è”ç³»ä¸“ä¸šè¯„ä¼°ï¼Œåˆ¶å®šç³»ç»Ÿæ¸è¿›æš´éœ²è®¡åˆ’ã€‚' : 'ç»§ç»­è§‚å¯Ÿï¼Œå®šæœŸå¤æµ‹ã€‚'
        }
      },
      // è‡ªä¸»æš´éœ²å±‚çº§
      exposure_hierarchy: {
        primary_focus_area: exposureHierarchy.primary_focus,
        hierarchy_steps: exposureHierarchy.hierarchy_steps,
        recommended_frequency: exposureHierarchy.recommended_frequency,
        step_by_step_plan: exposureHierarchy.hierarchy_steps.map(function(step, index) {
          return {
            step_number: index + 1,
            description: step,
            target_area: exposureHierarchy.primary_focus
          };
        })
      }
    }
  };
}

// æäº¤åˆ°æœåŠ¡å™¨
async function submitToServer() {
  try {
    // éªŒè¯æ•°æ®
    if (!validateData()) {
      return;
    }
    
    // ç¦ç”¨æäº¤æŒ‰é’®
    if (submitBtnEl) {
      submitBtnEl.disabled = true;
      submitBtnEl.textContent = 'æäº¤ä¸­...';
    }
    
    // è½¬æ¢æ•°æ®æ ¼å¼
    var questionnaireData = convertToStandardFormat();
    
    // æ£€æŸ¥æ˜¯å¦æœ‰é—®å·åŠ©æ‰‹
    if (typeof questionnaireHelper !== 'undefined') {
      // ä½¿ç”¨ç»Ÿä¸€çš„é—®å·æäº¤ç³»ç»Ÿ
      var result = await questionnaireHelper.submitQuestionnaire(questionnaireData, {
        showLoading: true,
        onSuccess: function(result) {
          if (typeof errorHandler !== 'undefined') {
            errorHandler.showSuccess('é—®å·æäº¤æˆåŠŸï¼', {
              details: 'é—®å·ID: ' + result.id + '\næ•°æ®å·²ä¿å­˜åˆ°ç®¡ç†ç³»ç»Ÿ'
            });
          }
          
          // æ˜¾ç¤ºæˆåŠŸé¡µé¢
          if (typeof questionnaireHelper.showSuccessPage === 'function') {
            questionnaireHelper.showSuccessPage(result.id);
          }
        }
      });
      
      return result;
    } else {
      // å›é€€åˆ°ç›´æ¥fetch
      var response = await fetch('http://localhost:5000/api/questionnaires', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(questionnaireData)
      });
      
      if (response.ok) {
        var result = await response.json();
        if (result.success) {
          if (typeof errorHandler !== 'undefined') {
            errorHandler.showSuccess('é—®å·æäº¤æˆåŠŸï¼', {
              details: 'é—®å·ID: ' + result.id
            });
          } else {
            toast('æäº¤æˆåŠŸï¼é—®å·ID: ' + result.id);
          }
          return result;
        } else {
          throw new Error(result.error?.message || 'æäº¤å¤±è´¥');
        }
      } else {
        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
      }
    }
    
  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error);
    if (typeof errorHandler !== 'undefined') {
      errorHandler.showError('æäº¤å¤±è´¥', error.message, 'error', {
        retry: function() { return submitToServer(); }
      });
    } else {
      alert('æäº¤å¤±è´¥: ' + error.message);
    }
    return null;
  } finally {
    // æ¢å¤æäº¤æŒ‰é’®
    if (submitBtnEl) {
      submitBtnEl.disabled = false;
      submitBtnEl.textContent = 'æäº¤åˆ°æœåŠ¡å™¨';
    }
  }
}

// ======= åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜ =======

// æŠ¥å‘Š & å›¾è¡¨
function payload(){
  return {
    date: dateEl.value || (new Date().toISOString().slice(0,10)),
    child: childEl.value||'', guardian: guardianEl.value||'',
    age: age, DS: Number(dsTotalEl.textContent||0),
    SS_school: Number(sumSchoolEl.textContent||0),
    SS_public: Number(sumPublicEl.textContent||0),
    SS_home: Number(sumHomeEl.textContent||0),
    SS_total: Number(ssTotalEl.textContent||0)
  };
}

function genReport(){
  var p=payload(), cut=CUTOFF[age];
  var top;
  if(p.SS_school===0 && p.SS_public===0 && p.SS_home===0) top='æš‚æ— æ˜¾è‘—å›°éš¾';
  else if(p.SS_school>=p.SS_public && p.SS_school>=p.SS_home) top='å­¦æ ¡/å¹¼å„¿å›­';
  else if(p.SS_public>=p.SS_school && p.SS_public>=p.SS_home) top='å…¬å…±åœºåˆ';
  else top='å®¶åº­';
  var risk = (p.DS>=cut)?'high':(p.DS>=cut-2?'mid':'low');
  var riskTxt = (risk==='high'?'é«˜é£é™©':(risk==='mid'?'ä¸­ç­‰é£é™©':'ä½é£é™©'));
  var badge = '<span class="badge '+risk+'">'+riskTxt+'</span>';
  var expMap={
    'å­¦æ ¡/å¹¼å„¿å›­':"åˆ°æ ¡å‘å›ºå®šè€å¸ˆç‚¹å¤´â†’å°å£°é—®å¥½â†’ä¸è€å¸ˆ1è¯â†’1å¥â†’è¯¾å ‚å‰ç§ä¸‹å¯¹è¯â†’è¯¾å ‚å†…å°å£°å›ç­”â†’æœ—è¯»ä¸€å¥â†’æœ—è¯»ä¸€æ®µâ†’ä¸¾æ‰‹ä¸€æ¬¡â†’è¯¾åä¸è€å¸ˆç®€çŸ­äº¤æµ",
    'å…¬å…±åœºåˆ':"å•†åº—å‘åº—å‘˜ç‚¹å¤´â†’è¯´'è°¢è°¢'â†’è¯´'ä½ å¥½'â†’å…³é”®è¯ç‚¹å•â†’å®Œæ•´ç‚¹å•â†’è¿½åŠ è¯´æ˜â†’ç‹¬ç«‹ç»“è´¦è¯´è°¢è°¢â†’é—®ä»·â†’é—®è·¯çº¿â†’ç”µè¯/å‰å°å’¨è¯¢ä¸€å¥",
    'å®¶åº­':"å¯¹çˆ¶æ¯æœ‹å‹ç‚¹å¤´â†’é—®å¥½â†’è¯´è°¢è°¢/å†è§â†’å›ç­”æ˜¯/å¦â†’è¯´å‡ºéœ€æ±‚è¯â†’å®Œæ•´å¥â†’å‘æ¥è®¿è€…è¯´ä¸€å¥â†’ä¸åŒé¾„æœ‹å‹è¯´ä¸€å¥â†’è¡¨è¾¾å–œå¥½â†’è®²è¿°ä¸€å¤©ä¸€ä»¶äº‹"
  };
  var exp = expMap[top] || 'ç»´æŒæ—¥å¸¸ç¤¾äº¤ç»ƒä¹ ï¼Œ2â€“4 å‘¨å¤æµ‹ä¸€æ¬¡ã€‚';

  reportEl.hidden=false; formEl.hidden=true; introEl.hidden=true;
  reportEl.innerHTML =
    '<div class="card" style="border-left:6px solid #ffd19c">'+
      '<div class="row">'+
        '<div><h3 style="margin:0 0 6px 0">è¯„ä¼°ç»“æœ '+badge+'</h3><div class="muted">å“ç‰Œï¼šå°å¸ƒå¼€å£ Â· æ¯ä¸€æ­¥éƒ½ç®—æ•°ï¼ˆé›†æˆç‰ˆï¼‰</div></div>'+
        '<div style="text-align:right"><div><b>å§“åï¼š</b>'+(p.child||'â€”')+'</div><div><b>æ—¥æœŸï¼š</b>'+p.date+'</div><div><b>å¹´é¾„æ®µï¼š</b>'+({'3_7':'3â€“7 å²','6_11':'6â€“11 å²','12_18':'12â€“18 å²'})[age]+'</div></div>'+
      '</div></div>'+
    '<div class="grid col-3">'+
      '<div class="card"><b>A éƒ¨åˆ†ï¼ˆå¿«é€Ÿç­›æŸ¥ï¼‰</b><div style="font-size:24px">'+p.DS+'</div><div class="muted">å‚è€ƒé˜ˆå€¼ï¼š'+cut+'</div></div>'+
      '<div class="card"><b>B éƒ¨åˆ†ï¼ˆè¯´è¯è¯„åˆ†ï¼‰</b><div>'+p.SS_school+' / '+p.SS_public+' / '+p.SS_home+'</div><div class="muted">æ€»åˆ†ï¼š'+p.SS_total+'</div></div>'+
      '<div class="card"><b>ä¸»è¦å›°éš¾åœºæ™¯</b><div style="font-size:18px">'+top+'</div><div class="muted">åŸºäºä¸‰åŸŸå°è®¡</div></div>'+
    '</div>'+
    '<div class="card"><h4 style="margin:0 0 6px 0">å¹²é¢„å»ºè®®</h4><ul style="margin:0 0 0 18px">'+
      '<li>é¿å…å½“ä¼—ç‚¹åæˆ–å‹åŠ›å¼å‚¬ä¿ƒï¼›é‡‡ç”¨"å…ˆè€³è¯­â†’è¿‘è·ç¦»ä½å£°â†’æ­£å¸¸éŸ³é‡"çš„é˜¶æ¢¯è¿‡æ¸¡ã€‚</li>'+
      '<li>åœ¨å­©å­èƒ½è¯´è¯çš„ç¯å¢ƒä¸­å½•"å®‰å…¨å£°éŸ³"ï¼Œç”¨äºåœ¨å­¦æ ¡/ç¤¾åŒºåšæ¸è¿›å¼æ’­æ”¾ä¸æ¨¡ä»¿ã€‚</li>'+
      (risk!=='low'?'<li>å»ºè®®è”ç³»ä¸“ä¸šè¯„ä¼°ï¼Œåˆ¶å®šç³»ç»Ÿæ¸è¿›æš´éœ²è®¡åˆ’ã€‚</li>':'')+
    '</ul></div>'+
    '<div class="card"><h4 style="margin:0 0 6px 0">è‡ªåŠ¨æš´éœ²å±‚çº§ï¼ˆæŒ‰ä¸»è¦å›°éš¾åœºæ™¯ï¼‰</h4>'+
      '<ol style="margin:0 0 0 18px">'+ exp.split('â†’').map(function(x){return '<li>'+x+'</li>';}).join('') +'</ol>'+
      '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap" class="no-print">'+
        '<button class="btn btn-ghost" onclick="backToForm()">è¿”å›ç»§ç»­ç¼–è¾‘</button>'+
      '</div>'+
    '</div>';

  // å›¾è¡¨ & ä¸‹è½½
  chartsCardEl.hidden=false; downloadCardEl.hidden=false;
  drawBarChart(); drawRadarChart();
  toast('æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå¯ä¸‹è½½ PDF / PNG');
}

function backToForm(){ reportEl.hidden=true; formEl.hidden=false; window.scrollTo(0,0); }

// æŸ±çŠ¶å›¾
function drawBarChart(){
  var g=barCanvas.getContext('2d'); g.clearRect(0,0,barCanvas.width,barCanvas.height);
  var s1=Number(sumSchoolEl.textContent||0), s2=Number(sumPublicEl.textContent||0), s3=Number(sumHomeEl.textContent||0);
  var vals=[s1,s2,s3], labels=['å­¦æ ¡','å…¬å…±','å®¶åº­'], max=Math.max(1, s1,s2,s3, 20);
  var W=barCanvas.width, H=barCanvas.height, pad=40, bw=60, gap=60, base=H-pad, i;
  g.strokeStyle='#ddd'; g.lineWidth=1; for(i=0;i<=4;i++){ var y=pad+i*(H-2*pad)/4; g.beginPath(); g.moveTo(pad,y); g.lineTo(W-pad,y); g.stroke(); }
  for(i=0;i<3;i++){ var x=pad+ i*(bw+gap)+gap; var h=(vals[i]/max)*(H-2*pad); g.fillStyle=(i===0?'#FF7A59':(i===1?'#FFC857':'#8FD3FF')); g.fillRect(x, base-h, bw, h); g.fillStyle='#333'; g.font='12px Arial'; g.fillText(labels[i], x+10, base+16); g.fillText(vals[i], x+18, base-h-6); }
  g.fillStyle='#333'; g.font='14px Arial'; g.fillText('åˆ†æ•°ï¼ˆè¶Šé«˜è¯´æ˜è¯¥åœºæ™¯è¶Šéš¾å¼€å£ï¼‰', pad, 20);
}

// é›·è¾¾å›¾ï¼ˆä¸‰è½´ï¼‰
function drawRadarChart(){
  var g=radarCanvas.getContext('2d'); g.clearRect(0,0,radarCanvas.width,radarCanvas.height);
  var s1=Number(sumSchoolEl.textContent||0), s2=Number(sumPublicEl.textContent||0), s3=Number(sumHomeEl.textContent||0);
  var W=radarCanvas.width,H=radarCanvas.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-40; var max=Math.max(1,s1,s2,s3,20);
  var axes=[{ang:-Math.PI/2,label:'å­¦æ ¡',val:s1},{ang:-Math.PI/2+2*Math.PI/3,label:'å…¬å…±',val:s2},{ang:-Math.PI/2+4*Math.PI/3,label:'å®¶åº­',val:s3}], i;
  g.strokeStyle='#e5e7eb'; for(i=1;i<=4;i++){ var rr=r*i/4; g.beginPath(); var j; for(j=0;j<3;j++){ var a=axes[j].ang, x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a); if(j){g.lineTo(x,y);}else{g.moveTo(x,y);} } g.closePath(); g.stroke(); }
  g.strokeStyle='#cbd5e1'; g.fillStyle='#333'; g.font='12px Arial';
  for(i=0;i<3;i++){ var x=cx+r*Math.cos(axes[i].ang), y=cy+r*Math.sin(axes[i].ang); g.beginPath(); g.moveTo(cx,cy); g.lineTo(x,y); g.stroke(); g.fillText(axes[i].label, x+(axes[i].ang>0?4:-24), y+(axes[i].ang>0?0:-6)); }
  g.beginPath(); for(i=0;i<3;i++){ var rr=r*(axes[i].val/max); var x2=cx+rr*Math.cos(axes[i].ang), y2=cy+rr*Math.sin(axes[i].ang); if(i){g.lineTo(x2,y2);}else{g.moveTo(x2,y2);} }
  g.closePath(); g.fillStyle='rgba(255,122,89,0.25)'; g.fill(); g.strokeStyle='#FF7A59'; g.stroke();
  g.fillStyle='#333'; g.font='14px Arial'; g.fillText('é›·è¾¾å›¾ï¼ˆè¶Šå¤–åœˆ=è¶Šéš¾å¼€å£ï¼‰', 10, 18);
}

// ======= å¯¼å‡º / å­˜å‚¨ =======
function saveLocal(){
  try{
    var d={ age:age, ds:state.ds, ss:state.ss, child:childEl.value, guardian:guardianEl.value, date:dateEl.value };
    localStorage.setItem(KEY, JSON.stringify(d));
  }catch(e){}
}

function exportJSON(){
  var p=[payload()];
  var blob=new Blob([JSON.stringify(p,null,2)],{type:'application/json'});
  var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='fssm-integrated-'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
}

function exportCSV(){
  var p=payload(); var keys=['date','child','guardian','age','DS','SS_school','SS_public','SS_home','SS_total'];
  var line=[keys.join(',')], row=[]; for(var i=0;i<keys.length;i++){ row.push(JSON.stringify(p[keys[i]]||'')); } line.push(row.join(',')); 
  var blob=new Blob([line.join('\n')],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='fssm-integrated-'+Date.now()+'.csv'; a.click(); URL.revokeObjectURL(url);
}

// ç»„åˆæŠ¥å‘Šç”»å¸ƒï¼ˆåŒæ­¥ï¼‰
function buildReportCanvas(){
  var w=1000,h=1414,pad=24;
  var cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h; var g=cvs.getContext('2d');
  // èƒŒæ™¯ & å¤´
  g.fillStyle='#fff'; g.fillRect(0,0,w,h);
  g.fillStyle='#FF7A59'; g.fillRect(0,0,w,76);
  g.fillStyle='#fff'; g.font='bold 28px Arial'; g.fillText('å°å¸ƒå¼€å£ Â· ä¸ªæ¡ˆæŠ¥å‘Šï¼ˆé›†æˆç‰ˆï¼‰', pad, 48);
  // æ‘˜è¦
  var txt=reportEl.innerText.replace(/\n{2,}/g,'\n').split('\n').slice(0,20).join('\n');
  g.fillStyle='#111'; g.font='16px Arial'; drawMultiline(g, txt, pad, 100, w-pad*2, 22);
  // å›¾è¡¨ç›´æ¥ç”»å…¥
  var imgW=(w-pad*3)/2, imgH=imgW*0.62, y=800;
  g.drawImage(barCanvas, pad, y, imgW, imgH);
  g.drawImage(radarCanvas, pad*2+imgW, y, imgW, imgH);
  g.fillStyle='#888'; g.font='12px Arial'; g.fillText('Â© å°å¸ƒå¼€å£ Â· æ¯ä¸€æ­¥éƒ½ç®—æ•° - é›†æˆç‰ˆ', pad, h-20);
  return cvs;
}

function drawMultiline(g, text, x, y, maxW, lh){
  var lines=text.split('\n'), i;
  for(i=0;i<lines.length;i++){
    var line=lines[i], s='', j, ch;
    for(j=0;j<line.length;j++){
      ch=line.charAt(j); if(g.measureText(s+ch).width>maxW){ g.fillText(s, x, y); y+=lh; s=ch; } else { s+=ch; }
    }
    g.fillText(s, x, y); y+=lh;
  }
}

function downloadPNG(){
  var c=buildReportCanvas(); var url=c.toDataURL('image/png'); var a=document.createElement('a'); a.href=url; a.download='å°å¸ƒå¼€å£-ä¸ªæ¡ˆæŠ¥å‘Š-é›†æˆç‰ˆ.png'; a.click();
}

// æç®€ PDFï¼ˆäºŒè¿›åˆ¶æ‹¼æ¥ï¼‰â€”â€”è‹¥æµè§ˆå™¨ä¸æ”¯æŒå°†æç¤ºä½¿ç”¨ PNG
function downloadPDF(){
  try{
    var c=buildReportCanvas();
    var imgData=c.toDataURL('image/jpeg',0.92);
    var pdfBytes = jpegToSinglePagePDF(imgData, {width:595.28, height:841.89});
    var blob = new Blob([pdfBytes], {type:'application/pdf'});
    var url = URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='å°å¸ƒå¼€å£-ä¸ªæ¡ˆæŠ¥å‘Š-é›†æˆç‰ˆ.pdf'; a.click(); URL.revokeObjectURL(url);
  }catch(e){
    toast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒPDFä¸‹è½½ï¼Œè¯·ç‚¹"ä¸‹è½½PNGå›¾ç‰‡"');
  }
}

function strToU8(str){
  var arr=new Uint8Array(str.length), i; for(i=0;i<str.length;i++){ arr[i]=str.charCodeAt(i)&255; } return arr;
}

function concatU8(list){
  var len=0,i; for(i=0;i<list.length;i++) len+=list[i].length;
  var out=new Uint8Array(len), pos=0; for(i=0;i<list.length;i++){ out.set(list[i],pos); pos+=list[i].length; } return out;
}

function jpegToSinglePagePDF(jpegDataURL, page){
  var b64 = jpegDataURL.split(',')[1];
  var bin = atob(b64);
  var imgLen = bin.length, i;
  var imgBytes = new Uint8Array(imgLen);
  for(i=0;i<imgLen;i++) imgBytes[i]=bin.charCodeAt(i);
  var w=page.width, h=page.height;

  var parts=[];
  parts.push(strToU8('%PDF-1.4\n'));
  function obj(n, contentU8){ parts.push(strToU8(n+' 0 obj\n')); parts.push(contentU8); parts.push(strToU8('\nendobj\n')); }
  var offsets=[0]; var size=0; function mark(){ offsets.push(size); }
  function add(u8){ size+=u8.length; }

  // é¢„è®¡ç®—ï¼ˆå…ˆåˆæˆå†å†™ xrefï¼‰
  // 1: image obj (with stream)
  var imgHead=strToU8('<< /Type /XObject /Subtype /Image /Width '+Math.floor(w)+' /Height '+Math.floor(h)+' /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length '+imgBytes.length+' >>\nstream\n');
  var imgTail=strToU8('\nendstream');
  var imgObj = concatU8([imgHead, imgBytes, imgTail]);
  
  // ç®€åŒ–PDFç”Ÿæˆï¼Œè¿”å›åŸºæœ¬ç»“æ„
  return concatU8(parts);
}
</script>

</body>
</html>