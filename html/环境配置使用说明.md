# HTML页面环境配置使用说明

## 概述

本系统为html文件夹中的所有页面提供了统一的环境判断和URL配置功能，支持自动区分本地开发环境和生产环境，并动态生成正确的URL。

## 核心特性

### 1. 自动环境检测
- **本地环境**: `localhost`, `127.0.0.1`, `0.0.0.0` 或空hostname
- **生产环境**: 其他所有hostname，使用 `115.190.103.114` + 动态端口

### 2. 动态端口支持
- 自动检测当前页面的端口号
- 生产环境使用 `http://115.190.103.114:${当前端口}` 作为baseUrl
- 本地环境使用相对路径（空字符串）

### 3. 统一配置管理
- 所有页面使用相同的环境检测逻辑
- 提供统一的URL生成器
- 支持日志输出和调试

## 文件结构

```
html/
├── env-config.js          # 核心环境配置文件
├── config.js              # 原有配置文件（已更新）
├── index.html             # 主页（已更新）
├── i5.html               # 资源页面（已更新）
├── magic-wire.html       # 游戏页面（已更新）
├── proxy-server.js       # 代理服务器（已更新）
└── 环境配置使用说明.md    # 本文档
```

## 使用方法

### 1. 在HTML页面中引入配置

```html
<!-- 在head标签中添加 -->
<script src="env-config.js"></script>
```

### 2. 使用全局配置对象

```javascript
// 获取基础URL
const baseUrl = ENV_CONFIG.baseUrl;

// 生成API URL
const apiUrl = ENV_CONFIG.urls.api('/api/submit');

// 生成页面URL
const pageUrl = ENV_CONFIG.urls.page('/admin');

// 生成图片URL
const imageUrl = ENV_CONFIG.urls.image('/logo.png');

// 检查环境
if (ENV_CONFIG.isLocal) {
    console.log('当前为本地开发环境');
} else {
    console.log('当前为生产环境');
}
```

### 3. 环境信息获取

```javascript
// 获取环境描述
const envDesc = ENV_CONFIG.getEnvDescription();
// 输出: "本地开发环境" 或 "生产环境 (115.190.103.114:8081)"

// 获取详细环境信息
const envInfo = ENV_CONFIG.environment;
console.log(envInfo);
// 输出: { isLocal: false, hostname: '115.190.103.114', port: '8081', protocol: 'http:', fullHost: '115.190.103.114:8081' }
```

### 4. 日志输出

```javascript
// 使用统一的日志格式
ENV_CONFIG.log('页面初始化完成', { baseUrl: ENV_CONFIG.baseUrl });
// 输出: [EnvConfig] 页面初始化完成 { baseUrl: 'http://115.190.103.114:8081' }
```

## 配置示例

### 本地开发环境
- 访问地址: `http://localhost:8081/index.html`
- 检测结果: `isLocal: true`
- baseUrl: `""` (空字符串，使用相对路径)
- 图片URL: `/image/logo.png`
- API URL: `/api/submit`

### 生产环境
- 访问地址: `http://115.190.103.114:8081/index.html`
- 检测结果: `isLocal: false`
- baseUrl: `"http://115.190.103.114:8081"`
- 图片URL: `http://115.190.103.114:8081/image/logo.png`
- API URL: `http://115.190.103.114:8081/api/submit`

## 已更新的文件

### 1. config.js
- 添加了 `detectEnvironment()` 函数
- 更新了 `TEMP_BASE_URL` 逻辑支持动态端口
- 增强了 `init()` 函数的环境检测

### 2. index.html
- 引入了 `env-config.js`
- 简化了环境检测代码
- 更新了 `openFSCMPage()` 函数支持动态URL

### 3. magic-wire.html
- 引入了 `env-config.js`
- 更新了 `BASE_URL` 设置逻辑

### 4. i5.html
- 引入了 `env-config.js`
- 准备支持动态URL配置

### 5. proxy-server.js
- 添加了环境检测函数
- 支持通过环境变量配置目标URL
- 动态生成代理目标地址

## 环境变量支持

### proxy-server.js 环境变量
- `NODE_ENV=development`: 设置为开发环境
- `PORT=5000`: 设置为开发端口
- `TARGET_PORT=5000`: 设置目标端口（生产环境）

## 调试和故障排除

### 1. 检查环境检测
```javascript
console.log('环境信息:', ENV_CONFIG.environment);
console.log('是否本地环境:', ENV_CONFIG.isLocal);
console.log('基础URL:', ENV_CONFIG.baseUrl);
```

### 2. 检查URL生成
```javascript
console.log('API URL:', ENV_CONFIG.urls.api('/test'));
console.log('页面URL:', ENV_CONFIG.urls.page('/admin'));
console.log('图片URL:', ENV_CONFIG.urls.image('/test.png'));
```

### 3. 监听配置就绪事件
```javascript
document.addEventListener('envConfigReady', function(event) {
    console.log('环境配置已就绪:', event.detail);
});
```

## 注意事项

1. **加载顺序**: 确保 `env-config.js` 在其他脚本之前加载
2. **兼容性**: 支持现代浏览器，IE11+
3. **缓存**: 环境检测结果会缓存，页面刷新后重新检测
4. **端口检测**: 如果页面没有显式端口，会使用协议默认端口（HTTP:80, HTTPS:443）

## 扩展功能

如需添加新的URL类型或环境检测逻辑，可以修改 `env-config.js` 文件中的相应函数。所有页面会自动继承新的配置。