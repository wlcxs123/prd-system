<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å„¿ç«¥é€‰æ‹©æ€§ç¼„é»˜å®¶é•¿é—®å· (ç‰ˆå—å¼)</title>
  <script src="config.js"></script>
  <style>
    :root {
      --brand: #5B86E5;
      --brand-2: #36D1DC;
      --ink: #1f2937;
      --muted: #667085;
      --card: #ffffff;
      --bg: #f6f9ff;
      --ok: #12B886;
      --warn: #F59E0B;
      --danger: #EF4444;
      --line: #e6ebf5
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px
    }

    .app {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(28, 35, 90, .06)
    }

    header {
      padding: 20px 20px;
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: #fff
    }

    .headrow {
      display: flex;
      align-items: center;
      gap: 14px;
      justify-content: space-between
    }

    .title {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: #fff;
      display: grid;
      place-items: center
    }

    .logo svg {
      width: 26px;
      height: 26px
    }

    .subtitle {
      opacity: .9;
      margin-top: 2px;
      font-size: 13px
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
      justify-content: space-between
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255, 255, 255, .35);
      border-radius: 999px;
      padding: 6px 12px;
      background: #ffffff18
    }

    .progress {
      height: 8px;
      background: rgba(255, 255, 255, .35);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px
    }

    .progress>i {
      display: block;
      height: 100%;
      width: 0;
      background: #fff;
      transition: width .3s
    }

    main {
      padding: 20px
    }

    .intro-card {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px
    }

    .cta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      font: inherit
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: #fff
    }

    .btn-ghost {
      background: #fff;
      border: 1px solid var(--line);
      color: var(--ink)
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed
    }

    .q-wrap {
      margin-top: 16px
    }

    .section-title {
      font-size: 24px;
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--brand);
      color: var(--brand)
    }

    .sub-section-title {
      font-size: 20px;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 16px;
    }

    .question-item {
      padding: 16px;
      border: 1px solid var(--line);
      border-radius: 16px;
      margin-bottom: 14px;
    }

    .question-item label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .answer-box {
      width: 100%;
      min-height: 80px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      font: inherit;
      resize: vertical
    }

    .form-group {
      margin-bottom: 16px
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font: inherit
    }

    .nav {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      position: sticky;
      bottom: 0;
      background: rgba(255, 255, 255, .92);
      backdrop-filter: saturate(120%) blur(8px);
      border-top: 1px solid var(--line);
      padding: 12px;
      
    }
    .hidden
    {
      visibility:hidden;
    }
    .result {
      display: none
    }

    .grid {
      display: grid;
      gap: 14px
    }

    .cols-3 {
      grid-template-columns: repeat(3, 1fr)
    }

    .date-group {
      display: flex;
      gap: 8px
    }

    .date-group select {
      flex: 1
    }

    .age-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px
    }

    @media (max-width:900px) {
      .brand {
        align-items: flex-start
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="app" id="app">
      <header>
        <div class="headrow">
          <div class="title">
            <div class="logo" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 21c0-5 1-8 3-10 2-2 5-2 8-2-2 4-5 6-8 6" stroke="#5B86E5" stroke-width="2"></path>
                <path d="M12 21c0-5-1-8-3-10-2-2-5-2-8-2 2 4 5 6 8 6" stroke="#36D1DC" stroke-width="2"></path>
                <circle cx="12" cy="21" r="2" fill="#fff" stroke="#fff"></circle>
              </svg>
            </div>
            <div>
              <h1 style="margin:0">å„¿ç«¥é€‰æ‹©æ€§ç¼„é»˜å®¶é•¿é—®å·</h1>
              <div class="subtitle">å®¶é•¿è®¿è°ˆç‰ˆ Â· ç‰ˆå—å¼ç­”é¢˜</div>
            </div>
          </div>
        </div>
        <div class="toolbar" id="toolbar" hidden="">
          <span class="pill" id="counter">ç‰ˆå— 0/4</span>
          <div class="progress" id="progress" style="width:100%;"><i id="bar"></i></div>
        </div>
      </header>
      <main>
        <section id="basicInfo" class="intro-card">
          <h2>ç¬¬ä¸€æ­¥ï¼šå¡«å†™åŸºæœ¬ä¿¡æ¯</h2>
          <form id="basicForm" class="grid cols-3">
            <div class="form-group">
              <label for="childName">å­©å­å§“åï¼š</label>
              <input type="text" id="childName" class="form-control" required="">
            </div>
            <div class="form-group">
              <label for="dob">å‡ºç”Ÿæ—¥æœŸï¼š</label>
              <input type="date" id="dob" class="form-control" required="">
            </div>
            <div class="form-group">
              <label for="age">å¹´é¾„ï¼š</label>
              <input type="text" id="age" class="form-control" placeholder="è‡ªåŠ¨è®¡ç®—" readonly="">
              <div class="age-hint">æ ¹æ®å‡ºç”Ÿæ—¥æœŸè‡ªåŠ¨è®¡ç®—</div>
            </div>
            <div class="form-group">
              <label for="gender">æ€§åˆ«ï¼š</label>
              <select id="gender" class="form-control" required="">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
              </select>
            </div>
            <div class="form-group" id="schoolGroup">
              <label for="school">å¹¼å„¿å›­/å­¦æ ¡åç§°ï¼š</label>
              <input type="text" id="school" class="form-control" placeholder="å¦‚æœªå…¥å›­è¯·å¡«å†™'æœªå…¥å›­'" required="">
            </div>
            <div class="form-group" id="teacherGroup">
              <label for="teacher">ä¸»è¦è´Ÿè´£çš„è€å¸ˆï¼š</label>
              <input type="text" id="teacher" class="form-control" required="">
            </div>
          </form>
          <div class="cta">
            <button class="btn btn-primary" id="confirmBasic" disabled="">ç¡®è®¤ä¿¡æ¯å¹¶å¼€å§‹</button>
          </div>
        </section>

        <section id="qs" class="q-wrap" hidden=""></section>
        <nav class="nav hidden" id="nav" hidden="">
          <button class="btn btn-ghost" id="prev" hidden="">ä¸Šä¸€ä¸ªç‰ˆå—</button>
          <button class="btn btn-primary " id="next">ä¸‹ä¸€ä¸ªç‰ˆå—</button>
        </nav>

        <section id="report" class="result" aria-live="polite"></section>
      </main>
    </div>
  </div>
  <script>
    // ==================== é¢˜åº“å®šä¹‰ START ====================
    const SECTIONS = [
      {
        title: 'ä¸€ã€ç›®å‰å­˜åœ¨çš„é—®é¢˜',
        questions: [
          { type: 'heading', text: '1. æœ€ä¸»è¦çš„æ‹…å¿§æ˜¯ä»€ä¹ˆï¼Ÿ' },
          { id: 'C1_1', type: 'question', text: '1.1 è¯·åˆ—å‡ºæ‚¨æ‰€æœ‰æ‹…å¿§çš„äº‹ã€‚' },
          { id: 'C1_2', type: 'question', text: '1.2 æ‚¨è®¤ä¸ºå­©å­åœ¨å…¶ä»–æ–¹é¢çš„æƒ…å†µå’Œå…¶ä»–åŒé¾„å­©å­ä¸€æ ·å¥½å—ï¼Ÿ' },
          { id: 'C1_3', type: 'question', text: '1.3 è¿™äº›é—®é¢˜å‡ºç°å¤šä¹…äº†ï¼Ÿ' },
          { id: 'C1_4', type: 'question', text: '1.4 é™¤äº†æ‚¨ï¼Œè¿˜æœ‰è°åœ¨æ‹…å¿ƒï¼Ÿ' },
          { id: 'C1_5', type: 'question', text: '1.5 ä»–ä»¬ä¸ºä»€ä¹ˆæ‹…å¿ƒï¼Ÿ' },
          { id: 'C1_6', type: 'question', text: '1.6 ä»€ä¹ˆæœ‰åŠ©äºæˆ–é˜»ç¢é—®é¢˜çš„è§£å†³ï¼Ÿ' },
          { type: 'heading', text: '2. æ‚¨æ˜¯å¦æœ‰è¿‡ä¸€äº›å¯èƒ½çš„è§£é‡Šï¼Ÿ' },
          { id: 'C2_1', type: 'question', text: '2.1 æ‚¨æ˜¯å¦è®¤ä¸ºæœ‰äº›äººæˆ–äº‹å¯èƒ½å¯¹å­©å­çš„æ‹…å¿§è´Ÿæœ‰è´£ä»»ï¼Ÿ' },
          { id: 'C2_2', type: 'question', text: '2.2 æ‚¨æ˜¯å¦éœ€è¦å¸®åŠ©æ¥äº†è§£ä¿ƒæˆé—®é¢˜çš„å› ç´ ï¼Œæˆ–åº”å¯¹ä»»ä½•ä¸å½“çš„å†…ç–šæˆ–æŒ‡è´£ï¼Ÿ' },
          { id: 'C2_3', type: 'question', text: '2.3 æ‚¨æœ€å¸Œæœ›è·å¾—ä»€ä¹ˆé—®é¢˜çš„ç­”æ¡ˆï¼Ÿ' },
          { id: 'C2_4', type: 'question', text: '2.4 æ‚¨å¸Œæœ›ä»æˆ‘ä»¬è¿™é‡Œè·å¾—ä»€ä¹ˆå…·ä½“çš„å¸®åŠ©ï¼Ÿ' },
        ]
      },
      {
        title: 'äºŒã€å®¶åº­æƒ…å†µ',
        questions: [
          { id: 'F1', type: 'question', text: '1. ç›®å‰å®¶é‡Œä½ç€å“ªäº›äººï¼Ÿï¼ˆè¯·ä»‹ç»æˆå‘˜ã€å¹´é¾„ã€èŒä¸šï¼‰' },
          { id: 'F2', type: 'question', text: '2. å­©å­æœ€é‡è¦çš„å®¶äººæ˜¯è°ï¼Ÿå®¶äººå¤šä¹…è§ä¸€æ¬¡é¢ï¼Ÿ' },
          { id: 'F3', type: 'question', text: '3. å­©å­æ˜¯å¦æ›¾é¢å¯¹è¿‡ä»»ä½•é‡è¦çš„å®¶äººã€æœ‹å‹æˆ–å® ç‰©çš„å¤±å»ï¼Ÿ' },
          { id: 'F4', type: 'question', text: '4. å®¶æ—é‡Œæ˜¯å¦æœ‰æˆ–æ›¾ç»æœ‰ç¼„é»˜ã€å®³ç¾æˆ–å°‘è¨€å¯¡è¯­çš„äººï¼Ÿ' },
          { id: 'F5', type: 'question', text: '5. æ˜¯å¦æœ‰è¯´è¯å‘å±•è¿Ÿç¼“æˆ–å…¶ä»–è¯´è¯é—®é¢˜çš„å®¶æ—å²ï¼Ÿ' },
          { id: 'F6', type: 'question', text: '6. æ˜¯å¦æœ‰é˜…è¯»æˆ–å­¦ä¹ éšœç¢çš„å®¶æ—å²ï¼Ÿ' },
          { id: 'F7', type: 'question', text: '7. æ˜¯å¦æœ‰ä»»ä½•ç„¦è™‘æˆ–ç±»ä¼¼é—®é¢˜çš„å®¶æ—å²ï¼Ÿ' },
          { id: 'F8', type: 'question', text: '8. å­©å­åœ¨åœºæ—¶ï¼Œå®¶é‡Œäººä¼šè¯´å“ªç§è¯­è¨€ï¼Ÿ' },
        ]
      },
      {
        title: 'ä¸‰ã€è¯´è¯æ¨¡å¼',
        questions: [
          { id: 'S1', type: 'question', text: '1. å­©å­è·Ÿè°ã€åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹èƒ½å¤Ÿå°½æƒ…ã€è‡ªåœ¨åœ°è¯´è¯ï¼Ÿ' },
          { id: 'S2', type: 'question', text: '2. å­©å­èƒ½å¦å¯¹ä¸€äº›äººè¯´ä¸€äº›è¯ï¼Ÿï¼ˆè·Ÿè°ï¼Ÿä»€ä¹ˆæ—¶å€™ï¼Ÿä¸ºäº†ä»€ä¹ˆï¼Ÿï¼‰' },
          { id: 'S3', type: 'question', text: '3. åœ¨ä¸è¯´è¯æ—¶ï¼Œå­©å­æ˜¯å¦‚ä½•è·Ÿäººæ²Ÿé€šçš„ï¼Ÿåˆ«äººå¦‚ä½•ååº”ï¼Ÿ' },
          { id: 'S4', type: 'question', text: '4. åœ¨é›†ä½“æ´»åŠ¨ä¸­ï¼ˆå¦‚å­¦æ ¡ã€å…´è¶£ç­ã€èšä¼šç­‰ï¼‰ï¼Œå­©å­çš„è®²è¯æƒ…å†µå¦‚ä½•ï¼Ÿ' },
          { id: 'S5', type: 'question', text: '5. æ‚¨è®¤ä¸ºå­©å­å¤šå¤§ç¨‹åº¦ä¸Šæ„è¯†åˆ°äº†è‡ªå·±çš„è¯´è¯å›°éš¾ï¼Ÿ' },
          { id: 'S6', type: 'question', text: '6. å­©å­å¯¹æ­¤æœ‰ä»€ä¹ˆæ ·çš„è¯„è®ºæˆ–ååº”ï¼Ÿ' },
          { id: 'S7', type: 'question', text: '7. å°±æ­¤é—®é¢˜æ‚¨å’Œå­©å­è®¨è®ºåˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿä»–/å¥¹æ˜¯å¦å¸Œæœ›èƒ½å¤Ÿæ›´è‡ªåœ¨åœ°è¯´è¯ï¼Ÿ' },
        ]
      },
      {
        title: 'å››ã€ç­›æŸ¥é—®é¢˜',
        questions: [
          { type: 'heading', text: 'å½“å­©å­æ„Ÿåˆ°æ”¾æ¾æ—¶ï¼Œæ‚¨æ˜¯å¦å¯¹ä»¥ä¸‹æ–¹é¢æœ‰ä»»ä½•æ‹…å¿§ï¼š' },
          { id: 'SC1', type: 'question', text: '1. è¿åŠ¨æˆ–åè°ƒèƒ½åŠ› (å¹³è¡¡ã€çƒæŠ€)ï¼Ÿ' },
          { id: 'SC2', type: 'question', text: '2. ç²¾ç»†è¿åŠ¨çš„åè°ƒèƒ½åŠ› (ç”¨é¤å…·ã€æ‰£çº½æ‰£)ï¼Ÿ' },
          { id: 'SC3', type: 'question', text: '3. è¨€è¯­å’Œè¯­è¨€èƒ½åŠ› (ç†è§£ã€ç”¨è¯ã€å‘éŸ³)ï¼Ÿ' },
          { id: 'SC4', type: 'question', text: '4. ç¤¾äº¤æ²Ÿé€šæŠ€å·§ (ä¸æœ€äº²è¿‘çš„å®¶äººäº’åŠ¨)ï¼Ÿ' },
          { id: 'SC5', type: 'question', text: '5. æ•æ„Ÿåº¦ (å¯¹æŸäº›å£°éŸ³ã€æè´¨ã€è¢«è§¦æ‘¸ç­‰)ï¼Ÿ' },
          { id: 'SC6', type: 'question', text: '6. æ‚¨æ˜¯å¦æ‹…å¿ƒå­©å­çš„ä¸€èˆ¬æ™ºåŠ›æˆ–å­¦ä¹ ï¼Ÿ' },
          { id: 'SC7', type: 'question', text: '7. å­©å­è¿˜æœ‰å…¶ä»–ç‰¹å®šçš„ç„¦è™‘æˆ–ææƒ§ç—‡å—ï¼Ÿ' },
          { id: 'SC8', type: 'question', text: '8. æ‚¨å¯¹å­©å­çš„è¡Œä¸ºæœ‰ä»€ä¹ˆæ‹…å¿§å—ï¼Ÿ' },
        ]
      }
    ];
    // ==================== é¢˜åº“å®šä¹‰ END ====================

    // --- DOM & State ---
    const basicInfoSection = document.getElementById('basicInfo');
    const qsWrap = document.getElementById('qs');
    const nav = document.getElementById('nav');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');
    const toolbar = document.getElementById('toolbar');
    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');
    const counter = document.getElementById('counter');
    const report = document.getElementById('report');
    const confirmBasicBtn = document.getElementById('confirmBasic');

    let currentSectionIndex = 0;
    const answers = new Map();

    // --- Functions ---
    function init() {
      document.getElementById('basicForm').addEventListener('input', checkBasicForm);
      document.getElementById('dob').addEventListener('change', calculateAge);
      document.querySelectorAll('select').forEach(select => select.addEventListener('change', checkBasicForm));

      confirmBasicBtn.addEventListener('click', startQuestionnaire);

      btnPrev.addEventListener('click', () => navigate(-1));
      btnNext.addEventListener('click', () => navigate(1));
      
      // ç¡®ä¿å¯¼èˆªæ åœ¨åˆå§‹çŠ¶æ€ä¸‹æ˜¯éšè—çš„
      nav.hidden = true;
    }

    function startQuestionnaire() {
      saveBasicInfo();
      nav.visibility=false;
      basicInfoSection.hidden = true;
      toolbar.hidden = false;
      progress.hidden = false;
      qsWrap.hidden = false;
      nav.hidden = false;
      nav.classList.remove("hidden")
      renderSection();
    }

    function navigate(direction) {
      saveCurrentSectionAnswers();
      currentSectionIndex += direction;

      if (currentSectionIndex >= SECTIONS.length) {
        showReportPage();
      } else {
        renderSection();
      }
    }

    function renderSection() {
      const section = SECTIONS[currentSectionIndex];
      qsWrap.innerHTML = ''; // Clear previous section

      const titleEl = document.createElement('h2');
      titleEl.className = 'section-title';
      titleEl.textContent = section.title;
      qsWrap.appendChild(titleEl);

      section.questions.forEach(q => {
        if (q.type === 'heading') {
          const headingEl = document.createElement('h3');
          headingEl.className = 'sub-section-title';
          headingEl.textContent = q.text;
          qsWrap.appendChild(headingEl);
        } else if (q.type === 'question') {
          const itemEl = document.createElement('div');
          itemEl.className = 'question-item';

          const labelEl = document.createElement('label');
          labelEl.htmlFor = q.id;
          labelEl.textContent = q.text;

          const textareaEl = document.createElement('textarea');
          textareaEl.id = q.id;
          textareaEl.className = 'answer-box';
          textareaEl.placeholder = 'è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„å›ç­”...';
          textareaEl.value = answers.get(q.id) || '';

          itemEl.appendChild(labelEl);
          itemEl.appendChild(textareaEl);
          qsWrap.appendChild(itemEl);
        }
      });

      updateNavAndProgress();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateNavAndProgress() {
      btnPrev.hidden = currentSectionIndex === 0;
      btnNext.textContent = currentSectionIndex === SECTIONS.length - 1 ? 'å®Œæˆé—®å·' : 'ä¸‹ä¸€ä¸ªç‰ˆå—';

      const percent = ((currentSectionIndex + 1) / SECTIONS.length) * 100;
      bar.style.width = `${percent}%`;
      counter.textContent = `ç‰ˆå— ${currentSectionIndex + 1}/${SECTIONS.length}`;
    }

    function saveCurrentSectionAnswers() {
      if (!SECTIONS || currentSectionIndex >= SECTIONS.length) return;
      const section = SECTIONS[currentSectionIndex];
      section.questions.forEach(q => {
        if (q.type === 'question') {
          const textarea = document.getElementById(q.id);
          if (textarea) {
            answers.set(q.id, textarea.value);
          }
        }
      });
    }

    function showReportPage() {
      qsWrap.hidden = true;
      nav.hidden = true; // Hides "ä¸Šä¸€ä¸ªç‰ˆå—" and "å®Œæˆé—®å·" buttons
      report.style.display = 'block';

      let reportHTML = `<div class="intro-card" style="border-left:6px solid #dbe7ff">
            <h2 style="margin:0 0 6px 0">é—®å·å®Œæˆ</h2>
            <p>æ„Ÿè°¢æ‚¨çš„è€å¿ƒå¡«å†™ã€‚æ‚¨å¯ä»¥ä¿å­˜ç»“æœæˆ–è¿”å›ä¿®æ”¹ã€‚</p>
            <div class="cta">
                <button class="btn btn-primary" id="saveResult"><i class="fa fa-cloud-upload"></i> ä¸Šä¼ åˆ°æœåŠ¡å™¨</button>
                <button class="btn btn-ghost" id="editAnswers">ä¿®æ”¹å›ç­”</button>
            </div>
          </div>
          <div class="intro-card" style="margin-top:14px"><h3>å›ç­”æ€»è§ˆ</h3>`;

      SECTIONS.forEach(section => {
        reportHTML += `<h4 style="margin-top:16px; margin-bottom:8px;">${section.title}</h4>`;
        section.questions.forEach(q => {
          if (q.type === 'question') {
            const answer = answers.get(q.id) || '<i>æœªä½œç­”</i>';
            reportHTML += `<p><strong>${q.text}</strong><br>${answer.replace(/\n/g, '<br>')}</p>`;
          }
        });
      });

      reportHTML += '</div>';
      report.innerHTML = reportHTML;

      document.getElementById('saveResult').addEventListener('click', async () => {
        // æ”¶é›†åŸºæœ¬ä¿¡æ¯ - ä¼˜å…ˆä»localStorageè·å–å¼•å¯¼é¡µä¿¡æ¯
        let basicInfo = {
          name: '',
          birthdate: '',
          gender: '',
          school: '',
          teacher: '',
          parentPhone: '',
          parentWechat: '',
          parentEmail: ''
        };
        
        // ä»localStorageè·å–å¼•å¯¼é¡µåŸºæœ¬ä¿¡æ¯
        try {
          const savedInfo = localStorage.getItem('basicInfo');
          if (savedInfo) {
            const info = JSON.parse(savedInfo);
            basicInfo.name = info.name || '';
            basicInfo.birthdate = info.birthdate || '';
            basicInfo.gender = info.gender || '';
            basicInfo.gradeLevel = info.gradeLevel || '';
            basicInfo.parentPhone = info.parentPhone || '';
            basicInfo.parentWechat = info.parentWechat || '';
            basicInfo.parentEmail = info.parentEmail || '';
          }
        } catch (error) {
          console.warn('è·å–å¼•å¯¼é¡µåŸºæœ¬ä¿¡æ¯å¤±è´¥:', error);
        }
        
        // å¦‚æœlocalStorageä¸­æ²¡æœ‰ä¿¡æ¯ï¼Œåˆ™ä»é¡µé¢è¡¨å•è·å–
        if (!basicInfo.name) {
          basicInfo.name = document.getElementById('childName').value || '';
        }
        if (!basicInfo.birthdate) {
          basicInfo.birthdate = document.getElementById('dob').value || '';
        }
        if (!basicInfo.gender) {
          basicInfo.gender = document.getElementById('gender').value || '';
        }
        
        // å­¦æ ¡å’Œè€å¸ˆä¿¡æ¯ä»ä»é¡µé¢è¡¨å•è·å–
        basicInfo.school = document.getElementById('school').value || '';
        basicInfo.teacher = document.getElementById('teacher').value || '';

        // éªŒè¯åŸºæœ¬ä¿¡æ¯
        const validationErrors = [];
        if (!basicInfo.name.trim()) {
          validationErrors.push('è¯·å¡«å†™å­©å­å§“å');
        }
        if (!basicInfo.birthdate) {
          validationErrors.push('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ');
        }
        if (!basicInfo.gender) {
          validationErrors.push('è¯·é€‰æ‹©æ€§åˆ«');
        }
        if (!basicInfo.gradeLevel) {
          validationErrors.push('è¯·åœ¨å¼•å¯¼é¡µé€‰æ‹©å¹´çº§ä¿¡æ¯');
        }
        if (!basicInfo.school.trim()) {
          validationErrors.push('è¯·å¡«å†™å¹¼å„¿å›­/å­¦æ ¡åç§°');
        }
        if (!basicInfo.teacher.trim()) {
          validationErrors.push('è¯·å¡«å†™ä¸»è¦è´Ÿè´£çš„è€å¸ˆ');
        }

        if (validationErrors.length > 0) {
          alert('âŒ è¯·å®Œå–„ä»¥ä¸‹ä¿¡æ¯ï¼š\n' + validationErrors.join('\n'));
          return;
        }

        // æ„å»ºç¬¦åˆAPIæ ‡å‡†çš„é—®é¢˜æ•°æ®
        const questions = [];
        let questionIndex = 1;
        
        SECTIONS.forEach(section => {
          section.questions.forEach(q => {
            if (q.type === 'question') {
              const answer = answers.get(q.id) || '';
              if (answer.trim()) {  // åªåŒ…å«æœ‰ç­”æ¡ˆçš„é—®é¢˜
                questions.push({
                  id: questionIndex++,
                  type: 'text_input',
                  question: q.text,
                  answer: answer.trim()
                });
              }
            }
          });
        });

        // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç­”æ¡ˆ
        if (questions.length < 5) {
          alert('âŒ è¯·è‡³å°‘å›ç­”5ä¸ªé—®é¢˜åå†æäº¤');
          return;
        }

        // æ„å»ºç¬¦åˆAPIæ ‡å‡†çš„å®Œæ•´æ•°æ®å¯¹è±¡
        const dataToSubmit = {
          type: 'parent_interview',
          name: basicInfo.name.trim(),
          gender: basicInfo.gender,
          birthdate: basicInfo.birthdate,
          grade: basicInfo.gradeLevel, // å¹´çº§ä¿¡æ¯å­˜å‚¨åœ¨gradeå­—æ®µ
          school: basicInfo.school.trim(), // æ·»åŠ å­¦æ ¡å­—æ®µ
          teacher: basicInfo.teacher.trim(), // æ·»åŠ è€å¸ˆå­—æ®µ
          parent_phone: basicInfo.parentPhone || '',
          parent_wechat: basicInfo.parentWechat || '',
          parent_email: basicInfo.parentEmail || '',
          basic_info: {
            name: basicInfo.name.trim(),
            gender: basicInfo.gender,
            birth_date: basicInfo.birthdate,
            birthdate: basicInfo.birthdate,
            grade: basicInfo.gradeLevel,
            school: basicInfo.school.trim(),
            teacher: basicInfo.teacher.trim(), // æ·»åŠ è€å¸ˆå­—æ®µ
            parent_phone: basicInfo.parentPhone || '',
            parent_wechat: basicInfo.parentWechat || '',
            parent_email: basicInfo.parentEmail || ''
          },
          questions: questions,
          statistics: {
            total_score: questions.length,
            completion_rate: Math.round((questions.length / SECTIONS.reduce((total, section) => total + section.questions.filter(q => q.type === 'question').length, 0)) * 100),
            submission_time: new Date().toISOString()
          }
        };

        try {
          // å‘é€POSTè¯·æ±‚åˆ°åç«¯
          const response = await fetch(CONFIG.getApiUrl(CONFIG.API.SUBMIT), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dataToSubmit),
                    mode: 'cors',
                    credentials: 'include'
                });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              alert('âœ… æ•°æ®ä¿å­˜æˆåŠŸï¼\né—®å·ID: ' + (result.id || result.record_id));
              showFinalCompletionPage(result.id || result.record_id);
            } else {
              let errorMessage = result.error?.message || 'ä¿å­˜å¤±è´¥';
              if (result.error?.details && Array.isArray(result.error.details)) {
                errorMessage = 'æ•°æ®éªŒè¯å¤±è´¥ï¼š\n' + result.error.details.join('\n');
              }
              alert('âŒ ä¿å­˜å¤±è´¥ï¼š\n' + errorMessage);
            }
          } else {
            let errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status})`;
            try {
              const errorData = await response.json();
              if (errorData.error) {
                if (errorData.error.details && Array.isArray(errorData.error.details)) {
                  errorMessage = 'æ•°æ®éªŒè¯å¤±è´¥ï¼š\n' + errorData.error.details.join('\n');
                } else {
                  errorMessage = errorData.error.message || errorData.message || errorMessage;
                }
              }
            } catch (e) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            alert(`âŒ æ•°æ®ä¿å­˜å¤±è´¥:\n${errorMessage}`);
          }
        } catch (error) {
          console.error('æäº¤æ•°æ®æ—¶å‡ºé”™:', error);
          let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹æƒ…å†µï¼š\n\n';
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            errorMessage += 'âŒ ç½‘ç»œè¿æ¥é—®é¢˜ï¼š\n';
            errorMessage += '  â€¢ ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œï¼ˆè¿è¡Œ python app.pyï¼‰\n';
            errorMessage += '  â€¢ æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡® (127.0.0.1:5000)\n';
            errorMessage += '  â€¢ æ£€æŸ¥é˜²ç«å¢™è®¾ç½®\n\n';
          } else if (error.message.includes('CORS')) {
            errorMessage += 'âŒ CORSé…ç½®é—®é¢˜ï¼š\n';
            errorMessage += '  â€¢ åç«¯æœåŠ¡å™¨CORSé…ç½®å¯èƒ½æœ‰é—®é¢˜\n';
            errorMessage += '  â€¢ è¯·è”ç³»æŠ€æœ¯æ”¯æŒ\n\n';
          } else {
            errorMessage += `âŒ å…¶ä»–é”™è¯¯ï¼š${error.message}\n\n`;
          }
          
          errorMessage += 'ğŸ’¡ å»ºè®®ï¼š\n';
          errorMessage += '  â€¢ åˆ·æ–°é¡µé¢é‡è¯•\n';
          errorMessage += '  â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\n';
          errorMessage += '  â€¢ è”ç³»æŠ€æœ¯æ”¯æŒ';
          
          alert(errorMessage);
        }
      });

      // --- FIX START ---
      document.getElementById('editAnswers').addEventListener('click', () => {
        report.style.display = 'none';
        qsWrap.hidden = false;
        nav.hidden = false;
        // **å…³é”®ä¿®å¤**: å°†ç´¢å¼•é‡ç½®ä¸ºæœ€åä¸€ä¸ªæœ‰æ•ˆç‰ˆå—çš„ç´¢å¼•
        currentSectionIndex = SECTIONS.length - 1;
        renderSection();
      });
      // --- FIX END ---
    }

    // æ˜¾ç¤ºæœ€ç»ˆå®Œæˆé¡µé¢
    function showFinalCompletionPage(recordId) {
      // æ”¶é›†åŸºæœ¬ä¿¡æ¯
      const basicInfo = {
        name: document.getElementById('childName').value,
        birthdate: document.getElementById('dob').value,
        gender: document.getElementById('gender').value,
        school: document.getElementById('school').value,
        teacher: document.getElementById('teacher').value
      };

      // æ”¶é›†é—®å·ç­”æ¡ˆ
      const questionnaireData = {};
      SECTIONS.forEach(section => {
        section.questions.forEach(q => {
          if (q.type === 'question') {
            questionnaireData[q.id] = answers.get(q.id) || '';
          }
        });
      });

      // éšè—é—®å·åŒºåŸŸ
      document.querySelector('.container').style.display = 'none';

      // åˆ›å»ºå®Œæˆé¡µé¢
      const completionPage = document.createElement('div');
      completionPage.className = 'completion-page';
      completionPage.innerHTML = `
            <div class="completion-container">
                <div class="completion-header">
                    <h1><i class="fa fa-check-circle"></i> è®¿è°ˆå®Œæˆ</h1>
                    <p class="completion-subtitle">å®¶é•¿è®¿è°ˆè¡¨å·²æˆåŠŸä¿å­˜</p>
                </div>
                
                <div class="completion-info">
                    <div class="info-card">
                        <h3><i class="fa fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h3>
                        <div class="info-grid">
                            <div><strong>å„¿ç«¥å§“å:</strong> ${basicInfo.name}</div>
                            <div><strong>å‡ºç”Ÿæ—¥æœŸ:</strong> ${basicInfo.birthdate}</div>
                            <div><strong>æ€§åˆ«:</strong> ${basicInfo.gender}</div>
                            <div><strong>å­¦æ ¡:</strong> ${basicInfo.school}</div>
                            <div><strong>è€å¸ˆ:</strong> ${basicInfo.teacher}</div>
                            <div><strong>è®°å½•ID:</strong> ${recordId}</div>
                        </div>
                    </div>
                </div>
                
                <div class="completion-answers">
                    <h3><i class="fa fa-list-alt"></i> å›ç­”æ€»è§ˆ</h3>
                    ${generateAnswersHTML(basicInfo, questionnaireData)}
                </div>
                
                <div class="completion-actions">
                    <button class="btn-primary" onclick="window.location.reload()">
                        <i class="fa fa-refresh"></i> å¡«å†™æ–°è®¿è°ˆ
                    </button>
                    <button class="btn-secondary" onclick="window.print()">
                        <i class="fa fa-print"></i> æ‰“å°
                    </button>
                </div>
            </div>
        `;

      document.body.appendChild(completionPage);
    }

    // ç”Ÿæˆç­”æ¡ˆHTML
    function generateAnswersHTML(basicInfo, questionnaireData) {
      let html = '<div class="answers-list">';

      // éå†æ‰€æœ‰é—®é¢˜
      for (const [questionId, answer] of Object.entries(questionnaireData)) {
        if (answer) {
          // æŸ¥æ‰¾é—®é¢˜æ–‡æœ¬
          let questionText = questionId;
          SECTIONS.forEach(section => {
            section.questions.forEach(q => {
              if (q.id === questionId && q.type === 'question') {
                questionText = q.text;
              }
            });
          });

          html += `
                    <div class="answer-item">
                        <div class="answer-question">
                            <strong>${questionText}</strong>
                        </div>
                        <div class="answer-content">
                            ${answer || '<i>æœªä½œç­”</i>'}
                        </div>
                    </div>
                `;
        }
      }

      html += '</div>';
      return html;
    }

    // --- Helper Functions (for basic info form) ---
    // ä¸å†éœ€è¦updateDayså‡½æ•°å’ŒinitDatePickerså‡½æ•°ï¼Œå› ä¸ºä½¿ç”¨äº†åŸç”Ÿçš„dateè¾“å…¥ç±»å‹

    function calculateAge() {
      try {
        const dobInput = document.getElementById('dob');
        const ageInput = document.getElementById('age');
        
        if (!dobInput || !ageInput) return;
        
        const birthdate = new Date(dobInput.value);
        if (isNaN(birthdate.getTime())) {
          ageInput.value = '';
          return;
        }
        
        const today = new Date();
        let age = today.getFullYear() - birthdate.getFullYear();
        
        // æ£€æŸ¥æ˜¯å¦å·²è¿‡ä»Šå¹´çš„ç”Ÿæ—¥
        if (today.getMonth() < birthdate.getMonth() || 
            (today.getMonth() === birthdate.getMonth() && today.getDate() < birthdate.getDate())) {
          age--;
        }
        
        ageInput.value = age >= 0 ? `${age}å²` : '';
      } catch (error) {
        console.error('è®¡ç®—å¹´é¾„æ—¶å‘ç”Ÿé”™è¯¯:', error);
      }
    }

    function checkBasicForm() {
      const isFormValid = document.getElementById('basicForm').checkValidity();
      confirmBasicBtn.disabled = !isFormValid;
    }

    function saveBasicInfo() {
      const basicData = new FormData(document.getElementById('basicForm'));
      for (let [key, value] of basicData.entries()) {
        answers.set(`basic_${key}`, value);
      }
    }

    // --- è‡ªåŠ¨å¡«å……åŸºæœ¬ä¿¡æ¯ ---    
    function populateBasicInfo() {
      try {
        const savedInfo = localStorage.getItem('basicInfo');
        
        if (savedInfo) {
          const info = JSON.parse(savedInfo);
          
          // å¡«å……å§“åå­—æ®µ
          if (info.name) {
            const nameField = document.getElementById('childName');
            if (nameField) nameField.value = info.name;
          }
          
          // å¡«å……å‡ºç”Ÿæ—¥æœŸå­—æ®µ
          if (info.birthdate) {
            // éªŒè¯æ—¥æœŸæ ¼å¼
            const birthdate = new Date(info.birthdate);
            if (!isNaN(birthdate.getTime())) {
              const dobInput = document.getElementById('dob');
              if (dobInput) {
                // æ ¼å¼åŒ–ä¸ºYYYY-MM-DDæ ¼å¼ï¼Œè¿™æ˜¯dateè¾“å…¥ç±»å‹çš„æ ‡å‡†æ ¼å¼
                const formattedDate = birthdate.toISOString().split('T')[0];
                dobInput.value = formattedDate;
                
                // è®¡ç®—å¹´é¾„å¹¶æ£€æŸ¥è¡¨å•
                calculateAge();
                checkBasicForm();
              }
            } else {
              console.warn('å‡ºç”Ÿæ—¥æœŸæ ¼å¼æ— æ•ˆ:', info.birthdate);
            }
          }
          
          // å¡«å……æ€§åˆ«å­—æ®µ
          if (info.gender) {
            const genderSelect = document.getElementById('gender');
            if (genderSelect) {
              genderSelect.value = info.gender;
            }
          }
        }
      } catch (error) {
        console.error('è‡ªåŠ¨å¡«å……åŸºæœ¬ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
      }
    } 
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        init();
        populateBasicInfo();
    });
  </script>

</body>

</html>