<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问卷管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }

        .header h1 {
            color: #2c3e50;
            margin: 0;
        }

        .header p {
            color: #6c757d;
            margin: 5px 0 0 0;
        }

        .card {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }

        .card-body {
            padding: 20px;
            background-color: white;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 2px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            margin: 1px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
        }

        .text-center {
            text-align: center;
        }

        .text-danger {
            color: #dc3545;
        }

        .text-muted {
            color: #6c757d;
        }

        .pagination {
            display: flex;
            padding-left: 0;
            list-style: none;
            border-radius: 0.25rem;
        }

        .pagination li {
            margin: 0 2px;
        }

        .pagination .page-link {
            position: relative;
            display: block;
            padding: 0.5rem 0.75rem;
            margin-left: -1px;
            line-height: 1.25;
            color: #007bff;
            text-decoration: none;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .pagination .page-link:hover {
            z-index: 2;
            color: #0056b3;
            text-decoration: none;
            background-color: #e9ecef;
            border-color: #dee2e6;
        }

        .pagination .page-item.active .page-link {
            z-index: 3;
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }

        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            cursor: auto;
            background-color: #fff;
            border-color: #dee2e6;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover,
        .close:focus {
            opacity: 0.7;
        }

        .question-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .question-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .question-answer {
            margin-bottom: 8px;
            padding: 8px;
            background-color: white;
            border-radius: 3px;
            border-left: 3px solid #007bff;
        }

        .answer-label {
            font-weight: bold;
            color: #495057;
            margin-right: 10px;
        }

        .answer-value {
            color: #212529;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }

        .form-col-half {
            flex: 0 0 48%;
        }

        .textarea-large {
            min-height: 100px;
            resize: vertical;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>问卷管理系统</h1>
            <p>查看、修改和导出问卷评估结果</p>
            <div style="float: right; margin-top: -40px;">
                <button id="logoutBtn" class="btn btn-danger btn-sm">退出</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                问卷列表
            </div>
            <div class="card-body">
                <!-- 搜索区域 -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="searchInput" class="form-control" placeholder="搜索姓名、类型或年级..."
                            style="flex: 1; max-width: 300px;">
                        <button id="searchBtn" class="btn btn-primary">搜索</button>
                        <button id="clearSearchBtn" class="btn btn-secondary">清除</button>
                        <button id="refreshBtn" class="btn btn-success">刷新</button>
                        <button id="batchDeleteBtn" class="btn btn-danger">批量删除</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>ID</th>
                                <th>问卷类型</th>
                                <th>姓名</th>
                                <th>性别</th>
                                <th>出生日期</th>
                                    <th>家长手机</th>
                                <th>微信号</th>
                                <th>邮箱</th>
                                <th>提交时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="questionnaireTableBody">
                            <tr>
                                <td colspan="11" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页控件 -->
                <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span id="paginationInfo">显示第 1-20 条，共 0 条记录</span>
                    </div>
                    <div>
                        <nav>
                            <ul class="pagination" id="paginationControls" style="margin: 0;">
                                <!-- 分页按钮将通过JavaScript动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>查看问卷详情</h2>
                <button class="close" onclick="closeModal('viewModal')">&times;</button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>编辑问卷</h2>
                <button class="close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body" id="editModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">取消</button>
                <button class="btn btn-primary" onclick="saveQuestionnaire()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let totalRecords = 0;
        let questionnaires = []; // 存储问卷数据
        let currentFilters = {
            search: '',
            type: '',
            grade: '',
            date_from: '',
            date_to: '',
            sort_by: 'created_at',
            sort_order: 'desc'
        };

        // 辅助函数：获取问卷类型显示名称
        function getTypeDisplayName(type) {
            const typeMap = {
                'speech_habit': '说话习惯记录',
                'parent_interview': '家长访谈表',
                'student_report': '小学生报告表',
                'teen_interview': '青少年访谈表格',
                'adolescent_interview': '青少年访谈',
                'communication_rating': '小学生交流评定表',
                'sm_factors': '可能的SM维持因素清单',
                'sm_maintenance_factors': 'SM维持因素',
                'elementary_school_communication_assessment': '小学生交流评估',
                'frankfurt_scale_selective_mutism': 'Frankfurt Scale选择性缄默筛查量表'
            };
            return typeMap[type] || type;
        }

        // 通用API调用处理函数，自动处理会话过期
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                const result = await response.json();
                
                // 检查会话过期
                if (!result.success && result.error && result.error.code === 'SESSION_EXPIRED') {
                    alert('会话已过期，请重新登录');
                    window.location.href = '/login';
                    return null;
                }
                
                return result;
            } catch (error) {
                console.error('API调用失败:', error);
                throw error;
            }
        }

        // 加载问卷列表
        function loadQuestionnaires(page = currentPage) {
            const params = new URLSearchParams({
                page: page,
                limit: pageSize,
                ...currentFilters
            });

            // 移除空值参数
            for (let [key, value] of params.entries()) {
                if (!value) {
                    params.delete(key);
                }
            }

            const url = `/api/questionnaires?${params.toString()}`;

            apiCall(url)
                .then(result => {
                    if (!result) return; // 会话过期已处理
                    
                    const tableBody = document.getElementById('questionnaireTableBody');
                    tableBody.innerHTML = '';

                    if (!result.success) {
                        tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">加载失败: ' + (result.error?.message || '未知错误') + '</td></tr>';
                        return;
                    }

                    if (!result.data || result.data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">暂无数据</td></tr>';
                        updatePaginationInfo(0, 0, 0);
                        updatePaginationControls(1, 1);
                        questionnaires = []; // 清空数据
                        return;
                    }

                    // 保存问卷数据到全局变量
                    questionnaires = result.data;

                    // 更新分页状态
                    currentPage = result.pagination.page;
                    totalPages = result.pagination.pages;
                    totalRecords = result.pagination.total;

                    // 渲染表格数据
                    result.data.forEach(questionnaire => {
                        const row = document.createElement('tr');

                        // 提取基本信息
                        const basicInfo = questionnaire.data.basic_info || questionnaire.data.basicInfo || {};
                        const name = basicInfo.name || questionnaire.name || '未知';
                        const gender = questionnaire.gender || basicInfo.gender || questionnaire.data.gender || '未知';
                        const birthdate = questionnaire.birthdate || basicInfo.birthdate || basicInfo.birth_date || questionnaire.data.birthdate || questionnaire.data.birth_date || '未知';
                        
                        // 提取家长联系方式 - 从basic_info中读取
                        const parentPhone = basicInfo.parent_phone || questionnaire.parent_phone || '未填写';
                        const parentWechat = basicInfo.parent_wechat || questionnaire.parent_wechat || '未填写';
                        const parentEmail = basicInfo.parent_email || questionnaire.parent_email || '未填写';

                        // 构建操作按钮
                        let actionButtons = `<button class="btn btn-primary btn-sm" onclick="viewQuestionnaire(${questionnaire.id})">查看</button><button class="btn btn-warning btn-sm" onclick="editQuestionnaire(${questionnaire.id})">编辑</button><button class="btn btn-success btn-sm" onclick="exportQuestionnaire(${questionnaire.id})">导出</button>`;
                        
                        // 为Frankfurt Scale类型添加生成报告按钮
                        if (questionnaire.type === 'frankfurt_scale_selective_mutism') {
                            actionButtons += `<button class="btn btn-info btn-sm" onclick="generateFrankfurtReport(${questionnaire.id})">生成报告</button>`;
                        }
                        
                        // 为小学生交流评估添加计算结果按钮
                        if (questionnaire.type === 'elementary_school_communication_assessment') {
                            actionButtons += `<button class="btn btn-info btn-sm" onclick="showCommunicationResults(${questionnaire.id})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;"> 计算</button>`;
                        }
                        
                        actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteQuestionnaire(${questionnaire.id})">删除</button>`;
                        
                        row.innerHTML = `<td><input type="checkbox" class="questionnaire-checkbox" value="${questionnaire.id}"></td><td>${questionnaire.id}</td><td>${getTypeDisplayName(questionnaire.type)}</td><td>${name}</td><td>${gender}</td><td>${birthdate}</td><td>${parentPhone}</td><td>${parentWechat}</td><td>${parentEmail}</td><td>${questionnaire.created_at}</td><td>${actionButtons}</td>`;
                        tableBody.appendChild(row);
                    });

                    // 更新分页信息和控件
                    updatePaginationInfo(result.pagination.page, result.pagination.limit, result.pagination.total);
                    updatePaginationControls(result.pagination.page, result.pagination.pages);
                })
                .catch(error => {
                    console.error('加载问卷列表失败:', error);
                    const tableBody = document.getElementById('questionnaireTableBody');
                    tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">网络错误，请稍后重试</td></tr>';
                });
        }

        // 更新分页信息
        function updatePaginationInfo(page, limit, total) {
            const start = total > 0 ? (page - 1) * limit + 1 : 0;
            const end = Math.min(page * limit, total);
            const infoElement = document.getElementById('paginationInfo');
            if (infoElement) {
                infoElement.textContent = `显示第 ${start}-${end} 条，共 ${total} 条记录`;
            }
        }

        // 更新分页控件
        function updatePaginationControls(page, pages) {
            const paginationElement = document.getElementById('paginationControls');
            if (!paginationElement) return;

            paginationElement.innerHTML = '';

            if (pages <= 1) return;

            // 上一页按钮
            const prevItem = document.createElement('li');
            prevItem.className = `page-item ${page <= 1 ? 'disabled' : ''}`;
            prevItem.innerHTML = `<a class="page-link" onclick="goToPage(${page - 1})">上一页</a>`;
            paginationElement.appendChild(prevItem);

            // 页码按钮
            const maxVisiblePages = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(pages, startPage + maxVisiblePages - 1);

            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                pageItem.innerHTML = `<a class="page-link" onclick="goToPage(${i})">${i}</a>`;
                paginationElement.appendChild(pageItem);
            }

            // 下一页按钮
            const nextItem = document.createElement('li');
            nextItem.className = `page-item ${page >= pages ? 'disabled' : ''}`;
            nextItem.innerHTML = `<a class="page-link" onclick="goToPage(${page + 1})">下一页</a>`;
            paginationElement.appendChild(nextItem);
        }

        // 跳转到指定页面
        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                loadQuestionnaires(page);
            }
        }

        // 搜索功能
        function performSearch() {
            currentFilters.search = document.getElementById('searchInput').value.trim();
            currentPage = 1;
            loadQuestionnaires(1);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentFilters.search = '';
            currentPage = 1;
            loadQuestionnaires(1);
        }

        // 查看问卷详情
        function viewQuestionnaire(id) {
            console.log('正在获取问卷详情, ID:', id);

            apiCall(`/api/questionnaires/${id}`)
                .then(result => {
                    if (!result) return; // 会话过期已处理
                    console.log('API响应:', result);

                    if (result.success) {
                        console.log('问卷数据:', result.data);
                        showViewModal(result.data);
                    } else {
                        alert('获取问卷详情失败: ' + (result.error?.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取问卷详情失败:', error);
                    alert('网络错误，请稍后重试');
                });
        }

        // 编辑问卷
        function editQuestionnaire(id) {
            apiCall(`/api/questionnaires/${id}`)
                .then(result => {
                    if (!result) return; // 会话过期已处理
                    if (result.success) {
                        showEditModal(result.data);
                    } else {
                        alert('获取问卷详情失败: ' + (result.error?.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取问卷详情失败:', error);
                    alert('网络错误，请稍后重试');
                });
        }

        function exportQuestionnaire(id) {
            window.open(`/api/questionnaires/${id}/export`, '_blank');
        }

        function deleteQuestionnaire(id) {
            if (confirm('确定要删除这个问卷吗？此操作不可恢复。')) {
                apiCall(`/api/questionnaires/${id}`, {
                    method: 'DELETE'
                })
                    .then(result => {
                        if (!result) return; // 会话过期已处理
                        if (result.success) {
                            alert('删除成功');
                            loadQuestionnaires();
                        } else {
                            alert('删除失败: ' + (result.error?.message || '未知错误'));
                        }
                    })
                    .catch(error => {
                        console.error('删除失败:', error);
                        alert('删除失败，请稍后重试');
                    });
            }
        }

        // 批量删除功能
        document.getElementById('batchDeleteBtn').addEventListener('click', function () {
            const selectedIds = Array.from(document.querySelectorAll('.questionnaire-checkbox:checked')).map(cb => cb.value);

            if (selectedIds.length === 0) {
                alert('请至少选择一个问卷进行删除。');
                return;
            }

            if (confirm(`确定要删除选中的 ${selectedIds.length} 个问卷吗？此操作不可恢复。`)) {
                apiCall('/api/questionnaires/batch', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ids: selectedIds })
                })
                .then(result => {
                    if (!result) return; // 会话过期已处理
                    if (result.success) {
                        alert('批量删除成功');
                        loadQuestionnaires();
                    } else {
                        alert('批量删除失败: ' + (result.error?.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('批量删除失败:', error);
                    alert('批量删除失败，请稍后重试');
                });
            }
        });

        // 全选/取消全选
        document.getElementById('selectAllCheckbox').addEventListener('change', function (e) {
            const checkboxes = document.querySelectorAll('.questionnaire-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // 登出功能
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                fetch('/api/auth/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(error => {
                        console.error('退出登录失败:', error);
                        window.location.href = '/login';
                    });
            }
        }

        // Modal functions
        let currentEditingId = null;
        let currentQuestionnaire = null;

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'editModal') {
                currentEditingId = null;
                currentQuestionnaire = null;
            }
        }

        // 显示查看模态框
        function showViewModal(questionnaire) {
            console.log('显示查看模态框，问卷数据:', questionnaire);

            const modalBody = document.getElementById('viewModalBody');
            if (!modalBody) {
                console.error('找不到模态框主体元素');
                alert('界面错误：找不到模态框元素');
                return;
            }

            try {
                const content = renderQuestionnaireView(questionnaire);
                console.log('生成的HTML内容长度:', content.length);
                modalBody.innerHTML = content;
                showModal('viewModal');
            } catch (error) {
                console.error('渲染问卷视图时出错:', error);
                modalBody.innerHTML = `
                    <div class="question-group">
                        <div class="question-title">错误</div>
                        <div class="question-answer">
                            <span class="answer-label">渲染错误:</span>
                            <span class="answer-value">${error.message}</span>
                        </div>
                        <div class="question-answer">
                            <span class="answer-label">原始数据:</span>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap;">${JSON.stringify(questionnaire, null, 2)}</pre>
                        </div>
                    </div>
                `;
                showModal('viewModal');
            }
        }

        // 显示编辑模态框
        function showEditModal(questionnaire) {
            currentEditingId = questionnaire.id;
            currentQuestionnaire = questionnaire;
            const modalBody = document.getElementById('editModalBody');
            modalBody.innerHTML = renderQuestionnaireEdit(questionnaire);
            showModal('editModal');
        }

        // 渲染问卷查看视图
        function renderQuestionnaireView(questionnaire) {
            if (!questionnaire) {
                return '<p>错误: 问卷数据为空。</p>';
            }

            let html = '';
            const data = questionnaire.data || {};

            // 渲染基本信息
            html += '<div class="question-group">';
            html += '<div class="question-title">基本信息</div>';
            html += `<div class="question-answer"><span class="answer-label">问卷ID:</span> <span class="answer-value">${questionnaire.id || '未知'}</span></div>`;
            html += `<div class="question-answer"><span class="answer-label">问卷类型:</span> <span class="answer-value">${getTypeDisplayName(questionnaire.type || '未知')}</span></div>`;
            html += `<div class="question-answer"><span class="answer-label">提交时间:</span> <span class="answer-value">${questionnaire.created_at || '未知'}</span></div>`;
            html += '</div>';

            // 渲染个人信息
            if (data.basic_info) {
                html += '<div class="question-group">';
                html += '<div class="question-title">个人信息</div>';
                for (const [key, value] of Object.entries(data.basic_info)) {
                    // 为家长访谈表跳过school和teacher字段，避免重复显示
                    if (questionnaire.type === 'parent_interview' && (key === 'school' || key === 'teacher')) {
                        continue;
                    }
                    
                    // 只有SM维持因素问卷才显示填写人和关系字段
                    const smTypes = ['sm_factors', 'sm_maintenance_factors', '可能的sm维持因素清单'];
                    if ((key === 'filler_name' || key === 'relationship') && !smTypes.includes(questionnaire.type)) {
                        continue;
                    }
                    
                    html += `<div class="question-answer"><span class="answer-label">${getFieldLabel(key)}:</span> <span class="answer-value">${value || '未填写'}</span></div>`;
                }
                
                // 为家长访谈表添加学校和老师信息
                if (questionnaire.type === 'parent_interview') {
                    const school = questionnaire.school || data.basic_info.school || data.basicInfo?.school || '未填写';
                    const teacher = questionnaire.teacher || data.basic_info.teacher || data.basicInfo?.teacher || '未填写';
                    html += `<div class="question-answer"><span class="answer-label">学校/幼儿园:</span> <span class="answer-value">${school}</span></div>`;
                    html += `<div class="question-answer"><span class="answer-label">负责老师:</span> <span class="answer-value">${teacher}</span></div>`;
                }
                
                html += '</div>';
            }

            // 查找问题数组
            let questions = [];
            if (Array.isArray(data)) {
                questions = data;
            } else if (Array.isArray(data.questions)) {
                questions = data.questions;
            } else if (Array.isArray(data.data)) {
                questions = data.data;
            } else if (Array.isArray(data.detailedData)) {
                questions = data.detailedData;
            }

            // 渲染问题
            if (questions.length > 0) {
                html += '<div class="question-group">';
                html += '<div class="question-title">问卷内容</div>';
                questions.forEach((q, index) => {
                    let questionText = q.question || q.question_text || q.questionText || q.text || `问题 ${index + 1}`;
                    
                    // 特殊处理小学生报告表的问题文本
                    if (questionnaire.type === '小学生报告') {
                        // 尝试从问题ID映射获取完整问题文本
                        const questionId = parseInt(questionText) || parseInt(q.question) || parseInt(q.id);
                        if (questionId && elementaryReportQuestions[questionId]) {
                            questionText = elementaryReportQuestions[questionId];
                        }
                        
                        // 将问题文本中的[N]替换为儿童姓名
                        const childName = data.basic_info?.name || data.basic_info?.childName || questionnaire.name || '儿童';
                        questionText = questionText.replace(/\[N\]/g, childName);
                    }
                    
                    // 特殊处理SM维持因素问卷的频率和情境问题合并显示
                    const smTypes = ['sm_factors', 'sm_maintenance_factors', '可能的sm维持因素清单'];
                    if (smTypes.includes(questionnaire.type)) {
                        // 检查是否是频率问题
                        if (questionText.includes('- 发生频率')) {
                            const baseQuestion = questionText.replace(' - 发生频率', '');
                            // 查找对应的情境问题
                            const contextQuestionIndex = questions.findIndex((cq, ci) => 
                                ci > index && (cq.question || cq.question_text || cq.questionText || cq.text || '').includes(baseQuestion + ' - 情境或案例')
                            );
                            
                            if (contextQuestionIndex !== -1) {
                                const contextQuestion = questions[contextQuestionIndex];
                                
                                // 合并显示频率和情境问题
                                html += `<div class="question-answer" style="margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 15px;">`;
                                html += `<p><strong>${baseQuestion}</strong></p>`;
                                
                                // 显示频率部分
                                html += `<div style="margin-left: 10px; margin-bottom: 10px;">`;
                                html += `<p style="margin-bottom: 5px;"><em>- 发生频率</em></p>`;
                                if (Array.isArray(q.options)) {
                                    html += '<ul style="margin-left: 15px;">';
                                    q.options.forEach(option => {
                                        const hasAnswer = q.selected && (Array.isArray(q.selected) ? q.selected.length > 0 : q.selected !== null && q.selected !== undefined && q.selected !== '');
                                        if (hasAnswer) {
                                            const isSelected = Array.isArray(q.selected) && q.selected.includes(option.value);
                                            html += `<li>${option.text} ${isSelected ? '<strong>(已选择)</strong>' : ''}</li>`;
                                        } else {
                                            html += `<li>${option.text}</li>`;
                                        }
                                    });
                                    html += '</ul>';
                                }
                                html += `</div>`;
                                
                                // 显示情境部分
                                html += `<div style="margin-left: 10px;">`;
                                html += `<p style="margin-bottom: 5px;"><em>- 情境或案例</em></p>`;
                                const contextAnswer = contextQuestion.answer || contextQuestion.selected || contextQuestion.value || '未填写';
                                html += `<p style="margin-left: 15px;">答案: ${contextAnswer}</p>`;
                                html += `</div>`;
                                
                                html += `</div>`;
                                
                                // 标记情境问题已处理，跳过后续渲染
                                questions[contextQuestionIndex]._processed = true;
                                return; // 跳过正常的问题渲染流程
                            }
                        }
                        
                        // 如果是情境问题且已被处理，跳过
                        if (questionText.includes('- 情境或案例') && q._processed) {
                            return;
                        }
                    }
                    
                    html += `<div class="question-answer" style="margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 15px;">`;
                    html += `<p><strong>${questionText}</strong></p>`;

                    if (Array.isArray(q.options)) {
                        html += '<ul>';
                        q.options.forEach(option => {
                            // 检查是否有答案
                            const hasAnswer = q.selected && (Array.isArray(q.selected) ? q.selected.length > 0 : q.selected !== null && q.selected !== undefined && q.selected !== '');
                            
                            if (hasAnswer) {
                                // 有答案时显示选中状态
                                const isSelected = Array.isArray(q.selected) && q.selected.includes(option.value);
                                html += `<li>${option.text} ${isSelected ? '<strong>(已选择)</strong>' : ''}</li>`;
                            } else {
                                // 未作答时显示所有选项但不选中
                                html += `<li>${option.text}</li>`;
                            }
                        });
                        html += '</ul>';
                    } else if (q.type === 'rating_scale') {
                        // 处理评分量表类型 - 显示为单选按钮形式
                        if (q.scales && Array.isArray(q.scales)) {
                            // 多维度评分量表（如DSA能力问题）
                            html += '<div style="margin-top: 15px;">';
                            q.scales.forEach((scale, scaleIndex) => {
                                const scaleKey = scale.key;
                                const scaleLabel = scale.label;
                                const selectedValue = q.selected && q.selected[scaleKey];
                                
                                html += `<div style="margin-bottom: 20px;">`;
                                html += `<p style="font-weight: bold; margin-bottom: 10px;">${scaleLabel}</p>`;
                                
                                if (q.options && Array.isArray(q.options)) {
                                    html += '<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-left: 20px;">';
                                    q.options.forEach((option, optIndex) => {
                                        const isSelected = selectedValue == option.value;
                                        const radioId = `view_q${questions.indexOf(q)}_scale${scaleIndex}_opt${optIndex}`;
                                        
                                        html += '<div style="display: flex; align-items: center; margin-right: 20px;">';
                                        html += `<input type="radio" id="${radioId}" name="view_q${questions.indexOf(q)}_scale${scaleIndex}" value="${option.value}" ${isSelected ? 'checked' : ''} disabled style="margin-right: 8px; cursor: not-allowed;" />`;
                                        html += `<label for="${radioId}" style="font-weight: normal; cursor: not-allowed; color: ${isSelected ? '#007bff' : '#6c757d'};">${option.text}</label>`;
                                        html += '</div>';
                                    });
                                    html += '</div>';
                                } else {
                                    html += `<p style="color: #999; font-style: italic; margin-left: 20px;">未选择</p>`;
                                }
                                
                                html += '</div>';
                            });
                            html += '</div>';
                        } else {
                            // 单维度评分量表
                            const rating = q.rating || q.selected || 0;
                            html += '<div style="margin-top: 15px;">';
                            
                            if (q.options && Array.isArray(q.options)) {
                                html += '<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-left: 20px;">';
                                q.options.forEach((option, optIndex) => {
                                    const isSelected = rating == option.value;
                                    const radioId = `view_q${questions.indexOf(q)}_opt${optIndex}`;
                                    
                                    html += '<div style="display: flex; align-items: center; margin-right: 20px;">';
                                    html += `<input type="radio" id="${radioId}" name="view_q${questions.indexOf(q)}" value="${option.value}" ${isSelected ? 'checked' : ''} disabled style="margin-right: 8px; cursor: not-allowed;" />`;
                                    html += `<label for="${radioId}" style="font-weight: normal; cursor: not-allowed; color: ${isSelected ? '#007bff' : '#6c757d'};">${option.text}</label>`;
                                    html += '</div>';
                                });
                                html += '</div>';
                            } else {
                                const scaleLabels = q.scale_labels || ['非常低', '低于平均', '平均', '优于平均', '非常好'];
                                if (scaleLabels && scaleLabels.length > 0) {
                                    const labelIndex = Math.round(rating - 1);
                                    const label = scaleLabels[labelIndex] || scaleLabels[scaleLabels.length - 1];
                                    html += `<p><strong>评价:</strong> ${label}</p>`;
                                }
                            }
                            
                            html += '</div>';
                        }
                    } else {
                        const answer = q.selected_texts || q.answer;
                        if (answer && answer.trim && answer.trim() !== '') {
                            html += `<p><strong>答案:</strong> ${Array.isArray(answer) ? answer.join(', ') : answer}</p>`;
                        } else if (answer && !answer.trim) {
                            html += `<p><strong>答案:</strong> ${Array.isArray(answer) ? answer.join(', ') : answer}</p>`;
                        } else {
                            // 未作答的填空题显示'未填写'
                            html += `<p><strong>答案:</strong> <span style="color: #999; font-style: italic;">未填写</span></p>`;
                        }
                    }
                    html += '</div>';
                });
                html += '</div>';
            }

            // 如果是特定类型的问卷，并且有报告图片，则显示图片
            if (questionnaire.type === 'frankfurt_scale_selective_mutism' && data.report_image_path) {
                html += `
                    <div class="question-group">
                        <div class="question-title">报告图片</div>
                        <div class="question-answer">
                            <img src="{{ url_for('static', filename='') }}reports/${data.report_image_path}" alt="报告图片" style="max-width: 100%; height: auto; border-radius: 5px;">
                        </div>
                    </div>
                `;
            }

            // 如果是小学生交流评估，显示计算结果
            if (questionnaire.type === 'elementary_school_communication_assessment') {
                const calculation = calculateCommunicationResults(questionnaire);
                if (calculation) {
                    html += renderCalculationResults(calculation);
                }
            }

            // 如果是说话习惯记录，使用特殊的显示格式
            if (questionnaire.type === 'speech_habit') {
                return renderSpeechHabitResults(questionnaire);
            }

            return html;
        }

        // 渲染问卷编辑表单
        function renderQuestionnaireEdit(questionnaire) {
            let html = `<form id="editForm">`;
            const data = questionnaire.data || {};

            // 渲染基本信息（与查看页面格式一致）
            html += '<div class="question-group">';
            html += '<div class="question-title">基本信息</div>';
            html += `<div class="question-answer"><span class="answer-label">问卷ID:</span> <span class="answer-value">${questionnaire.id || '未知'}</span></div>`;
            html += `<div class="question-answer"><span class="answer-label">问卷类型:</span> <span class="answer-value">${getTypeDisplayName(questionnaire.type || '未知')}</span></div>`;
            html += `<div class="question-answer"><span class="answer-label">提交时间:</span> <span class="answer-value">${questionnaire.created_at || '未知'}</span></div>`;
            html += '</div>';

            // 渲染个人信息编辑（与查看页面格式一致，但可编辑）
            if (data.basic_info) {
                html += '<div class="question-group">';
                html += '<div class="question-title">个人信息</div>';
                for (const [key, value] of Object.entries(data.basic_info)) {
                    const label = getFieldLabel(key);
                    html += `<div class="question-answer">`;
                    html += `<span class="answer-label">${label}:</span> `;
                    html += `<input type="text" name="basic_info.${key}" class="form-control" style="display: inline-block; width: auto; margin-left: 10px;" value="${value || ''}" />`;
                    html += `</div>`;
                }
                
                // 为家长访谈表添加学校和老师信息编辑
                if (questionnaire.type === 'parent_interview') {
                    const school = questionnaire.school || data.basic_info.school || data.basicInfo?.school || '';
                    const teacher = questionnaire.teacher || data.basic_info.teacher || data.basicInfo?.teacher || '';
                    html += `<div class="question-answer">`;
                    html += `<span class="answer-label">学校/幼儿园:</span> `;
                    html += `<input type="text" name="school" class="form-control" style="display: inline-block; width: auto; margin-left: 10px;" value="${school}" />`;
                    html += `</div>`;
                    html += `<div class="question-answer">`;
                    html += `<span class="answer-label">负责老师:</span> `;
                    html += `<input type="text" name="teacher" class="form-control" style="display: inline-block; width: auto; margin-left: 10px;" value="${teacher}" />`;
                    html += `</div>`;
                }
                
                html += '</div>';
            }

            // 说话习惯记录的特殊处理
            if (questionnaire.type === 'speech_habit') {
                html += renderSpeechHabitEditTable(questionnaire);
                html += `</form>`;
                return html;
            }

            // 查找问题数组（与查看页面逻辑一致）
            let questions = [];
            if (Array.isArray(data)) {
                questions = data;
            } else if (Array.isArray(data.questions)) {
                questions = data.questions;
            } else if (Array.isArray(data.data)) {
                questions = data.data;
            } else if (Array.isArray(data.detailedData)) {
                questions = data.detailedData;
            }

            // 渲染问题编辑（与查看页面格式一致，但答案可编辑）
            if (questions.length > 0) {
                html += '<div class="question-group">';
                html += '<div class="question-title">问卷内容</div>';
                html += '<p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">注意：问题内容无法修改，只能修改答案</p>';
                
                questions.forEach((q, index) => {
                    let questionText = q.question || q.question_text || q.questionText || q.text || `问题 ${index + 1}`;
                    
                    // 特殊处理小学生报告表的问题文本
                    if (questionnaire.type === '小学生报告') {
                        // 尝试从问题ID映射获取完整问题文本
                        const questionId = parseInt(questionText) || parseInt(q.question) || parseInt(q.id);
                        if (questionId && elementaryReportQuestions[questionId]) {
                            questionText = elementaryReportQuestions[questionId];
                        }
                        
                        // 将问题文本中的[N]替换为儿童姓名
                        const childName = data.basic_info?.name || data.basic_info?.childName || questionnaire.name || '儿童';
                        questionText = questionText.replace(/\[N\]/g, childName);
                    }
                    
                    html += `<div class="question-answer" style="margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 15px;">`;
                    html += `<p><strong>${questionText}</strong></p>`;

                    if (Array.isArray(q.options)) {
                        // 选择题：根据问题类型设置为单选或多选
                        // 判断逻辑：
                        // 1. 优先使用 allow_multiple 字段
                        // 2. 如果没有设置，则根据选项特征判断：
                        //    - 选项只有2个且为"是/否"类型 -> 单选
                        //    - 选项超过2个 -> 可能是多选
                        //    - 已选择多个答案 -> 多选
                        let isMultipleChoice = false;
                        
                        // 优先根据问题类型判断
                        if (q.type === 'single_choice') {
                            isMultipleChoice = false;
                        } else if (q.type === 'multiple_choice') {
                            isMultipleChoice = true;
                        } else if (q.allow_multiple !== undefined) {
                            // 有明确设置
                            isMultipleChoice = q.allow_multiple === true;
                        } else {
                            // 根据选项特征自动判断
                            const optionTexts = q.options.map(opt => opt.text.toLowerCase());
                            const isYesNoType = q.options.length === 2 && 
                                (optionTexts.includes('是') || optionTexts.includes('否') || 
                                 optionTexts.some(text => text.includes('是')) || optionTexts.some(text => text.includes('否')));
                            
                            if (isYesNoType) {
                                // 是/否类型题目默认为单选
                                isMultipleChoice = false;
                            } else if (Array.isArray(q.selected) && q.selected.length > 1) {
                                // 已选择多个答案，判断为多选
                                isMultipleChoice = true;
                            } else if (q.options.length > 3) {
                                // 选项较多，可能是多选题
                                isMultipleChoice = true;
                            } else {
                                // 默认为单选
                                isMultipleChoice = false;
                            }
                        }
                        
                        const inputType = isMultipleChoice ? 'checkbox' : 'radio';
                        const inputName = isMultipleChoice ? `questions.${index}.selected_options` : `questions.${index}.selected_single`;
                        
                        console.log(`问题${index}: 类型=${isMultipleChoice ? '多选' : '单选'}, 选项数=${q.options.length}, 已选择=${q.selected?.length || 0}, allow_multiple=${q.allow_multiple}`);
                        
                        html += `<div style="margin-top: 10px;">`;
                        
                        // 选择类型切换功能已移除
                        
                        html += `<label style="font-weight: normal; color: #495057; display: block; margin-bottom: 8px;">重新选择答案：</label>`;
                        html += `<div id="answer_options_${index}">`;
                        
                        q.options.forEach((option, optIndex) => {
                            const isSelected = Array.isArray(q.selected) && q.selected.includes(option.value);
                            const checkboxId = `q${index}_opt${optIndex}`;
                            
                            html += `<div style="margin-bottom: 5px;">`;
                            if (isMultipleChoice) {
                                html += `<input type="checkbox" id="${checkboxId}" name="${inputName}" value="${option.value}" ${isSelected ? 'checked' : ''} onchange="updateSelectedAnswers(${index})" style="margin-right: 8px;" />`;
                            } else {
                                html += `<input type="radio" id="${checkboxId}" name="${inputName}" value="${option.value}" ${isSelected ? 'checked' : ''} onchange="updateSelectedAnswers(${index})" style="margin-right: 8px;" />`;
                            }
                            html += `<label for="${checkboxId}" style="font-weight: normal; cursor: pointer;">${option.text}</label>`;
                            html += `</div>`;
                        });
                        
                        // 隐藏的输入框存储最终选择的值
                        const selectedValue = Array.isArray(q.selected) ? q.selected.join(', ') : (q.selected || '');
                        html += `<input type="hidden" name="questions.${index}.selected" id="selected_${index}" value="${selectedValue}" />`;
                        html += `<input type="hidden" name="questions.${index}.allow_multiple" id="allow_multiple_${index}" value="${isMultipleChoice}" />`;
                        html += `</div>`; // 结束 answer_options div
                        html += `</div>`; // 结束主容器 div
                    } else if (q.type === 'rating_scale') {
                        // 评分量表类型：显示为单选按钮形式，可重新评分
                        html += `<div style="margin-top: 15px;">`;
                        
                        // 检查是否有多个量表维度（如问题501的DSA能力问题）
                        if (q.scales && Array.isArray(q.scales) && q.scales.length > 1) {
                            html += `<p><strong>当前评分:</strong></p>`;
                            html += `<div style="margin-left: 20px;">`;
                            
                            q.scales.forEach((scale, scaleIndex) => {
                                const scaleKey = scale.key;
                                const currentRating = q.selected && q.selected[scaleKey] ? q.selected[scaleKey] : (q.ratings && q.ratings[scaleIndex] !== undefined ? q.ratings[scaleIndex] : '');
                                
                                html += `<div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa;">`;
                                html += `<p style="font-weight: bold; margin-bottom: 15px; color: #495057;">${scale.label}</p>`;
                                
                                if (q.options && Array.isArray(q.options)) {
                                    html += '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
                                    q.options.forEach((option, optIndex) => {
                                        const isSelected = currentRating == option.value;
                                        const radioId = `edit_q${index}_scale${scaleIndex}_opt${optIndex}`;
                                        const radioName = `questions.${index}.selected.${scaleKey}`;
                                        
                                        html += '<div style="display: flex; align-items: center; margin-right: 20px; margin-bottom: 8px;">';
                                        html += `<input type="radio" id="${radioId}" name="${radioName}" value="${option.value}" ${isSelected ? 'checked' : ''} style="margin-right: 8px; cursor: pointer;" />`;
                                        html += `<label for="${radioId}" style="font-weight: normal; cursor: pointer; color: #495057;">${option.text}</label>`;
                                        html += '</div>';
                                    });
                                    html += '</div>';
                                }
                                
                                html += `</div>`;
                            });
                            
                            html += `</div>`;
                        } else {
                            // 单维度评分量表
                            const currentRating = q.rating !== undefined ? q.rating : (q.selected !== undefined ? q.selected : '');
                            
                            html += `<div style="padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa;">`;
                            html += `<p style="font-weight: bold; margin-bottom: 15px; color: #495057;">重新评分：</p>`;
                            
                            // 如果有options则使用，否则为rating_scale生成默认的1-5分选项
                            let options = q.options;
                            if (!options || !Array.isArray(options) || options.length === 0) {
                                // 为rating_scale问题生成默认选项
                                const ratingLabels = ['非常低', '低于平均', '平均', '优于平均', '非常好'];
                                options = [];
                                for (let i = 1; i <= 5; i++) {
                                    options.push({
                                        value: i,
                                        text: ratingLabels[i-1]
                                    });
                                }
                            }
                            
                            html += '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
                            options.forEach((option, optIndex) => {
                                const isSelected = currentRating == option.value;
                                const radioId = `edit_q${index}_opt${optIndex}`;
                                const radioName = `questions.${index}.rating`;
                                
                                html += '<div style="display: flex; align-items: center; margin-right: 20px; margin-bottom: 8px;">';
                                html += `<input type="radio" id="${radioId}" name="${radioName}" value="${option.value}" ${isSelected ? 'checked' : ''} style="margin-right: 8px; cursor: pointer;" />`;
                                html += `<label for="${radioId}" style="font-weight: normal; cursor: pointer; color: #495057;">${option.text}</label>`;
                                html += '</div>';
                            });
                            html += '</div>';
                            
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                    } else {
                        // 填空题：显示当前答案，可重新填写
                        const answer = q.selected_texts || q.answer || q.selectedText || '';
                        html += `<div style="margin-top: 10px;">`;
                        html += `<p><strong>当前答案:</strong> ${Array.isArray(answer) ? answer.join(', ') : answer}</p>`;
                        html += `<label style="font-weight: normal; color: #495057;">重新填写答案：</label>`;
                        
                        if (typeof answer === 'string' && answer.length > 50) {
                            html += `<textarea name="questions.${index}.answer" class="form-control" placeholder="请重新填写答案内容" style="margin-top: 5px;">${answer}</textarea>`;
                        } else {
                            html += `<input type="text" name="questions.${index}.answer" class="form-control" value="${Array.isArray(answer) ? answer.join(', ') : answer}" placeholder="请重新填写答案" style="margin-top: 5px;" />`;
                        }
                        html += `</div>`;
                    }
                    
                    // 如果有评分，显示评分编辑
                    if (q.score !== undefined) {
                        html += `<div style="margin-top: 10px;">`;
                        html += `<label style="font-weight: normal; color: #495057;">重新评分：</label>`;
                        html += `<input type="number" name="questions.${index}.score" class="form-control" value="${q.score}" min="0" max="4" placeholder="0-4分" style="margin-top: 5px; width: 100px;" />`;
                        html += `</div>`;
                    }
                    
                    // 如果有说话能力评估
                    if (q.speechIssue !== undefined) {
                        html += `<div style="margin-top: 10px;">`;
                        html += `<label style="font-weight: normal; color: #495057;">`;
                        html += `<input type="checkbox" name="questions.${index}.speechIssue" ${q.speechIssue ? 'checked' : ''} /> 说话能力评估`;
                        html += `</label></div>`;
                    }
                    
                    html += '</div>';
                });
                html += '</div>';
            }

            // 处理嵌套的questions数据结构（如果存在且不重复）
            if (questionnaire.data.questions && typeof questionnaire.data.questions === 'object' && !Array.isArray(questionnaire.data.questions) && questions.length === 0) {
                Object.entries(questionnaire.data.questions).forEach(([sectionKey, section]) => {
                    if (typeof section === 'object' && section !== null) {
                        html += '<div class="question-group">';
                        html += `<div class="question-title">${getSectionTitle(sectionKey)}</div>`;
                        html += '<p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">注意：问题内容无法修改，只能修改答案</p>';

                        Object.entries(section).forEach(([questionKey, answer]) => {
                            const questionText = getQuestionText(sectionKey, questionKey);
                            const fieldName = `questions.${sectionKey}.${questionKey}`;

                            html += `<div class="question-answer" style="margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 15px;">`;
                            html += `<p><strong>${questionText}</strong></p>`;
                            
                            html += `<div style="margin-top: 10px;">`;
                            html += `<p><strong>当前答案:</strong> ${answer || ''}</p>`;
                            html += `<label style="font-weight: normal; color: #495057;">重新填写答案：</label>`;
                            
                            // 根据答案类型提供不同的编辑方式
                            if (typeof answer === 'string' && answer.length > 50) {
                                // 填空题 - 使用文本域
                                html += `<textarea name="${fieldName}" class="form-control" placeholder="请重新填写答案内容" style="margin-top: 5px;">${answer || ''}</textarea>`;
                            } else {
                                // 选择题或短答案 - 使用输入框
                                html += `<input type="text" name="${fieldName}" class="form-control" value="${answer || ''}" placeholder="请重新选择或填写答案" style="margin-top: 5px;" />`;
                            }
                            html += `</div>`;
                            html += '</div>';
                        });
                        html += '</div>';
                    }
                });
            }

            // 如果是小学生交流评估，显示计算结果
            if (questionnaire.type === 'elementary_school_communication_assessment') {
                const calculation = calculateCommunicationResults(questionnaire);
                if (calculation) {
                    html += renderCalculationResults(calculation);
                }
            }

            html += `</form>`;
            return html;
        }

        // 更新选择的答案
        function updateSelectedAnswers(questionIndex) {
            const isMultipleChoice = document.querySelector(`input[name="questions.${questionIndex}.selected_options"]`) !== null;
            const hiddenInput = document.getElementById(`selected_${questionIndex}`);
            
            if (isMultipleChoice) {
                // 多选题：收集所有选中的复选框值
                const checkboxes = document.querySelectorAll(`input[name="questions.${questionIndex}.selected_options"]:checked`);
                const selectedValues = Array.from(checkboxes).map(cb => {
                    // 确保值为数字类型（如果可以转换）
                    const numValue = parseInt(cb.value);
                    return isNaN(numValue) ? cb.value : numValue;
                });
                hiddenInput.value = selectedValues.join(', ');
            } else {
                // 单选题：获取选中的单选框值
                const radio = document.querySelector(`input[name="questions.${questionIndex}.selected_single"]:checked`);
                if (radio) {
                    // 确保值为数字类型（如果可以转换）
                    const numValue = parseInt(radio.value);
                    hiddenInput.value = isNaN(numValue) ? radio.value : numValue;
                } else {
                    hiddenInput.value = '';
                }
            }
            
            console.log(`问题${questionIndex}选择更新:`, hiddenInput.value);
        }
        
        // 切换选择类型（单选/多选）
        function toggleChoiceType(questionIndex, choiceType) {
            console.log(`切换问题${questionIndex}的选择类型为: ${choiceType}`);
            
            const isMultiple = choiceType === 'multiple';
            
            // 更新allow_multiple隐藏字段
            const allowMultipleInput = document.getElementById(`allow_multiple_${questionIndex}`);
            if (allowMultipleInput) {
                allowMultipleInput.value = isMultiple;
            }
            
            // 重新生成选项界面
            regenerateAnswerOptions(questionIndex, isMultiple);
        }
        
        // 重新生成答案选项界面
        function regenerateAnswerOptions(questionIndex, isMultiple) {
            const container = document.getElementById(`answer_options_${questionIndex}`);
            if (!container) return;
            
            // 获取当前问题数据
            const questionData = currentQuestionnaire.questions[questionIndex];
            if (!questionData || !questionData.options) return;
            
            const inputType = isMultiple ? 'checkbox' : 'radio';
            const inputName = isMultiple ? `questions.${questionIndex}.selected_options` : `questions.${questionIndex}.selected_single`;
            
            let html = '';
            questionData.options.forEach((option, optIndex) => {
                const isSelected = Array.isArray(questionData.selected) && questionData.selected.includes(option.value);
                const checkboxId = `q${questionIndex}_opt${optIndex}`;
                
                html += `<div style="margin-bottom: 5px;">`;
                html += `<input type="${inputType}" id="${checkboxId}" name="${inputName}" value="${option.value}" ${isSelected ? 'checked' : ''} onchange="updateSelectedAnswers(${questionIndex})" style="margin-right: 8px;" />`;
                html += `<label for="${checkboxId}" style="font-weight: normal; cursor: pointer;">${option.text}</label>`;
                html += `</div>`;
            });
            
            container.innerHTML = html;
            
            // 更新选择值
            updateSelectedAnswers(questionIndex);
        }
        
        // 保存问卷修改
        function saveQuestionnaire() {
            if (!currentEditingId) return;

            const form = document.getElementById('editForm');
            
            // 说话习惯记录的特殊处理
            if (currentQuestionnaire && currentQuestionnaire.type === 'speech_habit') {
                saveSpeechHabitQuestionnaire();
                return;
            }
            
            const formData = new FormData(form);

            // 构建增量更新数据 - 只包含改动的字段
            const updateData = {
                basic_info: {},
                questions: []
            };

            let hasChanges = false;
            
            // 处理表单数据，只收集有值的字段
            for (let [name, value] of formData.entries()) {
                const parts = name.split('.');
                
                if (parts[0] === 'basic_info' && value.trim() !== '') {
                    updateData.basic_info[parts[1]] = value;
                    hasChanges = true;
                } else if (parts[0] === 'questions') {
                    const index = parseInt(parts[1]);
                    const field = parts[2];
                    
                    // 确保数组有足够的元素
                    while (updateData.questions.length <= index) {
                        updateData.questions.push({});
                    }
                    
                    if (field === 'selected' && value.trim() !== '') {
                        // 处理选择题答案 - 转换为数组格式
                        const selectedValues = value.split(', ').filter(v => v.trim());
                        updateData.questions[index].selected = selectedValues.map(v => {
                            // 尝试转换为数字，如果失败则保持原值
                            const numValue = parseInt(v);
                            return isNaN(numValue) ? v : numValue;
                        });
                        hasChanges = true;
                        console.log(`问题${index}选中答案:`, updateData.questions[index].selected);
                    } else if (field === 'answer' && value.trim() !== '') {
                        // 处理填空题答案
                        updateData.questions[index].answer = value;
                        updateData.questions[index].selected_texts = value;
                        updateData.questions[index].selectedText = value;
                        hasChanges = true;
                    } else if (field === 'allow_multiple') {
                        // 处理选择类型设置
                        updateData.questions[index].allow_multiple = value === 'true';
                        hasChanges = true;
                        console.log(`设置问题${index}的allow_multiple为:`, updateData.questions[index].allow_multiple);
                    } else if (field === 'score' && value.trim() !== '') {
                        updateData.questions[index].score = parseInt(value) || 0;
                        hasChanges = true;
                    } else if (field === 'speechIssue') {
                        updateData.questions[index].speechIssue = true;
                        hasChanges = true;
                    } else if (value.trim() !== '') {
                        updateData.questions[index][field] = value;
                        hasChanges = true;
                    }
                } else if (parts.length >= 3 && parts[0] === 'questions' && !isNaN(parseInt(parts[1])) && value.trim() !== '') {
                    // 处理嵌套的questions结构 questions.sectionKey.questionKey
                    const sectionKey = parts[1];
                    const questionKey = parts[2];
                    
                    if (!updateData.questions[sectionKey]) {
                        updateData.questions[sectionKey] = {};
                    }
                    updateData.questions[sectionKey][questionKey] = value;
                    hasChanges = true;
                }
            }

            // 处理未选中的checkbox（表示清空选择）
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked && checkbox.name.includes('speechIssue')) {
                    const parts = checkbox.name.split('.');
                    const index = parseInt(parts[1]);
                    
                    // 确保数组有足够的元素
                    while (updateData.questions.length <= index) {
                        updateData.questions.push({});
                    }
                    
                    updateData.questions[index].speechIssue = false;
                    hasChanges = true;
                }
            });
            
            // 清理空对象
            updateData.questions = updateData.questions.filter(q => q && Object.keys(q).length > 0);
            
            if (Object.keys(updateData.basic_info).length === 0) {
                delete updateData.basic_info;
            }
            
            if (updateData.questions.length === 0) {
                delete updateData.questions;
            }

            if (!hasChanges) {
                alert('没有检测到任何更改');
                return;
            }
            
            console.log('=== 详细调试信息 ===');
            console.log('发送的增量更新数据:', JSON.stringify(updateData, null, 2));
            if (updateData.questions) {
                console.log('questions数组长度:', updateData.questions.length);
                console.log('questions是否为数组:', Array.isArray(updateData.questions));
                updateData.questions.forEach((q, index) => {
                    console.log(`问题${index}:`, JSON.stringify(q, null, 2));
                });
            }
            if (updateData.basic_info) {
                console.log('basic_info内容:', updateData.basic_info);
            }

            // 发送更新请求
            apiCall(`/api/questionnaires/${currentEditingId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
                .then(result => {
                    if (!result) return; // 会话过期已处理
                    console.log('=== 服务器响应内容 ===');
                    console.log('完整响应:', JSON.stringify(result, null, 2));
                    if (result.success) {
                        alert('保存成功');
                        
                        // 如果是小学生交流评估，重新计算并显示结果
                        if (currentQuestionnaire && currentQuestionnaire.type === 'elementary_school_communication_assessment') {
                            // 更新当前问卷数据
                            if (result.data) {
                                currentQuestionnaire = result.data;
                            }
                            
                            // 重新渲染编辑页面以显示更新后的计算结果
                            const editContent = document.getElementById('editContent');
                            if (editContent) {
                                editContent.innerHTML = renderQuestionnaireEdit(currentQuestionnaire);
                            }
                        }
                        
                        closeModal('editModal');
                        loadQuestionnaires(); // 刷新列表
                    } else {
                        console.error('=== 保存失败详细信息 ===');
                        console.error('错误对象:', result.error);
                        if (result.error && result.error.details) {
                            console.error('验证错误详情:', result.error.details);
                            result.error.details.forEach((detail, index) => {
                                console.error(`验证错误${index + 1}:`, detail);
                            });
                        }
                        alert('保存失败: ' + (result.error?.message || result.message || '数据验证失败'));
                    }
                })
                .catch(error => {
                    console.error('=== 网络错误 ===');
                    console.error('错误对象:', error);
                    console.error('错误堆栈:', error.stack);
                    alert('网络错误，请稍后重试');
                });
        }

        // 辅助函数
        function getFieldLabel(key) {
            const labelMap = {
                'name': '姓名',
                'gender': '性别',
                'age': '年龄',
                'grade': '年级',
                'basic_info_grade': '年级',
                'birthdate': '出生日期',
                'birth_date': '出生日期',
                'school': '学校',
                'school_name': '学校名称',
                'admission_date': '入学日期',
                'address': '地址',
                'filler_name': '填表人姓名',
                'fill_date': '填表日期',
                'class': '班级',
                'submission_date': '提交日期',
                'evaluator': '评估者',
                'relationship': '与孩子关系',
                'evaluation_date': '评估日期',
                'parent_phone': '家长电话',
                'parent_wechat': '家长微信',
                'parent_email': '家长邮箱',
                'fillerName': '清单填写人姓名',
                'relationshipOrPosition': '你与孩子的关系或你的职位'
            };
            return labelMap[key] || key;
        }

        function getSectionTitle(sectionKey) {
            const titleMap = {
                'section1': '第一部分',
                'section2': '第二部分',
                'section3': '第三部分',
                'section4': '第四部分',
                'section5': '第五部分',
                'basic_questions': '基础问题',
                'detailed_questions': '详细问题',
                'assessment': '评估',
                'communication': '交流评估',
                'behavior': '行为评估',
                'questions': '问题详情',
                'summary': '总结信息',
                'scores': '评分结果'
            };
            return titleMap[sectionKey] || sectionKey.replace(/_/g, ' ');
        }

        // 小学生报告表的问题映射
        const elementaryReportQuestions = {
            101: '孩子就读过的学校以及就读时间',
            102: '是否有任何关于[N]过去就读学校的记录或报告',
            201: '目前,你对[N]是否有担忧?担忧什么?',
            202: '这些问题在学校首次引起注意是什么时候?',
            301: '[N] 在学校说话的程度如何?',
            302: '如果[N]对任何人说话,他的言语和语言中是否有困难或不成熟的迹象?',
            303: '当不说话但需要说些什么的时候,[N]是如何沟通的?',
            304: '在课堂上,[N]看起来在听课吗?有眼神交流吗?',
            305: '如果[N]想要什么,会如何得到它?',
            306: '当[N]需要说话(例如要求拼写、报告疾病或报告被嘲笑)时,你会做什么?',
            307: '回应点名的情况如何?与其他孩子相比,[N]回应点名情况怎么样?',
            308: '你如何评估[N]的阅读能力?',
            309: '在课堂围坐时间,情况是怎样的?',
            310: '孩子如厕情况如何?',
            311: '[N] 是否会主动进行一般性沟通,例如提问、发表评论、寻求帮助或报告疾病?',
            312: '你为改善[N]的沟通做了怎样的尝试?',
            313: '[N]在本学年的沟通情况有没有变化?',
            401: '你会怎么形容[N]?',
            402: '[N]有任何特别的恐惧、痴迷的事物或习惯吗?',
            403: '你认为[N] 曾被戏弄或欺负过吗?[N]怎么让你知道的?',
            404: '[N] 和谁打成一片或坐在一起?',
            405: '[N] 是会和其他小朋友一起玩,还是看着他们玩?在哪些情境下[N]会和别人一起玩?',
            406: '[N]与你以及其他老师和成人相处得如何?',
            501: '请在下面的图表上勾出你对[N]能力的看法。',
            502: '如果可以的话,请提供任何阅读和拼写测试的详细信息及成绩。',
            503: '请就[N]在各个学科领域的表现做出评论,指出其强项和弱项、特殊才能和兴趣,以及对学习的总体态度。',
            504: '[N]参加任何俱乐部或课外活动吗?',
            601: '学校的特殊教育需求协调员在多大程度上参与了[N] 在学校的教育工作?',
            602: '[N]的特殊教育需求是否经过正式鉴定?',
            603: '如果没有正式的教育目标,你觉得哪些目标适合[N]?',
            604: '[N]在读写、语言、学习或校内外行为方面是否得到过任何额外的帮助?',
            605: '教育心理学家是否知道你的担忧?',
            606: '[N]进行过心理测试吗?',
            607: '[N] 在校外是否还接受过其他评估,例如言语和语言评估或专业治疗?',
            701: '[N] 有没有兄弟姐妹在学校就读?他们在学校的表现如何?',
            801: '学校员工和[N]的父母对[N]有一样的担忧吗?',
            901: '你和其他主要工作人员对沉默或不愿说话的孩子有什么相关的经验,或受过什么样的培训?',
            902: '你觉得我们怎样做能够支持你?'
        };

        // 小学生交流评定表的问题映射
        const communicationQuestions = {
            'q1': '在家里和亲密的家人交谈',
            'q2': '在商店或餐厅与你的亲密家人交谈,其他人可能会听到',
            'q3': '在家里和其他亲戚说话',
            'q4': '和陌生人说话',
            'q5': '独自和班主任交谈',
            'q6': '在班上其他孩子面前和班主任交谈',
            'q7': '在学校与其他老师或成年人交谈',
            'q8': '在课堂上举手提问',
            'q9': '参加课堂讨论(提出自己的意见或想法)',
            'q10': '回答出勤点名',
            'q11': '加入课堂围坐时间的活动',
            'q12': '询问是否可以上厕所',
            'q13': '在不确定该怎么做时寻求帮助',
            'q14': '独自给班主任朗读',
            'q15': '在课堂前大声朗读',
            'q16': '接近其他孩子,与他们说话和交朋友',
            'q17': '如果其他孩子和你说话,你会回答他们',
            'q18': '告诉其他孩子,他们让你感到很烦',
            'q19': '在学校和朋友交谈',
            'q20': '在学校和一群孩子交谈',
            'q21': '在学校和不太熟悉的孩子交谈',
            'q22': '在学校和其他班级的孩子交谈',
            'q23': '在学校和年龄较大的孩子交谈',
            'q24': '在学校和年龄较小的孩子交谈'
        };

        function getQuestionText(sectionKey, questionKey) {
            // 特殊问题键的映射
            const specialQuestions = {
                'allow_multiple_choice': '允许多选',
                'max_speak': '最大发言',
                'option_count': '选项数量',
                'is_multiple_choice': '是否多选题',
                'speech_issue': '言语问题',
                'selected_option': '选择的选项',
                'score': '评分',
                'total_score': '总分',
                'average_score': '平均分'
            };

            // 如果有特殊映射，使用特殊映射
            if (specialQuestions[questionKey]) {
                return specialQuestions[questionKey];
            }

            // 如果是交流评定表的问题
            if (communicationQuestions[questionKey]) {
                return communicationQuestions[questionKey];
            }

            // 如果questionKey包含问题编号，尝试提取
            const match = questionKey.match(/q(\d+)/);
            if (match) {
                const qNum = match[1];
                return communicationQuestions[`q${qNum}`] || `问题 ${qNum}`;
            }

            // 默认格式化
            return questionKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatAnswer(answer) {
            if (Array.isArray(answer)) {
                return answer.join(', ');
            }
            if (typeof answer === 'object' && answer !== null) {
                // 如果是评分对象，特殊处理
                if (answer.score !== undefined) {
                    let result = `评分: ${answer.score}`;
                    if (answer.scoreText) {
                        result += ` (${answer.scoreText})`;
                    }
                    if (answer.speechIssue !== undefined) {
                        result += `, 说话能力: ${answer.speechIssue ? '是' : '否'}`;
                    }
                    return result;
                }
                return JSON.stringify(answer, null, 2);
            }
            return answer || '未填写';
        }

        // 计算小学生交流评估结果
        function calculateCommunicationResults(questionnaire) {
            if (!questionnaire || questionnaire.type !== 'elementary_school_communication_assessment') {
                return null;
            }

            const data = questionnaire.data || {};
            let questions = [];
            
            // 查找问题数组
            if (Array.isArray(data)) {
                questions = data;
            } else if (Array.isArray(data.questions)) {
                questions = data.questions;
            } else if (Array.isArray(data.data)) {
                questions = data.data;
            } else if (Array.isArray(data.detailedData)) {
                questions = data.detailedData;
            }

            if (questions.length === 0) {
                return null;
            }

            let totalScore = 0;
            let answeredQuestions = 0;
            let speechCount = 0;
            const results = [];

            questions.forEach((q, index) => {
                const questionNumber = index + 1;
                const questionText = q.question || q.question_text || q.questionText || communicationQuestions[`q${questionNumber}`] || `问题 ${questionNumber}`;
                
                let selectedOption = null;
                let selectedText = '未选择';
                let canSpeak = false;

                // 处理选择的选项
                if (q.selected !== undefined && q.selected !== null) {
                    selectedOption = parseInt(q.selected);
                } else if (q.selectedOption !== undefined && q.selectedOption !== null) {
                    selectedOption = parseInt(q.selectedOption);
                } else if (q.selected_option !== undefined && q.selected_option !== null) {
                    selectedOption = parseInt(q.selected_option);
                } else if (q.score !== undefined && q.score !== null) {
                    selectedOption = parseInt(q.score);
                }

                // 处理说话能力
                if (q.can_speak !== undefined) {
                    canSpeak = q.can_speak;
                } else if (q.canSpeak !== undefined) {
                    canSpeak = q.canSpeak;
                } else if (q.speechIssue !== undefined) {
                    canSpeak = !q.speechIssue;
                }

                // 获取选项文本
                if (selectedOption !== null) {
                    const optionTexts = ['非常容易', '相当容易', '有点困难', '困难', '非常困难'];
                    selectedText = `${selectedOption} = ${optionTexts[selectedOption] || '未知'}`;
                    totalScore += selectedOption;
                    answeredQuestions++;
                }

                if (canSpeak) {
                    speechCount++;
                }

                results.push({
                    questionNumber,
                    questionText,
                    selectedOption,
                    selectedText,
                    canSpeak,
                    canSpeakText: canSpeak ? '可以说话' : '不能说话'
                });
            });

            const averageScore = answeredQuestions > 0 ? (totalScore / answeredQuestions).toFixed(2) : 0;

            // 创建详细答案数组
            const detailedAnswers = questions.map((q, index) => {
                const questionNumber = index + 1;
                const questionText = q.question || q.question_text || q.questionText || communicationQuestions[`q${questionNumber}`] || `问题 ${questionNumber}`;
                
                let selectedOption = null;
                let canSpeak = false;

                // 处理选择的选项
                if (q.selected !== undefined && q.selected !== null) {
                    selectedOption = parseInt(q.selected);
                } else if (q.selectedOption !== undefined && q.selectedOption !== null) {
                    selectedOption = parseInt(q.selectedOption);
                } else if (q.selected_option !== undefined && q.selected_option !== null) {
                    selectedOption = parseInt(q.selected_option);
                } else if (q.score !== undefined && q.score !== null) {
                    selectedOption = parseInt(q.score);
                }

                // 处理说话能力
                if (q.can_speak !== undefined) {
                    canSpeak = q.can_speak;
                } else if (q.canSpeak !== undefined) {
                    canSpeak = q.canSpeak;
                } else if (q.speechIssue !== undefined) {
                    canSpeak = !q.speechIssue;
                }

                // 所有选项
                const allOptions = [
                    { value: 0, text: '非常容易' },
                    { value: 1, text: '相当容易' },
                    { value: 2, text: '有点困难' },
                    { value: 3, text: '困难' },
                    { value: 4, text: '非常困难' }
                ];

                // 获取选项文本
                let selectedText = '未选择';
                if (selectedOption !== null) {
                    const optionTexts = ['非常容易', '相当容易', '有点困难', '困难', '非常困难'];
                    selectedText = optionTexts[selectedOption] || '未知';
                }

                return {
                    questionNumber,
                    questionText,
                    selectedOption,
                    selectedText,
                    canSpeak,
                    options: allOptions.map(opt => ({
                        ...opt,
                        selected: opt.value === selectedOption
                    }))
                };
            });

            return {
                totalScore,
                averageScore,
                answeredQuestions,
                speechCount,
                totalQuestions: questions.length,
                results,
                detailedAnswers
            };
        }

        // 渲染计算结果HTML
        function renderCalculationResults(calculation) {
            if (!calculation) {
                return '';
            }

            return `
                <div class="question-group" style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 20px;">
                    <div class="question-title" style="color: #495057; margin-bottom: 15px;">
                        <i class="fas fa-calculator" style="margin-right: 8px;"></i>计算结果
                    </div>
                    <div class="summary-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-item" style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <strong style="color: #007bff;">总分数:</strong> ${calculation.totalScore}分
                        </div>
                        <div class="stat-item" style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <strong style="color: #28a745;">平均分:</strong> ${calculation.averageScore}分
                        </div>
                        <div class="stat-item" style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <strong style="color: #17a2b8;">可以说话:</strong> ${calculation.speechCount}个
                        </div>
                        <div class="stat-item" style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <strong style="color: #6c757d;">总问题数:</strong> ${calculation.totalQuestions}个
                        </div>
                    </div>
                </div>
            `;
        }

        // 渲染选项显示
        function renderOptions(options, selectedValue) {
            if (!options || !Array.isArray(options)) return '';
            
            let html = '<div style="margin-top: 5px; font-size: 12px; color: #666;">';
            html += '<div style="margin-bottom: 3px;">所有选项:</div>';
            
            options.forEach(option => {
                const isSelected = option.value === selectedValue;
                html += `<div style="margin-left: 10px;">`;
                html += `<span style="color: ${isSelected ? '#28a745' : '#999'};">${isSelected ? '✓' : '・'}</span> `;
                html += `<span>${option.value} = ${option.text}</span>`;
                html += `</div>`;
            });
            
            html += '</div>';
            return html;
        }

        // 显示小学生交流评估计算结果
        function showCommunicationResults(questionnaireId) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 计算中...';
            button.disabled = true;

            // 获取问卷数据
            apiCall(`/api/questionnaires/${questionnaireId}`)
            .then(result => {
                if (!result) return; // 会话过期已处理
                if (result.success) {
                    const questionnaire = result.data;
                    if (questionnaire.type === 'elementary_school_communication_assessment') {
                        // 计算结果
                        const calculationResults = calculateCommunicationResults(questionnaire);
                        // 显示结果弹窗
                        showCommunicationResultsModal(calculationResults, questionnaire);
                    } else {
                        alert('该问卷不是小学生交流评估类型');
                    }
                } else {
                    alert('获取问卷数据失败: ' + (result.error?.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('获取问卷数据失败:', error);
                alert('网络错误，请稍后重试');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        // 显示小学生交流评估计算结果模态框
        function showCommunicationResultsModal(results, questionnaire) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 600px;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;

            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 20px;
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: #999;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            // 获取基本信息
            const basicInfo = questionnaire.basic_info || {};
            const name = basicInfo.name || questionnaire.name || '未知';
            const gender = basicInfo.gender || questionnaire.gender || '未知';
            const grade = basicInfo.grade || questionnaire.grade || '未知';
            const date = questionnaire.created_at ? new Date(questionnaire.created_at).toLocaleDateString('zh-CN') : '未知';

            // 添加结果内容
            const resultContent = document.createElement('div');
            resultContent.innerHTML = `
                <style>
                    .communication-results {
                        font-family: 'Microsoft YaHei', Arial, sans-serif;
                    }
                    .communication-results .header {
                        text-align: center;
                        margin-bottom: 30px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #e9ecef;
                    }
                    .communication-results .header h2 {
                        color: #2c3e50;
                        margin: 0 0 10px 0;
                        font-size: 24px;
                    }
                    .communication-results .header .subtitle {
                        color: #6c757d;
                        font-size: 14px;
                    }
                    .communication-results .basic-info {
                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                        padding: 20px;
                        border-radius: 8px;
                        margin-bottom: 25px;
                    }
                    .communication-results .basic-info h3 {
                        color: #495057;
                        margin: 0 0 15px 0;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                    }
                    .communication-results .basic-info h3::before {
                        content: '👤';
                        margin-right: 8px;
                    }
                    .communication-results .info-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                        gap: 10px;
                    }
                    .communication-results .info-item {
                        display: flex;
                        flex-direction: column;
                    }
                    .communication-results .info-label {
                        font-size: 12px;
                        color: #6c757d;
                        margin-bottom: 2px;
                    }
                    .communication-results .info-value {
                        font-weight: bold;
                        color: #495057;
                    }
                    .communication-results .results-summary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 25px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                    }
                    .communication-results .results-summary h3 {
                        margin: 0 0 20px 0;
                        font-size: 18px;
                        text-align: center;
                    }
                    .communication-results .score-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 15px;
                    }
                    .communication-results .score-item {
                        background: rgba(255,255,255,0.1);
                        padding: 15px;
                        border-radius: 8px;
                        text-align: center;
                        backdrop-filter: blur(10px);
                    }
                    .communication-results .score-label {
                        font-size: 12px;
                        opacity: 0.9;
                        margin-bottom: 5px;
                    }
                    .communication-results .score-value {
                        font-size: 20px;
                        font-weight: bold;
                    }
                    .communication-results .completion-answers {
                        margin-top: 20px;
                    }
                    .communication-results .completion-answers h3 {
                        color: #495057;
                        margin-bottom: 15px;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                    }
                    .communication-results .completion-answers h3 i {
                        margin-right: 8px;
                    }
                    .communication-results .answers-grid {
                        display: grid;
                        gap: 15px;
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .communication-results .answer-item {
                        background: #f8f9fa;
                        border: 1px solid #e9ecef;
                        border-radius: 8px;
                        padding: 15px;
                    }
                    .communication-results .question-header {
                        display: flex;
                        align-items: flex-start;
                        margin-bottom: 10px;
                    }
                    .communication-results .q-number {
                        background: #007bff;
                        color: white;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        font-weight: bold;
                        margin-right: 10px;
                        flex-shrink: 0;
                    }
                    .communication-results .q-text {
                        font-weight: 500;
                        color: #495057;
                        line-height: 1.4;
                    }
                    .communication-results .answer-details {
                        margin-left: 34px;
                    }
                    .communication-results .score-info,
                    .communication-results .speech-info {
                        margin-bottom: 8px;
                        font-size: 14px;
                    }
                    .communication-results .speech-status {
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: bold;
                    }
                    .communication-results .speech-status.can-speak {
                        background: #d4edda;
                        color: #155724;
                    }
                    .communication-results .speech-status.cannot-speak {
                        background: #f8d7da;
                        color: #721c24;
                    }
                    .communication-results .all-options {
                        margin-top: 10px;
                    }
                    .communication-results .all-options ul {
                        list-style: none;
                        padding: 0;
                        margin: 5px 0 0 0;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 5px;
                    }
                    .communication-results .all-options li {
                        background: #e9ecef;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        color: #6c757d;
                    }
                    .communication-results .all-options li.selected {
                        background: #28a745;
                        color: white;
                        font-weight: bold;
                    }
                    .communication-results .footer {
                        text-align: center;
                        margin-top: 25px;
                        padding-top: 20px;
                        border-top: 1px solid #e9ecef;
                        color: #6c757d;
                        font-size: 12px;
                    }
                </style>
                <div class="communication-results">
                    <div class="header">
                        <h2>✅ 问卷完成</h2>
                        <div class="subtitle">小学生交流评估已成功保存</div>
                    </div>
                    
                    <div class="basic-info">
                        <h3>基本信息</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">姓名:</div>
                                <div class="info-value">${name}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">年级:</div>
                                <div class="info-value">${grade}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">日期:</div>
                                <div class="info-value">${date}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">记录ID:</div>
                                <div class="info-value">${questionnaire.id}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-summary">
                        <h3>📊 回答总览</h3>
                        <div class="score-grid">
                            <div class="score-item">
                                <div class="score-label">总分数</div>
                                <div class="score-value">${results.totalScore}分</div>
                            </div>
                            <div class="score-item">
                                <div class="score-label">平均分</div>
                                <div class="score-value">${results.averageScore}分</div>
                            </div>
                            <div class="score-item">
                                <div class="score-label">可以说话的问题</div>
                                <div class="score-value">${results.speechCount}个</div>
                            </div>
                            <div class="score-item">
                                <div class="score-label">总问题数</div>
                                <div class="score-value">${results.totalQuestions}个</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="completion-answers">
                        <h3><i class="fa fa-list-alt"></i> 详细答案</h3>
                        <div class="answers-grid">
                            ${results.detailedAnswers && Array.isArray(results.detailedAnswers) ? results.detailedAnswers.map(item => `
                                <div class="answer-item">
                                    <div class="question-header">
                                        <div class="q-number">${item.questionNumber || '?'}</div>
                                        <div class="q-text">${item.questionText || '未知问题'}</div>
                                    </div>
                                    <div class="answer-details">
                                        <div class="score-info">
                                            <strong>评分:</strong> ${item.selectedOption === null ? '未选择 - 0 = 非常容易' : `${item.selectedOption} = ${item.selectedText}`}
                                        </div>
                                        <div class="speech-info">
                                            <strong>说话能力:</strong> 
                                            <span class="speech-status ${item.canSpeak ? 'can-speak' : 'cannot-speak'}">
                                                ${item.canSpeak ? '可以说话' : '不能说话'}
                                            </span>
                                        </div>
                                        <div class="all-options">
                                            <strong>所有选项:</strong>
                                            <ul>
                                                ${item.options ? item.options.map(opt =>
                    `<li class="${opt.selected ? 'selected' : ''}">${opt.value}=${opt.text}</li>`
                ).join('') : ''}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p>暂无详细数据</p>'}
                        </div>
                    </div>
                    
                    <div class="footer">
                        计算结果生成时间: ${new Date().toLocaleString('zh-CN')}
                    </div>
                </div>
            `;

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(resultContent);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // 点击模态框外部关闭
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // 生成Frankfurt报告
        function generateFrankfurtReport(questionnaireId) {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '生成中...';
            button.disabled = true;

            apiCall(`/api/generate_frankfurt_report`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ questionnaire_id: questionnaireId })
            })
            .then(result => {
                if (!result) return; // 会话过期已处理
                if (result.success) {
                    // 显示报告内容
                    showFrankfurtReport(result.data);
                } else {
                    alert('报告生成失败: ' + (result.error?.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('生成报告失败:', error);
                alert('网络错误，请稍后重试');
            })
            .finally(() => {
                button.textContent = originalText;
                button.disabled = false;
            });
        }

        // 显示Frankfurt报告
        function showFrankfurtReport(reportData) {
            // 创建报告模态框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
            `;

            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #999;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            // 添加报告内容
            const reportContent = document.createElement('div');
            reportContent.innerHTML = `
                <style>
                    .frankfurt-report h2 { color: #2c3e50; margin-bottom: 20px; }
                    .frankfurt-report h3 { color: #34495e; margin: 15px 0 10px 0; }
                    .frankfurt-report .basic-info, .frankfurt-report .scores-summary, 
                    .frankfurt-report .risk-assessment, .frankfurt-report .interventions, 
                    .frankfurt-report .exposure-hierarchy { 
                        margin-bottom: 20px; 
                        padding: 15px; 
                        border: 1px solid #ddd; 
                        border-radius: 5px; 
                    }
                    .frankfurt-report .basic-info { background-color: #f8f9fa; }
                    .frankfurt-report .scores-summary { background-color: #e3f2fd; }
                    .frankfurt-report .risk-assessment { background-color: #fff3e0; }
                    .frankfurt-report .interventions { background-color: #f1f8e9; }
                    .frankfurt-report .exposure-hierarchy { background-color: #fce4ec; }
                    .frankfurt-report p { margin: 5px 0; }
                    .frankfurt-report ul { margin: 10px 0; padding-left: 20px; }
                    .frankfurt-report li { margin: 5px 0; }
                </style>
                ${reportData.report_html}
                <div style="margin-top: 20px; text-align: center; color: #666; font-size: 12px;">
                    报告生成时间: ${new Date(reportData.generated_at).toLocaleString('zh-CN')}
                </div>
            `;

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(reportContent);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // 点击模态框外部关闭
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // 生成报告数据
        function generateReportData(data) {
            const reportData = {
                ds_score: 0,
                ss_score: 0,
                total_score: 0,
                risk_level: '低风险',
                interventions: [],
                exposure_hierarchy: []
            };

            // 计算DS和SS得分
            if (data.questions) {
                data.questions.forEach(q => {
                    const score = parseInt(q.answer) || 0;
                    if (q.question.includes('DS')) {
                        reportData.ds_score += score;
                    } else if (q.question.includes('SS')) {
                        reportData.ss_score += score;
                    }
                });
            }

            reportData.total_score = reportData.ds_score + reportData.ss_score;

            // 判断风险等级
            if (reportData.total_score >= 30) {
                reportData.risk_level = '高风险';
            } else if (reportData.total_score >= 15) {
                reportData.risk_level = '中等风险';
            }

            // 生成干预建议
            reportData.interventions = generateInterventions(reportData);

            // 生成暴露层次
            reportData.exposure_hierarchy = generateExposureHierarchy(reportData);

            return reportData;
        }

        // 生成干预建议
        function generateInterventions(reportData) {
            const interventions = [];

            if (reportData.risk_level === '高风险') {
                interventions.push('建议寻求专业心理治疗师的帮助');
                interventions.push('考虑认知行为疗法(CBT)治疗');
                interventions.push('家庭治疗可能会有帮助');
            } else if (reportData.risk_level === '中等风险') {
                interventions.push('建议学校心理咨询师介入');
                interventions.push('家长和教师需要密切配合');
                interventions.push('逐步暴露疗法可能有效');
            } else {
                interventions.push('继续观察和支持');
                interventions.push('创造积极的交流环境');
                interventions.push('鼓励孩子表达自己');
            }

            return interventions;
        }

        // 渲染说话习惯记录结果
        function renderSpeechHabitResults(questionnaire) {
            let html = '';
            
            // 从API返回的数据结构中获取实际数据
            const data = questionnaire.data || questionnaire;
            
            // 基本信息部分
            const personalInfo = data.basic_info || data.personal_info || {};
            const name = personalInfo.name || '未填写';
            const age = personalInfo.age || '未填写';
            const birthdate = personalInfo.birthdate || '未填写';
            const gender = personalInfo.gender || '未填写';
            const date = questionnaire.created_at ? new Date(questionnaire.created_at).toLocaleDateString() : '未知';
            
            html += `
                <div class="completion-container" style="margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 10px;">
                    <h2 style="color: #0f766e; margin-bottom: 20px;">说话习惯记录详情</h2>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="color: #475569; margin-bottom: 10px;">基本信息</h3>
                        <p><strong>姓名:</strong> ${name}</p>
                        <p><strong>年龄:</strong> ${age}</p>
                        <p><strong>日期:</strong> ${date}</p>
                        <p><strong>出生日期:</strong> ${birthdate}</p>
                        <p><strong>性别:</strong> ${gender}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="color: #475569; margin-bottom: 15px;">说话习惯记录</h3>
                        ${generateSpeechHabitAnswersHTML(data.questions)}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // 生成说话习惯记录答案HTML
        function generateSpeechHabitAnswersHTML(questions) {
            if (!questions || !Array.isArray(questions)) return '<p>暂无答案数据</p>';
            
            let html = '';
            
            // 定义问题ID到中文描述的映射
            const questionMap = {
                'family_alone_active': '家人-独处-主动发言',
                'family_alone_passive': '家人-独处-被动回应',
                'family_with_others_active': '家人-与其他人一起-主动发言',
                'family_with_others_passive': '家人-与其他人一起-被动回应',
                'family_group_active': '家人-群体活动-主动发言',
                'family_group_passive': '家人-群体活动-被动回应',
                'frequent_contacts_alone_active': '熟人-独处-主动发言',
                'frequent_contacts_alone_passive': '熟人-独处-被动回应',
                'frequent_contacts_with_others_active': '熟人-与其他人一起-主动发言',
                'frequent_contacts_with_others_passive': '熟人-与其他人一起-被动回应',
                'frequent_contacts_group_active': '熟人-群体活动-主动发言',
                'frequent_contacts_group_passive': '熟人-群体活动-被动回应',
                'strangers_alone_active': '陌生人-独处-主动发言',
                'strangers_alone_passive': '陌生人-独处-被动回应',
                'strangers_with_others_active': '陌生人-与其他人一起-主动发言',
                'strangers_with_others_passive': '陌生人-与其他人一起-被动回应',
                'strangers_group_active': '陌生人-群体活动-主动发言',
                'strangers_group_passive': '陌生人-群体活动-被动回应'
            };
            
            const valueNames = {
                'normal': '正常音量',
                'quiet': '小声说话',
                'whisper': '悄声/耳语'
            };
            
            // 按类别分组显示
            const categories = {
                '家人': [],
                '熟人': [],
                '陌生人': []
            };
            
            // 将问题按类别分组
            questions.forEach(q => {
                const questionText = questionMap[q.question] || q.question;
                const selectedText = q.selected_texts && q.selected_texts.length > 0 ? q.selected_texts[0] : (q.selected && q.selected.length > 0 ? valueNames[q.selected[0]] || q.selected[0] : '未选择');
                
                if (questionText.includes('家人')) {
                    categories['家人'].push({ question: questionText, answer: selectedText });
                } else if (questionText.includes('熟人')) {
                    categories['熟人'].push({ question: questionText, answer: selectedText });
                } else if (questionText.includes('陌生人')) {
                    categories['陌生人'].push({ question: questionText, answer: selectedText });
                }
            });
            
            // 生成HTML
            for (const [category, items] of Object.entries(categories)) {
                if (items.length > 0) {
                    html += `<h4 style="color: #64748b; margin: 15px 0 10px 0;">${category}</h4>`;
                    items.forEach(item => {
                        const parts = item.question.split('-');
                        const situation = parts.length > 1 ? parts[1] : '';
                        const responseType = parts.length > 2 ? parts[2] : '';
                        
                        html += `<div style="margin-left: 20px; margin-bottom: 8px;">
                            <span style="display: inline-block; min-width: 120px; font-weight: 500;">${situation}-${responseType}:</span>
                            <span style="display: inline-block; margin-left: 10px; padding: 2px 8px; background: #e0f2fe; border-radius: 4px; font-size: 14px;">
                                ${item.answer}
                            </span>
                        </div>`;
                    });
                }
            }
            
            return html || '<p>暂无有效答案数据</p>';
        }

        // 生成暴露层次
        function generateExposureHierarchy(reportData) {
            const hierarchy = [
                { level: 1, activity: '在家中与亲密家人交谈', difficulty: '最容易' },
                { level: 2, activity: '在熟悉环境中与朋友交谈', difficulty: '容易' },
                { level: 3, activity: '在小组中发言', difficulty: '中等' },
                { level: 4, activity: '在课堂上回答问题', difficulty: '困难' },
                { level: 5, activity: '在陌生人面前讲话', difficulty: '最困难' }
            ];

            return hierarchy;
        }

        // 渲染说话习惯记录编辑表格
        function renderSpeechHabitEditTable(questionnaire) {
            const data = questionnaire.data || {};
            const questions = data.questions || [];
            
            // 创建问题映射
            const questionMap = {};
            questions.forEach(q => {
                questionMap[q.question] = q;
            });
            
            let html = `
            <div class="question-group">
                <div class="question-title">说话习惯记录编辑</div>
                <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">点击选项进行修改，已选择的选项会高亮显示</p>
                
                <style>
                .speech-edit-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    background: white;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                .speech-edit-table th,
                .speech-edit-table td {
                    padding: 12px;
                    text-align: center;
                    border: 1px solid #e0e0e0;
                }
                
                .speech-edit-table th {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    font-weight: 600;
                    font-size: 14px;
                }
                
                .speech-edit-table .row-header {
                    background: #f8f9fa;
                    font-weight: 600;
                    color: #495057;
                    text-align: left;
                    padding-left: 16px;
                }
                
                .option-group {
                    display: flex;
                    justify-content: center;
                    gap: 8px;
                    flex-wrap: wrap;
                }
                
                .speech-option {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 32px;
                    height: 32px;
                    border: 2px solid #ddd;
                    border-radius: 50%;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    background: white;
                    font-size: 16px;
                    font-weight: bold;
                }
                
                .speech-option:hover {
                    border-color: #007bff;
                    transform: scale(1.1);
                }
                
                .speech-option.selected {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-color: #667eea;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                }
                
                .legend {
                    display: flex;
                    justify-content: center;
                    gap: 20px;
                    margin: 15px 0;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 6px;
                }
                
                .legend-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 14px;
                    color: #495057;
                }
                </style>
                
                <div class="legend">
                    <div class="legend-item">
                        <span style="width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">●</span>
                        <span>正常音量</span>
                    </div>
                    <div class="legend-item">
                        <span style="width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">◐</span>
                        <span>小声说话</span>
                    </div>
                    <div class="legend-item">
                        <span style="width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">○</span>
                        <span>悄声/耳语</span>
                    </div>
                </div>
                
                <table class="speech-edit-table">
                    <thead>
                        <tr>
                            <th rowspan="2">交流对象</th>
                            <th colspan="3">被动回应</th>
                            <th colspan="3">主动发起</th>
                        </tr>
                        <tr>
                            <th>独处时</th>
                            <th>与他人在一起时</th>
                            <th>群体中</th>
                            <th>独处时</th>
                            <th>与他人在一起时</th>
                            <th>群体中</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // 定义行数据
            const rows = [
                { key: 'family', label: '家人' },
                { key: 'acquaintances', label: '熟人' },
                { key: 'strangers', label: '陌生人' }
            ];
            
            const columns = [
                'alone_passive', 'with_others_passive', 'group_passive',
                'alone_active', 'with_others_active', 'group_active'
            ];
            
            rows.forEach(row => {
                html += `<tr><td class="row-header">${row.label}</td>`;
                
                columns.forEach(col => {
                    let selectedValue = '';
                    
                    // 对于熟人行，需要检查朋友和经常联系的人的数据
                    if (row.key === 'acquaintances') {
                        const friendsKey = `friends_${col}`;
                        const frequentKey = `frequent_contacts_${col}`;
                        const friendsQuestion = questionMap[friendsKey];
                        const frequentQuestion = questionMap[frequentKey];
                        
                        // 优先使用朋友的数据，如果没有则使用经常联系的人的数据
                        selectedValue = friendsQuestion?.selected?.[0] || frequentQuestion?.selected?.[0] || '';
                    } else {
                        const questionKey = `${row.key}_${col}`;
                        const question = questionMap[questionKey];
                        selectedValue = question?.selected?.[0] || '';
                    }
                    
                    html += `<td><div class="option-group">`;
                    
                    // 添加三个选项
                    const options = [
                        { value: 'normal', symbol: '●' },
                        { value: 'quiet', symbol: '◐' },
                        { value: 'whisper', symbol: '○' }
                    ];
                    
                    options.forEach(option => {
                        const isSelected = selectedValue === option.value;
                        const questionKey = row.key === 'acquaintances' ? `friends_${col}` : `${row.key}_${col}`;
                        html += `<div class="speech-option ${isSelected ? 'selected' : ''}" 
                                     onclick="selectSpeechOption('${questionKey}', '${option.value}', this)" 
                                     data-question="${questionKey}" 
                                     data-value="${option.value}">
                                    ${option.symbol}
                                </div>`;
                    });
                    
                    html += `</div></td>`;
                });
                
                html += `</tr>`;
            });
            
            html += `
                    </tbody>
                </table>
            </div>`;
            
            return html;
        }
        
        // 选择说话习惯选项
         function selectSpeechOption(questionKey, value, element) {
             // 移除同一组中其他选项的选中状态
             const group = element.parentElement;
             group.querySelectorAll('.speech-option').forEach(opt => {
                 opt.classList.remove('selected');
             });
             
             // 添加当前选项的选中状态
             element.classList.add('selected');
             
             // 更新隐藏的表单数据（如果需要的话）
             console.log(`选择了 ${questionKey}: ${value}`);
         }
         
         // 保存说话习惯记录
         function saveSpeechHabitQuestionnaire() {
             const form = document.getElementById('editForm');
             const formData = new FormData(form);
             
             // 收集基本信息更改
             const updateData = {
                 basic_info: {},
                 questions: []
             };
             
             let hasChanges = false;
             
             // 处理基本信息
             for (let [name, value] of formData.entries()) {
                 if (name.startsWith('basic_info.') && value.trim() !== '') {
                     const field = name.replace('basic_info.', '');
                     updateData.basic_info[field] = value;
                     hasChanges = true;
                 }
             }
             
             // 收集说话习惯选项的更改
             const selectedOptions = document.querySelectorAll('.speech-option.selected');
             const questionUpdates = {};
             
             selectedOptions.forEach(option => {
                 const questionKey = option.getAttribute('data-question');
                 const value = option.getAttribute('data-value');
                 
                 if (questionKey && value) {
                     questionUpdates[questionKey] = value;
                     
                     // 如果是朋友的数据，同时更新经常联系的人的对应数据
                     if (questionKey.startsWith('friends_')) {
                         const frequentKey = questionKey.replace('friends_', 'frequent_contacts_');
                         questionUpdates[frequentKey] = value;
                     }
                     
                     hasChanges = true;
                 }
             });
             
             // 将选项更新转换为questions数组格式
             if (Object.keys(questionUpdates).length > 0) {
                 const originalQuestions = currentQuestionnaire.data?.questions || [];
                 
                 originalQuestions.forEach((q, index) => {
                     const questionKey = q.question;
                     if (questionUpdates.hasOwnProperty(questionKey)) {
                         const newValue = questionUpdates[questionKey];
                         const currentValue = q.selected?.[0];
                         
                         // 只有当值发生变化时才添加到更新数据中
                         if (newValue !== currentValue) {
                             // 确保数组有足够的元素
                             while (updateData.questions.length <= index) {
                                 updateData.questions.push({});
                             }
                             
                             updateData.questions[index] = {
                                 selected: [newValue],
                                 selected_texts: [getOptionText(newValue)]
                             };
                         }
                     }
                 });
             }
             
             // 清理空对象
             if (Object.keys(updateData.basic_info).length === 0) {
                 delete updateData.basic_info;
             }
             
             if (updateData.questions.length === 0) {
                 delete updateData.questions;
             }
             
             if (!hasChanges) {
                 alert('没有检测到任何更改');
                 return;
             }
             
             console.log('说话习惯记录更新数据:', JSON.stringify(updateData, null, 2));
             
             // 发送更新请求
             apiCall(`/api/questionnaires/${currentEditingId}`, {
                 method: 'PUT',
                 headers: {
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify(updateData)
             })
             .then(result => {
                 if (!result) return;
                 
                 if (result.success) {
                     alert('保存成功');
                     closeModal('editModal');
                     loadQuestionnaires();
                 } else {
                     alert('保存失败: ' + (result.error?.message || result.message || '未知错误'));
                 }
             })
             .catch(error => {
                 console.error('保存错误:', error);
                 alert('网络错误，请稍后重试');
             });
         }
         
         // 获取选项文本
         function getOptionText(value) {
             const optionTexts = {
                 'normal': '正常音量',
                 'quiet': '小声说话',
                 'whisper': '悄声/耳语'
             };
             return optionTexts[value] || value;
         }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 加载问卷列表
            loadQuestionnaires();

            // 绑定事件监听器
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
            document.getElementById('refreshBtn').addEventListener('click', () => loadQuestionnaires());
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // 搜索框回车事件
            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // 点击模态框外部关闭
            window.onclick = function (event) {
                const viewModal = document.getElementById('viewModal');
                const editModal = document.getElementById('editModal');
                if (event.target === viewModal) {
                    closeModal('viewModal');
                }
                if (event.target === editModal) {
                    closeModal('editModal');
                }
            };
        });
    </script>
</body>

</html>