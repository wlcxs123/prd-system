# 代理架构说明

## 概述

本项目采用双代理架构，解决静态文件路径问题：
- **本地开发环境**：使用Flask代理所有静态文件
- **生产环境**：使用nginx代理静态文件，Flask处理动态请求

## 架构设计

### 本地开发环境 (Flask代理)

```
浏览器 → Flask(8081端口) → 静态文件/API
```

**特点：**
- 所有请求都通过Flask处理
- 静态文件由Flask的`send_file`函数提供
- 无需nginx，简化开发环境配置
- 支持热重载和调试

**Flask静态文件路由：**
```python
# config.js配置文件
@app.route('/config.js')
@app.route('/FSCM/config.js')

# 本地资源文件
@app.route('/local_assets/<path:filename>')

# 图片资源
@app.route('/image/<path:filename>')

# 通用静态文件
@app.route('/<path:filename>')  # 支持.js,.css,.png等

# favicon
@app.route('/favicon.ico')
```

### 生产环境 (nginx代理)

```
浏览器 → nginx(8081端口) → {
    静态文件 → 直接提供
    API请求 → Flask(5002端口)
    页面路由 → Flask(5002端口)
}
```

**特点：**
- nginx直接提供静态文件，性能更好
- Flask专注处理API和动态页面
- 支持缓存策略和压缩
- 更好的并发处理能力

**nginx配置要点：**
```nginx
# 静态文件直接提供
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    try_files $uri =404;
    expires 1y;
}

# API请求代理到Flask
location /api/ {
    proxy_pass http://127.0.0.1:5002;
}

# 页面路由代理到Flask
location /magic-wire {
    proxy_pass http://127.0.0.1:5002;
}
```

## 环境检测机制

前端自动检测运行环境并选择合适的代理方式：

```javascript
function detectEnvironment() {
    const hostname = window.location.hostname;
    
    // 本地开发环境检测
    const isLocalDev = (
        hostname === 'localhost' || 
        hostname === '127.0.0.1' || 
        hostname.startsWith('192.168.')
    );
    
    return { isLocal: isLocalDev };
}

function getResourceBasePath() {
    const env = detectEnvironment();
    
    if (env.isLocal) {
        // 本地开发：使用Flask代理
        return {
            basePath: `${protocol}//${hostname}:8081/`,
            proxy: 'flask'
        };
    } else {
        // 生产环境：使用nginx代理
        return {
            basePath: `${protocol}//${hostname}:${port}/`,
            proxy: 'nginx'
        };
    }
}
```

## 优势

### 开发环境优势
1. **简化配置**：无需配置nginx，直接运行Flask即可
2. **统一端口**：所有资源都通过8081端口访问
3. **调试友好**：Flask的调试模式支持热重载
4. **路径一致**：避免相对路径和绝对路径混用问题

### 生产环境优势
1. **性能优化**：nginx直接提供静态文件，减少Flask负载
2. **缓存策略**：nginx支持更灵活的缓存配置
3. **并发处理**：nginx处理静态文件并发能力更强
4. **安全性**：nginx提供更好的安全防护

## 部署说明

### 本地开发部署

1. 启动Flask应用：
```bash
cd backend
python app.py
```

2. 访问应用：
```
http://localhost:8081
```

### 生产环境部署

1. 启动Flask应用（后台运行）：
```bash
cd backend
gunicorn -c gunicorn.conf.py wsgi:app
```

2. 配置nginx：
```bash
sudo cp questionnaire-8081.conf /etc/nginx/conf.d/
sudo nginx -t
sudo systemctl reload nginx
```

3. 访问应用：
```
http://115.190.103.114:8081
```

## 故障排除

### 常见问题

1. **静态文件404错误**
   - 检查环境检测是否正确
   - 确认Flask静态文件路由是否正常
   - 验证nginx配置是否正确

2. **跨域问题**
   - 本地开发：Flask已配置CORS
   - 生产环境：nginx代理自动处理

3. **缓存问题**
   - 本地开发：Flask不缓存，便于调试
   - 生产环境：nginx配置适当缓存策略

### 调试命令

```bash
# 检查Flask路由
curl http://localhost:8081/config.js

# 检查nginx配置
sudo nginx -t

# 查看nginx日志
sudo tail -f /var/log/nginx/questionnaire_error.log

# 查看Flask日志
tail -f backend/logs/app.log
```

## 总结

这种双代理架构有效解决了静态文件路径问题：
- 开发环境简单易用，无需复杂配置
- 生产环境性能优化，稳定可靠
- 自动环境检测，无需手动切换
- 统一的资源访问方式，避免路径混乱